
name: "Repo Migration Â· 1.1 Commit Sync"
on:
  workflow_call:
    inputs:
      gl_url:
        required: false
        type: string
        default: 'https://gitlab.com'
      gl_project:
        required: true
        type: string
      gh_owner:
        required: true
        type: string
      gh_repo:
        required: true
        type: string
      auto_create_repo:
        required: false
        type: string
        default: 'true'
      delete_dest_repo_first:
        required: false
        type: string
        default: 'false'
      migrate_mrs:
        required: false
        type: string
        default: 'true'
    secrets:
      GH_PAT:
        required: true
      GITLAB_TOKEN:
        required: true
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  commit_sync:
    runs-on: ubuntu-latest
    outputs:
      gl_url: ${{ steps.export.outputs.gl_url }}
      gl_project: ${{ steps.export.outputs.gl_project }}
      gh_owner: ${{ steps.export.outputs.gh_owner }}
      gh_repo: ${{ steps.export.outputs.gh_repo }}
      auto_create: ${{ steps.export.outputs.auto_create }}
      delete_first: ${{ steps.export.outputs.delete_first }}
      migrate_mrs: ${{ steps.export.outputs.migrate_mrs }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl git

      - name: Resolve configuration
        id: cfg
        run: |
          set -euo pipefail
          GL_URL="${{ inputs.gl_url }}"
          GL_PROJECT="${{ inputs.gl_project }}"
          GH_OWNER="${{ inputs.gh_owner }}"
          GH_REPO="${{ inputs.gh_repo }}"
          AUTO_CREATE="${{ inputs.auto_create_repo }}"
          DELETE_FIRST="${{ inputs.delete_dest_repo_first }}"
          MIGRATE_MRS="${{ inputs.migrate_mrs }}"

          [[ -z "${GL_PROJECT}" ]] && echo "ERROR: GL_PROJECT required" && exit 1
          [[ -z "${GH_OWNER}" || -z "${GH_REPO}" ]] && echo "ERROR: GH_OWNER/GH_REPO required" && exit 1
          [[ -z "${GL_TOKEN:-}" ]] && echo "ERROR: Missing secret GITLAB_TOKEN" && exit 1
          [[ -z "${GH_PAT:-}" ]] && echo "ERROR: Missing secret GH_PAT" && exit 1

          echo "GL_URL=${GL_URL}" >> "$GITHUB_ENV"
          echo "GL_PROJECT=${GL_PROJECT}" >> "$GITHUB_ENV"
          echo "GH_OWNER=${GH_OWNER}" >> "$GITHUB_ENV"
          echo "GH_REPO=${GH_REPO}" >> "$GITHUB_ENV"
          echo "AUTO_CREATE=${AUTO_CREATE}" >> "$GITHUB_ENV"
          echo "DELETE_FIRST=${DELETE_FIRST}" >> "$GITHUB_ENV"
          echo "MIGRATE_MRS=${MIGRATE_MRS}" >> "$GITHUB_ENV"
          echo "WORKDIR=/tmp/mirror-work" >> "$GITHUB_ENV"

      - name: Export job outputs
        id: export
        run: |
          {
            echo "gl_url=${GL_URL}"
            echo "gl_project=${GL_PROJECT}"
            echo "gh_owner=${GH_OWNER}"
            echo "gh_repo=${GH_REPO}"
            echo "auto_create=${AUTO_CREATE}"
            echo "delete_first=${DELETE_FIRST}"
            echo "migrate_mrs=${MIGRATE_MRS}"
          } >> "$GITHUB_OUTPUT"

      - name: Optionally delete destination repository (DANGER)
        if: env.DELETE_FIRST == 'true'
        run: |
          set -euo pipefail
          REPO_URL="https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer ${GH_PAT}" -H "Accept: application/vnd.github+json" \
            "${REPO_URL}")
          echo "Delete HTTP status: ${STATUS}"
          if [[ "${STATUS}" != "204" && "${STATUS}" != "404" ]]; then
            echo "ERROR: Delete failed (HTTP ${STATUS})."; exit 1
          fi

      - name: Create GitHub repo if missing
        if: env.AUTO_CREATE == 'true'
        run: |
          set -euo pipefail
          REPO_API="https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" "${REPO_API}")
          if [[ "${STATUS}" == "200" ]]; then
            echo "Repo already exists."
          else
            MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user | jq -r '.login')
            if [[ "${GH_OWNER}" == "${MY_LOGIN}" ]]; then
              CREATE_URL="https://api.github.com/user/repos"
            else
              CREATE_URL="https://api.github.com/orgs/${GH_OWNER}/repos"
            fi
            PAYLOAD=$(jq -n --arg name "${GH_REPO}" '{name:$name, private:true, has_issues:true, has_projects:true, has_wiki:true}')
            RESP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -H "Authorization: Bearer ${GH_PAT}" -H "Content-Type: application/json" -d "${PAYLOAD}" "${CREATE_URL}")
            HTTP=$(echo "${RESP}" | sed -n 's/^HTTP_STATUS://p')
            if [[ "${HTTP}" != "201" ]]; then
              echo "Failed to create repo (HTTP ${HTTP})."; exit 1;
            fi
          fi
          echo "GH repo ready: https://github.com/${GH_OWNER}/${GH_REPO}"
          sleep 1

      - name: Clone GitLab mirror (branches & commits)
        run: |
          set -euo pipefail
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"
          HOST="${GL_URL#*://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${GL_PROJECT}.git"
          echo "Cloning --mirror from ${GL_URL}/${GL_PROJECT}"
          git clone --mirror "${SRC_URL}" src.git
          git -C src.git show-ref | head -n 10 || true

      - name: Push mirror to GitHub (branches & commits)
        run: |
          set -euo pipefail
          cd "${WORKDIR}/src.git"
          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          echo "Pushing --mirror to ${GH_OWNER}/${GH_REPO}..."
          git push --mirror github
