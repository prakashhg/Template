
name: 1) Repo Migration Â· 1.1 Commit Sync
on:
  workflow_call:
    inputs:
      gl_url:       { required: true, type: string }
      gl_project:   { required: true, type: string }
      gh_owner:     { required: true, type: string }
      gh_repo:      { required: true, type: string }
      auto_create:  { required: true, type: boolean }
      delete_first: { required: true, type: boolean }
    secrets:
      GITLAB_TOKEN: { required: true }
      GH_PAT:       { required: true }

jobs:
  commit-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl git git-lfs

      - name: Validate inputs
        run: |
          set -euo pipefail
          [[ -z "${{ inputs.gl_project }}" ]] && { echo "GL_PROJECT required"; exit 1; }
          [[ -z "${{ inputs.gh_owner }}" || -z "${{ inputs.gh_repo }}" ]] && { echo "GH_OWNER/GH_REPO required"; exit 1; }

      - name: Optionally delete destination repository (DANGER)
        if: ${{ inputs.delete_first }}
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail
          REPO_URL="https://api.github.com/repos/${{ inputs.gh_owner }}/${{ inputs.gh_repo }}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer ${GH_PAT}" -H "Accept: application/vnd.github+json" "${REPO_URL}")
          echo "Delete HTTP status: ${STATUS}"
          [[ "${STATUS}" == "204" || "${STATUS}" == "404" ]] || { echo "ERROR: Delete failed (HTTP ${STATUS})."; exit 1; }

      - name: Create GitHub repo if missing
        if: ${{ inputs.auto_create }}
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail
          REPO_API="https://api.github.com/repos/${{ inputs.gh_owner }}/${{ inputs.gh_repo }}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" "${REPO_API}")
          if [[ "${STATUS}" == "200" ]]; then
            echo "Repo exists."
          else
            MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user | jq -r '.login')
            if [[ "${{ inputs.gh_owner }}" == "${MY_LOGIN}" ]]; then
              CREATE_URL="https://api.github.com/user/repos"
            else
              CREATE_URL="https://api.github.com/orgs/${{ inputs.gh_owner }}/repos"
            fi
            PAYLOAD=$(jq -n --arg name "${{ inputs.gh_repo }}" \
              '{name:$name, private:true, has_issues:true, has_projects:true, has_wiki:true}')
            RESP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -H "Authorization: Bearer ${GH_PAT}" \
              -H "Accept: application/vnd.github+json" -H "Content-Type: application/json" \
              -d "${PAYLOAD}" "${CREATE_URL}")
            HTTP=$(echo "${RESP}" | sed -n 's/^HTTP_STATUS://p')
            [[ "${HTTP}" == "201" ]] || { echo "Failed to create repo (HTTP ${HTTP})."; exit 1; }
          fi
          echo "GH repo ready: https://github.com/${{ inputs.gh_owner }}/${{ inputs.gh_repo }}"

      - name: Mirror clone from GitLab and push to GitHub (incl. LFS)
        env:
          GL_TOKEN:   ${{ secrets.GITLAB_TOKEN }}
          GH_PAT:     ${{ secrets.GH_PAT }}
          GL_URL:     ${{ inputs.gl_url }}
          GL_PROJECT: ${{ inputs.gl_project }}
          GH_OWNER:   ${{ inputs.gh_owner }}
          GH_REPO:    ${{ inputs.gh_repo }}
        run: |
          set -euo pipefail
          WORKDIR=/tmp/mirror-work
          mkdir -p "${WORKDIR}"
          HOST="${GL_URL#*://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${GL_PROJECT}.git"

          echo "Cloning --mirror from ${GL_URL}/${GL_PROJECT}"
          git clone --mirror "${SRC_URL}" "${WORKDIR}/src.git"
          git -C "${WORKDIR}/src.git" show-ref | head -n 10 || true

          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"
          git -C "${WORKDIR}/src.git" remote remove github 2>/dev/null || true
          git -C "${WORKDIR}/src.git" remote add github "${PUSH_URL}"
          echo "Pushing --mirror to ${GH_OWNER}/${GH_REPO}..."
          git -C "${WORKDIR}/src.git" push --mirror github

          # LFS handling (optional but recommended if source uses LFS)
          git lfs install
          git -C "${WORKDIR}/src.git" lfs fetch --all
          git -C "${WORKDIR}/src.git" lfs push "${PUSH_URL}" --all
``
