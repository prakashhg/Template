
# File: .github/workflows/identify-gitlab-ci.yml
name: Identify repos that contain .gitlab-ci.yml

on:
  workflow_dispatch:
    inputs:
      only_project:
        description: "Optional: Only check this GitLab project path (must be present in REPO_LIST)."
        required: false
        default: ""

permissions:
  contents: read

env:
  # Configure these in Settings â†’ Variables
  REPO_LIST: ${{ vars.REPO_LIST }}          # newline CSV: gitlab_path,github_owner,github_repo
  GITLAB_API_URL: ${{ vars.GITLAB_API_URL }} # optional; defaults to https://gitlab.com/api/v4 in the script

jobs:
  identify:
    name: Scan migrated repos for .gitlab-ci.yml
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (to access scripts/)
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${REPO_LIST:-}" ] && [ -z "${{ inputs.only_project }}" ]; then
            echo "ERROR: vars.REPO_LIST is empty and only_project not provided."
            exit 1
          fi

      - name: Run GitLab CI detector (Python)
        shell: bash
        env:
          REPO_LIST: ${{ env.REPO_LIST }}
          ONLY_PROJECT: ${{ inputs.only_project }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_API_URL: ${{ env.GITLAB_API_URL }}
        run: |
          set -euo pipefail
          python3 scripts/gitlab_ci_detector.py

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: gitlab-ci-detection-report
          path: reports/gitlab-ci-detection.csv
