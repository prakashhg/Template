
name: Pipeline Converter (GitLab CI ➜ GitHub Actions)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Choose: importer-audit | importer-dry-run | importer-migrate | fallback-convert'
        required: true
        default: 'importer-migrate'
      repos_file:
        description: 'Path to file with GitHub repos (owner/repo per line)'
        required: true
        default: 'repos.txt'
      base_branch:
        description: 'Base branch to target PRs (e.g., main)'
        required: true
        default: 'main'
      gitlab_server_url:
        description: 'GitLab base URL (e.g., https://gitlab.com or https://gitlab.example.com)'
        required: false
        default: 'https://gitlab.com'
      auto_merge:
        description: 'Enable auto-merge on created PRs (true/false)'
        required: true
        default: 'true'

permissions:
  contents: write        # push branches
  pull-requests: write   # create/merge PRs

jobs:
  # 1) Build matrix from repos_file -------------------------------------------
  fanout:
    runs-on: ubuntu-latest
    outputs:
      repos_json: ${{ steps.matrix.outputs.repos_json }}
    steps:
      - uses: actions/checkout@v4

      - id: matrix
        name: Build matrix from repos file
        shell: bash
        run: |
          set -euo pipefail

          FILE="${{ github.event.inputs.repos_file }}"
          if [ ! -f "$FILE" ]; then
            echo "Repos file not found: $FILE" >&2
            exit 1
          fi

          # YAML-safe: no here-doc, no multi-line quotes
          REPOS_JSON="$(python3 -c 'import json,sys; fp=sys.argv[1]; print(json.dumps([l.strip() for l in open(fp,"r",encoding="utf-8") if l.strip()]))' "$FILE")"
          echo "repos_json=${REPOS_JSON}" >> "$GITHUB_OUTPUT"

  # 2A) PATH A: Use GitHub Actions Importer (audit / dry-run / migrate) -------
  importer:
    runs-on: ubuntu-latest
    needs: [fanout]
    if: startsWith(github.event.inputs.mode, 'importer-')
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.fanout.outputs.repos_json) }}
    env:
      # Your secrets
      GH_TOKEN:            ${{ secrets.GH_TOKEN }}
      GITLAB_TOKEN:        ${{ secrets.GITLAB_TOKEN }}

      # Variables expected by Importer & gh
      GITHUB_ACCESS_TOKEN: ${{ secrets.GH_TOKEN }}
      GITLAB_ACCESS_TOKEN: ${{ secrets.GITLAB_TOKEN }}

      # Inputs
      GITLAB_SERVER_URL:   ${{ github.event.inputs.gitlab_server_url }}
      BASE_BRANCH:         ${{ github.event.inputs.base_branch }}
      AUTO_MERGE:          ${{ github.event.inputs.auto_merge }}

    steps:
      - name: Ensure Docker & GitHub CLI available
        shell: bash
        run: |
          set -euo pipefail
          if ! docker --version >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y docker.io
            sudo systemctl start docker || true
          fi
          docker --version
          gh --version || (echo "GitHub CLI not found" >&2; exit 1)

      - name: Install GH Actions Importer extension and update
        shell: bash
        run: |
          set -euo pipefail
          gh extension install github/gh-actions-importer || true
          gh actions-importer update

      - name: Configure Importer credentials (safe write)
        shell: bash
        run: |
          set -euo pipefail
          printf 'GITHUB_ACCESS_TOKEN=%s\nGITLAB_ACCESS_TOKEN=%s\nGITLAB_SERVER_URL=%s\n' \
            "${GITHUB_ACCESS_TOKEN}" "${GITLAB_ACCESS_TOKEN}" "${GITLAB_SERVER_URL}" > .env.local

      - name: Importer — AUDIT
        if: github.event.inputs.mode == 'importer-audit'
        shell: bash
        run: |
          set -euo pipefail
          gh actions-importer audit gitlab \
            --output "audit-${{ matrix.repo }}.json"

      - name: Importer — DRY-RUN
        if: github.event.inputs.mode == 'importer-dry-run'
        shell: bash
        run: |
          set -euo pipefail
          gh actions-importer dry-run gitlab \
            --output-dir "./dryrun-${{ matrix.repo }}" \
            --target-repo "${{ matrix.repo }}"

      - name: Importer — MIGRATE (convert & open PR)
        if: github.event.inputs.mode == 'importer-migrate'
        shell: bash
        run: |
          set -euo pipefail
          gh actions-importer migrate gitlab \
            --target-repo "${{ matrix.repo }}" \
            --base-branch "${BASE_BRANCH}"

      - name: (Optional) Enable auto-merge
        if: github.event.inputs.mode == 'importer-migrate' && env.AUTO_MERGE == 'true'
        shell: bash
        run: |
          set -euo pipefail
          PRN=$(gh pr list --repo "${{ matrix.repo }}" --state open --json number,createdAt --jq 'sort_by(.createdAt) | reverse | .[0].number' || true)
          if [ -n "${PRN:-}" ]; then
            gh pr merge "${PRN}" --auto --squash --delete-branch || true
          fi

  # 2B) PATH B: Fallback — detect .gitlab-ci.yml, convert, and PR -------------
  fallback:
    runs-on: ubuntu-latest
    needs: [fanout]
    if: github.event.inputs.mode == 'fallback-convert'
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.fanout.outputs.repos_json) }}
    env:
      GH_TOKEN:    ${{ secrets.GH_TOKEN }}               # for gh CLI
      BASE_BRANCH: ${{ github.event.inputs.base_branch }}
      AUTO_MERGE:  ${{ github.event.inputs.auto_merge }}

    steps:
      - name: Clone target repo
        shell: bash
        run: |
          set -euo pipefail
          gh repo clone "${{ matrix.repo }}" target -- -q
          cd target
          git config user.name  "ci-migration-bot"
          git config user.email "ci-migration-bot@users.noreply.github.com"

      - name: Detect .gitlab-ci.yml
        id: detect
        working-directory: target
        shell: bash
        run: |
          if [ -f ".gitlab-ci.yml" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Skip if not found
        if: steps.detect.outputs.found != 'true'
        shell: bash
        run: echo "No .gitlab-ci.yml in ${{ matrix.repo }}, skipping."

      - name: Install PyYAML
        if: steps.detect.outputs.found == 'true'
        working-directory: target
        shell: bash
        run: |
          set -euo pipefail
          python3 -m pip install --user PyYAML

      - name: Convert GitLab CI ➜ GitHub Actions (ANSI-C quoting; no here-doc)
        if: steps.detect.outputs.found == 'true'
        working-directory: target
        shell: bash
        run: |
          set -euo pipefail
          python3 -c $'import sys,json\nfrom pathlib import Path\nimport yaml\nroot=Path(".")\nci_path=root/".gitlab-ci.yml"\nif not ci_path.exists():\n  print("No .gitlab-ci.yml",file=sys.stderr); sys.exit(0)\nci=yaml.safe_load(ci_path.read_text(encoding="utf-8")) or {}\nstages=ci.get("stages") or []\nglobals_=ci.get("variables") or {}\ndefaults=ci.get("default") or {}\nglobal_keys={"stages","variables","workflow","default","include","spec"}\njobs=[k for k,v in ci.items() if isinstance(v,dict) and k not in global_keys]\nstage_of={j:ci[j].get("stage",(stages[0] if stages else "build")) for j in jobs}\n\ndef needs_for(job):\n  s=stage_of[job]\n  if not stages or s not in stages: return []\n  idx=stages.index(s); prev=set(stages[:idx])\n  return [jn for jn in jobs if stage_of[jn] in prev]\n\nwf={\"name\":\"CI (converted)\",\"on\":{\"push\":{\"branches\":[\"**\"]},\"pull_request\":{\"branches\":[\"**\"]},\"workflow_dispatch\":{}},\"jobs\":{}}\nfor jn in jobs:\n  j=ci[jn]; job={}; job[\"runs-on\"]=\"ubuntu-latest\"\n  image=j.get(\"image\") or defaults.get(\"image\")\n  if image: job[\"container\"]=image\n  env={}; env.update(globals_); env.update(j.get(\"variables\") or {})\n  if env: job[\"env\"]=env\n  if j.get(\"allow_failure\"): job[\"continue-on-error\"]=True\n  n=needs_for(jn)\n  if n: job[\"needs\"]=n\n  services=j.get(\"services\")\n  if services and isinstance(services,list):\n    svc={}\n    for s in services:\n      if isinstance(s,str):\n        label=s.split(\"/\")[-1].split(\":\")[0].replace(\"-\",\"_\")\n        svc[label]={\"image\": s}\n    job[\"services\"]=svc\n  steps=[{\"uses\":\"actions/checkout@v4\"}]\n  for c in j.get(\"before_script\",[]): steps.append({\"name\":\"before\",\"run\":c})\n  for c in j.get(\"script\",[]):        steps.append({\"name\":\"run\",\"run\":c})\n  for c in j.get(\"after_script\",[]):  steps.append({\"name\":\"after\",\"run\":c})\n  cache=j.get(\"cache\")\n  if cache and isinstance(cache,dict) and cache.get(\"paths\"):\n    steps.insert(1,{\"name\":\"Cache\",\"uses\":\"actions/cache@v4\",\"with\":{\"path\":\"\\n\".join(cache[\"paths\"]),\"key\":\"${{ runner.os }}-cache-${{ hashFiles(\'**/*\') }}\",\"restore-keys\":\"${{ runner.os }}-cache-\"}})\n  arts=j.get(\"artifacts\")\n  if isinstance(arts,dict) and arts.get(\"paths\"):\n    steps.append({\"name\":\"Upload artifacts\",\"uses\":\"actions/upload-artifact@v4\",\"with\":{\"name\":f\"{jn}-artifacts\",\"path\":\"\\n\".join(arts[\"paths\"])}})\n  job[\"steps\"]=steps\n  wf[\"jobs\"][jn]=job\nout_dir=root/\".github\"/\"workflows\"; out_dir.mkdir(parents=True,exist_ok=True)\nout_path=out_dir/\"ci-converted.yml\"\nyaml.safe_dump(wf,out_path.open(\"w\",encoding=\"utf-8\"),sort_keys=False)\nprint(f\"Wrote {out_path}\")'

      - name: Create migration branch, commit & push
        if: steps.detect.outputs.found == 'true'
        id: branch
        working-directory: target
        shell: bash
        run: |
          set -euo pipefail
          BR="ci-migration/$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BR"
          git add .github/workflows
          if git diff --cached --quiet; then
            echo "No changes to commit; skipping."
            echo "branch=" >> "$GITHUB_OUTPUT"; exit 0
          fi
          git commit -m "Migrate GitLab CI ➜ GitHub Actions (auto-generated)"
          git push -u origin "$BR"
          echo "branch=$BR" >> "$GITHUB_OUTPUT"

      - name: Open PR
        if: steps.detect.outputs.found == 'true' && steps.branch.outputs.branch != ''
        id: pr
        working-directory: target
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh pr create --base "${{ env.BASE_BRANCH }}" --head "${{ steps.branch.outputs.branch }}" \
            --title "Migrate GitLab CI ➜ GitHub Actions" \
            --body "Automated conversion of .gitlab-ci.yml to GitHub Actions workflows"

      - name: (Optional) Enable auto-merge
        if: steps.detect.outputs.found == 'true' && steps.branch.outputs.branch != '' && env.AUTO_MERGE == 'true'
        working-directory: target
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}
        shell        shell: bash
        run: |
          set -euo pipefail
          PRN=$(gh pr list --state open --json number,createdAt --jq 'sort_by(.createdAt) | reverse | .[0].number' || true)
          if [ -n "${PRN:-}" ]; then
            gh pr merge "${PRN}" --auto --squash --delete-branch || true
