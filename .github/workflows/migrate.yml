
name: GitLab → GitHub Migration

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read  # we push using PATs; built-in GITHUB_TOKEN remains read-only

jobs:
  validate:
    name: Validate tokens and source access
    runs-on: ubuntu-latest
    env:
      GITLAB_URL: https://gitlab.com
      GITLAB_PROJECT: prakashguruswamy24-group/my_project
    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          git --version
          jq --version || true

      - name: Check GitLab project access
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail
          PROJ_ENC=$(python3 - <<'PY'
import urllib.parse, os
print(urllib.parse.quote(os.environ["GITLAB_PROJECT"], safe=""))
PY
          )
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "${GITLAB_URL}/api/v4/projects/${PROJ_ENC}")
          echo "GitLab project check HTTP ${STATUS}"
          if [ "${STATUS}" != "200" ]; then
            echo "❌ GitLab token or project invalid. Ensure GITLAB_TOKEN has read_api/read_repository and project path is correct."
            exit 1
          fi

      - name: Check GitHub PAT
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_PAT}" \
            "https://api.github.com/user")
          echo "GitHub /user check HTTP ${STATUS}"
          if [ "${STATUS}" != "200" ]; then
            echo "❌ GitHub PAT invalid or missing scopes (need repo/public_repo)."
            exit 1
          fi

  migrate:
    name: Mirror branches & tags
    runs-on: ubuntu-latest
    needs: validate
    env:
      # Source
      GITLAB_URL: https://gitlab.com
      GITLAB_PROJECT: prakashguruswamy24-group/my_project
      # Destination
      GITHUB_OWNER: prakashhg
      GITHUB_REPO: my_project
      # Options
      CREATE_GITHUB_REPO: "true"  # set "false" if destination exists already
      VISIBILITY: private          # private or public
    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          git --version

      - name: Determine GitLab default branch
        id: default_branch
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail
          PROJ_ENC=$(python3 - <<'PY'
import urllib.parse, os
print(urllib.parse.quote(os.environ["GITLAB_PROJECT"], safe=""))
PY
          )
          DEFAULT=$(curl -s --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "${GITLAB_URL}/api/v4/projects/${PROJ_ENC}" \
            | jq -r '.default_branch // "main"')
          echo "Default branch on GitLab: ${DEFAULT}"
          echo "default=${DEFAULT}" >> "$GITHUB_OUTPUT"

      - name: Clone from GitLab (mirror)
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail
          WORKDIR=/tmp/repo-migration
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"
          GITLAB_HOST="${GITLAB_URL#https://}"
          SRC_URL="https://oauth2:${GITLAB_TOKEN}@${GITLAB_HOST}/${GITLAB_PROJECT}.git"
          echo "Cloning mirror from: ${SRC_URL}"
          git clone --mirror "${SRC_URL}" src.git
          echo "Refs in mirror:"
          git -C src.git show-ref | head -n 10 || true

      - name: Create GitHub repo if requested
        if: env.CREATE_GITHUB_REPO == 'true'
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          OWNER="${GITHUB_OWNER}"
          REPO="${GITHUB_REPO}"
          REPO_API="https://api.github.com/repos/${OWNER}/${REPO}"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_PAT}" \
            "${REPO_API}")
          if [ "${STATUS}" = "200" ]; then
            echo "Repo already exists on GitHub."
            exit 0
          fi

          MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GITHUB_PAT}" https://api.github.com/user | jq -r '.login')
          if [ "${OWNER}" = "${MY_LOGIN}" ]; then
            CREATE_URL="https://api.github.com/user/repos"
          else
            CREATE_URL="https://api.github.com/orgs/${OWNER}/repos"
          fi

          PRIVATE=true
          if [ "${VISIBILITY}" = "public" ]; then PRIVATE=false; fi

          PAYLOAD=$(jq -n --arg name "${REPO}" --argjson private ${PRIVATE} \
            '{name: $name, private: $private, has_issues: true, has_projects: true, has_wiki: true}')

          CREATE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_PAT}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}" \
            "${CREATE_URL}")
          if [ "${CREATE_STATUS}" != "201" ]; then
            echo "❌ Failed to create GitHub repo (HTTP ${CREATE_STATUS})."
            exit 1
          fi
          echo "✅ GitHub repository created."

      - name: Push mirror to GitHub
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          cd /tmp/repo-migration/src.git
          PUSH_URL="https://x-access-token:${GITHUB_PAT}@github.com/${GITHUB_OWNER}/${GITHUB_REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          echo "Pushing --mirror to GitHub…"
          git push --mirror github
          echo "✅ Mirror push complete."

      - name: Set GitHub default branch
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          DEFAULT="${{ steps.default_branch.outputs.default }}"
          REPO_API="https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}"
          echo "Setting default branch to '${DEFAULT}'…"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X PATCH \
            -H "Authorization: Bearer ${GITHUB_PAT}" \
            -H "Content-Type: application/json" \
            -d "$(jq -n --arg db "${DEFAULT}" '{default_branch: $db}')" \
            "${REPO_API}")
          if [ "${STATUS}" != "200" ]; then
            echo "⚠️ Could not set default branch (HTTP ${STATUS})."
          else
                       echo "✅ Default branch set to '${DEFAULT}'."
