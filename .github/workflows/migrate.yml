
name: Diagnose GitLab → GitHub mirroring

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  diag:
    runs-on: ubuntu-latest
    # If you stored GITLAB_TOKEN under an environment (e.g., dev), declare it here:
    environment: dev

    steps:
      - name: Show runner & git
        run: |
          set -euo pipefail
          uname -a
          git --version

      - name: Check secrets presence
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail
          echo "Has GITLAB_TOKEN? ${GITLAB_TOKEN:+YES}"; [ -n "${GITLAB_TOKEN:-}" ] || (echo "Missing GITLAB_TOKEN" && exit 1)
          echo "Has GITHUB_TOKEN? ${GITHUB_TOKEN:+YES}"; [ -n "${GITHUB_TOKEN:-}" ] || (echo "Missing GITHUB_TOKEN" && exit 1)
          echo "Has GH_PAT? ${GH_PAT:+YES or will skip create}"; exit 0

      - name: Validate GitHub API (list user, check/create repo)
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail
          OWNER="prakashhg"     # <--- change if needed
          REPO="my_project"     # <--- change if needed
          if [ -n "${GH_PAT:-}" ]; then
            echo "Checking user with GH_PAT…"
            USTATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user)
            echo "GitHub /user HTTP: ${USTATUS}"
            REPO_API="https://api.github.com/repos/${OWNER}/${REPO}"
            RSTATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" "${REPO_API}")
            echo "GitHub repo existence HTTP: ${RSTATUS}"
          else
            echo "GH_PAT not set; skipping repo creation diagnostics."
          fi

      - name: Validate GitLab API (project access)
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail
          GL_PROJECT_PATH="prakashguruswamy24-group/my_project"   # <--- check exact path
          # URL-encode project path for API
          ENCODED=$(python3 - <<'PY'
import urllib.parse, os
p = os.environ.get("GL_PROJECT_PATH","")
print(urllib.parse.quote(p, safe=''))
PY
)
          API="https://gitlab.com/api/v4/projects/${ENCODED}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "PRIVATE-TOKEN: ${GITLAB_TOKEN}" "${API}")
          echo "GitLab project API HTTP: ${STATUS}"
          if [ "${STATUS}" != "200" ]; then
            echo "GitLab API access failed (HTTP ${STATUS}). Check token scope and project path."
            exit 1
          fi

      - name: Clone mirror from GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail
          GITLAB_URL="https://gitlab.com"
          GITLAB_PROJECT="prakashguruswamy24-group/my_project"   # <--- check exact path
          WORKDIR="/tmp/mirror-work"
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"
          HOST="${GITLAB_URL#https://}"
          SRC_URL="https://oauth2:${GITLAB_TOKEN}@${HOST}/${GITLAB_PROJECT}.git"
          echo "Cloning --mirror from ${GITLAB_URL}/${GITLAB_PROJECT}.git"
          set -x
          git clone --mirror "${SRC_URL}" src.git
          set +x
          echo "Top refs:"
          git -C src.git show-ref | head -n 10 || true

      - name: Push to GitHub
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          OWNER="prakashhg"      # <--- change if needed
          REPO="my_project"      # <--- change if needed
          cd /tmp/mirror-work/src.git
          PUSH_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${OWNER}/${REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          set -x
          git push --mirror github
          set +x
         
