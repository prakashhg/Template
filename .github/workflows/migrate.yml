
name: Mirroring (GitLab → GitHub) + Trackers migration

on:
  push:
  delete:
  workflow_dispatch:
    inputs:
      gl_url:
        description: "GitLab base URL (e.g., https://gitlab.com)"
        required: false
        type: string
      gl_project:
        description: "GitLab project path (e.g., group/subgroup/repo)"
        required: false
        type: string
      gh_owner:
        description: "GitHub user/org owner (e.g., prakashhg)"
        required: false
        type: string
      gh_repo:
        description: "GitHub repository name (e.g., my_project)"
        required: false
        type: string
      auto_create_repo:
        description: "Create destination repo if missing? (true/false)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      delete_dest_repo_first:
        description: "Delete destination repo before mirroring? (true/false)"
        required: false
        default: "false"
        type: choice
        options: ["true", "false"]
      migrate_issues:
        description: "Migrate Issues + Issue Comments (true/false)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      migrate_mrs:
        description: "Migrate Merge Requests → Pull Requests (true/false)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # ----- job 1: code mirror (unchanged from your working version, shortened here) -----
  to_github:
    runs-on: ubuntu-latest
    env:
      GL_TOKEN:  ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:    ${{ secrets.GH_PAT }}

      VAR_GL_URL:          ${{ vars.GL_URL }}
      VAR_GL_PROJECT:      ${{ vars.GL_PROJECT }}
      VAR_GH_OWNER:        ${{ vars.GH_OWNER }}
      VAR_GH_REPO:         ${{ vars.GH_REPO }}
      VAR_AUTO_CREATE:     ${{ vars.AUTO_CREATE_REPO }}
      VAR_DELETE_FIRST:    ${{ vars.DELETE_DEST_REPO_FIRST }}
      VAR_MIGRATE_ISSUES:  ${{ vars.MIGRATE_ISSUES }}
      VAR_MIGRATE_MRS:     ${{ vars.MIGRATE_MRS }}

      IN_GL_URL:           ${{ inputs.gl_url }}
      IN_GL_PROJECT:       ${{ inputs.gl_project }}
      IN_GH_OWNER:         ${{ inputs.gh_owner }}
      IN_GH_REPO:          ${{ inputs.gh_repo }}
      IN_AUTO_CREATE:      ${{ inputs.auto_create_repo }}
      IN_DELETE_FIRST:     ${{ inputs.delete_dest_repo_first }}
      IN_MIGRATE_ISSUES:   ${{ inputs.migrate_issues }}
      IN_MIGRATE_MRS:      ${{ inputs.migrate_mrs }}

    steps:
      - name: Resolve configuration
        shell: bash
        run: |
          set -euo pipefail
          set -x
          GL_URL="${IN_GL_URL:-${VAR_GL_URL:-https://gitlab.com}}"
          GL_PROJECT="${IN_GL_PROJECT:-${VAR_GL_PROJECT:-}}"
          GH_OWNER="${IN_GH_OWNER:-${VAR_GH_OWNER:-}}"
          GH_REPO="${IN_GH_REPO:-${VAR_GH_REPO:-}}"
          AUTO_CREATE="${IN_AUTO_CREATE:-${VAR_AUTO_CREATE:-true}}"
          DELETE_FIRST="${IN_DELETE_FIRST:-${VAR_DELETE_FIRST:-false}}"
          MIGRATE_ISSUES="${IN_MIGRATE_ISSUES:-${VAR_MIGRATE_ISSUES:-true}}"
          MIGRATE_MRS="${IN_MIGRATE_MRS:-${VAR_MIGRATE_MRS:-true}}"

          [[ -z "${GL_PROJECT}" ]] && echo "ERROR: GL_PROJECT required" && exit 1
          [[ -z "${GH_OWNER}" || -z "${GH_REPO}" ]] && echo "ERROR: GH_OWNER/GH_REPO required" && exit 1
          [[ -z "${GL_TOKEN:-}" ]] && echo "ERROR: Missing GITLAB_TOKEN" && exit 1
          [[ -z "${GH_PAT:-}" ]] && echo "ERROR: Missing GH_PAT" && exit 1

          echo 'GL_URL<<__EOF__'       >> "$GITHUB_ENV"; echo "${GL_URL}"       >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          echo 'GL_PROJECT<<__EOF__'   >> "$GITHUB_ENV"; echo "${GL_PROJECT}"   >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          echo 'GH_OWNER<<__EOF__'     >> "$GITHUB_ENV"; echo "${GH_OWNER}"     >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          echo 'GH_REPO<<__EOF__'      >> "$GITHUB_ENV"; echo "${GH_REPO}"      >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          echo 'AUTO_CREATE<<__EOF__'  >> "$GITHUB_ENV"; echo "${AUTO_CREATE}"  >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          echo 'DELETE_FIRST<<__EOF__' >> "$GITHUB_ENV"; echo "${DELETE_FIRST}" >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          echo 'MIGRATE_ISSUES<<__EOF__' >> "$GITHUB_ENV"; echo "${MIGRATE_ISSUES}" >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          echo 'MIGRATE_MRS<<__EOF__'    >> "$GITHUB_ENV"; echo "${MIGRATE_MRS}"    >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          echo 'WORKDIR<<__EOF__'      >> "$GITHUB_ENV"; echo "/tmp/mirror-work" >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"

      # (delete/create repo, clone, push mirror steps here – same as your working version)

  # ----- job 2: trackers migration -----
  trackers_migration:
    needs: to_github
    runs-on: ubuntu-latest
    if: ${{ always() }}  # run even if job1 updated refs; you can gate further with MIGRATE_* flags inside
    env:
      GL_TOKEN:  ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:    ${{ secrets.GH_PAT }}

      GL_URL:     ${{ needs.to_github.outputs.GL_URL || env.GL_URL }}
      GL_PROJECT: ${{ needs.to_github.outputs.GL_PROJECT || env.GL_PROJECT }}
      GH_OWNER:   ${{ needs.to_github.outputs.GH_OWNER || env.GH_OWNER }}
      GH_REPO:    ${{ needs.to_github.outputs.GH_REPO || env.GH_REPO }}

      MIGRATE_ISSUES: ${{ env.MIGRATE_ISSUES }}
      MIGRATE_MRS:    ${{ env.MIGRATE_MRS }}

      # Optional: path in repo for user mapping JSON (GL username -> GH username)
      USER_MAP_PATH: ${{ vars.USER_MAP_PATH }}

    steps:
      - name: Install jq & curl
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Prepare helpers
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          set -x
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC="${GL_PROJECT//\//%2F}"   # URL-encode slashes
          echo "GL_API=${GL_API}" >> "$GITHUB_ENV"
          echo "GL_ENC=${GL_ENC}" >> "$GITHUB_ENV"

          # Load optional user map
          if [[ -n "${USER_MAP_PATH:-}" && -f "${USER_MAP_PATH}" ]]; then
            echo "USER_MAP_JSON<<__EOF__" >> "$GITHUB_ENV"
            cat "${USER_MAP_PATH}"        >> "$GITHUB_ENV"
            echo "__EOF__"                >> "$GITHUB_ENV"
          else
            echo 'USER_MAP_JSON<<__EOF__' >> "$GITHUB_ENV"; echo '{}' >> "$GITHUB_ENV"; echo '__EOF__' >> "$GITHUB_ENV"
          fi

      # ---------- Labels ----------
      - name: Migrate labels (GitLab → GitHub)
        shell: bash
        run: |
          set -euo pipefail
          set -x
          # List GitLab project labels (paged)
          page=1
          while :; do
            # fetch page and capture headers for pagination
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "${HDR}" \
              -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/labels?per_page=100&page=${page}" > "${RESP}"

            # Create/ensure labels on GitHub
            jq -c '.[]' "${RESP}" | while read -r lbl; do
              name=$(jq -r '.name' <<< "$lbl")
              color=$(jq -r '.color' <<< "$lbl" | sed 's/^#//')
              description=$(jq -r '.description // empty' <<< "$lbl")

              # Create label (idempotent: if exists, update)
              # GitHub: POST /repos/{owner}/{repo}/labels or PATCH label
              # (Labels endpoints are under REST Issues API.)
              # Try create; if 422 (exists), PATCH.
              CREATE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -H "Authorization: Bearer ${GH_PAT}" \
                -H "Accept: application/vnd.github+json" \
                -d "$(jq -n --arg name "$name" --arg color "$color" --arg desc "$description" \
                       '{name:$name, color:$color, description:$desc}')" \
                "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/labels")
              ST=$(echo "$CREATE" | sed -n 's/^HTTP_STATUS://p')
              if [[ "$ST" != "201" ]]; then
                # update existing
                curl -s -o /dev/null -w "%{http_code}" \
                  -X PATCH \
                  -H "Authorization: Bearer ${GH_PAT}" \
                  -H "Accept: application/vnd.github+json" \
                  -d "$(jq -n --arg new "$name" --arg color "$color" --arg desc "$description" \
                         '{new_name:$new, color:$color, description:$desc}')" \
                  "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/labels/${name}" > /tmp/label_status
                echo "label ${name} status: $(cat /tmp/label_status)"
              fi

              sleep 1  # avoid secondary rate limits on mutative calls
            done

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')
            [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done
        # Docs: GitLab Labels API (list labels); GitHub Labels endpoints live under Issues REST. (See references below.)

      # ---------- Milestones ----------
      - name: Migrate milestones (GitLab → GitHub)
        shell: bash
        run: |
          set -euo pipefail
          set -x
          page=1
          while :; do
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "${HDR}" \
              -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/milestones?per_page=100&page=${page}" > "${RESP}"

            jq -c '.[]' "${RESP}" | while read -r ms; do
              title=$(jq -r '.title' <<< "$ms")
              description=$(jq -r '.description // empty' <<< "$ms")
              due=$(jq -r '.due_date // empty' <<< "$ms")

              # Create milestone in GitHub
              CREATE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -H "Authorization: Bearer ${GH_PAT}" \
                -H "Accept: application/vnd.github+json" \
                -d "$(jq -n --arg title "$title" --arg desc "$description" --arg due "$due" \
                       '{title:$title, description:$desc} + ( ($due|length>0) ? {due_on:$due} : {} )')" \
                "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/milestones")
              ST=$(echo "$CREATE" | sed -n 's/^HTTP_STATUS://p')
              if [[ "$ST" != "201" ]]; then
                echo "Milestone create status: ${ST} (may already exist)"
              fi
              sleep 1
            done

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')
            [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done
        # Docs: GitLab Milestones API; GitHub Milestones endpoints are part of Issues REST.

      # ---------- Issues + comments ----------
      - name: Migrate issues and issue comments
        if: env.MIGRATE_ISSUES == 'true'
        shell: bash
        run: |
          set -euo pipefail
          set -x

          # helper: map GL username → GH username if defined
          map_user() {
            local gl="$1"
            local gh
            gh=$(jq -r --arg k "$gl" '.[$k] // empty' <<< "${USER_MAP_JSON}")
            [[ -n "$gh" ]] && echo "$gh" || echo ""
          }

          page=1
          while :; do
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "${HDR}" \
              -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/issues?scope=all&per_page=100&page=${page}" > "${RESP}"

            jq -c '.[]' "${RESP}" | while read -r is; do
              title=$(jq -r '.title' <<< "$is")
              body=$(jq -r '.description // ""' <<< "$is")
              state=$(jq -r '.state' <<< "$is")  # opened|closed
              labels=$(jq -c '.labels' <<< "$is")
              ml_title=$(jq -r '.milestone.title // empty' <<< "$is")
              author=$(jq -r '.author.username' <<< "$is")

              # Create issue in GitHub
              create_payload=$(jq -n \
                --arg title "$title" \
                --arg body "**Imported from GitLab by @$author**\n\n$body" \
                --argjson labels "$labels" \
                '{title:$title, body:$body, labels:$labels}')

              CREATE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -H "Authorization: Bearer ${GH_PAT}" \
                -H "Accept: application/vnd.github+json" \
                -d "${create_payload}" \
                "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues")

              http=$(echo "$CREATE" | sed -n 's/^HTTP_STATUS://p')
              gh_issue_number=$(echo "$CREATE" | sed '/^HTTP_STATUS:/d' | jq -r '.number // empty')
              echo "Issue create status=${http} number=${gh_issue_number}"

              # Attach milestone if present (lookup by title)
              if [[ -n "${ml_title}" && -n "${gh_issue_number}" ]]; then
                mid=$(curl -s \
                  -H "Authorization: Bearer ${GH_PAT}" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/milestones" | jq -r \
                  --arg t "$ml_title" '.[] | select(.title==$t) | .number' | head -n1)
                if [[ -n "$mid" ]]; then
                  curl -s -o /dev/null -w "%{http_code}" \
                    -X PATCH \
                    -H "Authorization: Bearer ${GH_PAT}" \
                    -H "Accept: application/vnd.github+json" \
                    -d "$(jq -n --argjson m "$mid" '{milestone:$m}')" \
                    "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${gh_issue_number}"
                  sleep 1
                fi
              fi

              # Close issue if state=closed
              if [[ "${state}" == "closed" && -n "${gh_issue_number}" ]]; then
                curl -s -o /dev/null -w "%{http_code}" \
                  -X PATCH \
                  -H "Authorization: Bearer ${GH_PAT}" \
                  -H "Accept: application/vnd.github+json" \
                  -d '{"state":"closed"}' \
                  "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${gh_issue_number}"
                sleep 1
              fi

              # Comments: list GL notes (only user comments, not system noise)
              # GET /projects/:id/issues/:iid/notes
              gl_iid=$(jq -r '.iid' <<< "$is")
              cpage=1
              while :; do
                CRESP=$(mktemp) ; CHDR=$(mktemp)
                curl -s -D "${CHDR}" \
                  -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                  "${GL_API}/projects/${GL_ENC}/issues/${gl_iid}/notes?activity_filter=only_comments&per_page=100&page=${cpage}" > "${CRESP}"

                jq -c '.[]' "${CRESP}" | while read -r note; do
                  nbody=$(jq -r '.body' <<< "$note")
                  nauth=$(jq -r '.author.username' <<< "$note")
                  # Post to GitHub issue comments
                  curl -s -o /dev/null -w "%{http_code}" \
                    -H "Authorization: Bearer ${GH_PAT}" \
                    -H "Accept: application/vnd.github+json" \
                    -d "$(jq -n --arg b "**@${nauth} (from GitLab)**\n\n${nbody}" '{body:$b}')" \
                    "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${gh_issue_number}/comments"
                  sleep 1
                done

                nnext=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${CHDR}" | tr -d '\r')
                [[ -z "${nnext}" || "${nnext}" == "0" ]] && break
                cpage="${nnext}"
              done

              sleep 1
            done

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')
            [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done
        # Docs: GitLab Issues & Notes endpoints; GitHub Issues + Comments REST endpoints. (See references below.)

      # ---------- Merge Requests → Pull Requests + comments ----------
      - name: Migrate merge requests → pull requests (with timeline comments)
        if: env.MIGRATE_MRS == 'true'
        shell: bash
        run: |
          set -euo pipefail
          set -x

          page=1
          while :; do
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "${HDR}" \
              -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/merge_requests?scope=all&per_page=100&page=${page}" > "${RESP}"

            jq -c '.[]' "${RESP}" | while read -r mr; do
              title=$(jq -r '.title' <<< "$mr")
              body=$(jq -r '.description // ""' <<< "$mr")
              state=$(jq -r '.state' <<< "$mr")    # opened|closed|merged
              labels=$(jq -c '.labels' <<< "$mr")
              source_branch=$(jq -r '.source_branch' <<< "$mr")
              target_branch=$(jq -r '.target_branch' <<< "$mr")
              author=$(jq -r '.author.username' <<< "$mr")

              # Create PR in GitHub (requires branches already pushed by mirror)
              CREATE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -H "Authorization: Bearer ${GH_PAT}" \
                -H "Accept: application/vnd.github+json" \
                -d "$(jq -n \
                      --arg title "$title" \
                      --arg body "**Imported from GitLab by @$author**\n\n$body" \
                      --arg head "$source_branch" \
                      --arg base "$target_branch" \
                      '{title:$title, body:$body, head:$head, base:$base}')" \
                "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/pulls")
              http=$(echo "$CREATE" | sed -n 's/^HTTP_STATUS://p')
              pr_num=$(echo "$CREATE" | sed '/^HTTP_STATUS:/d' | jq -r '.number // empty')
              echo "PR create status=${http} number=${pr_num}"

              # Add labels (PR is an issue; use Issues labels)
              if [[ -n "${pr_num}" ]]; then
                curl -s -o /dev/null -w "%{http_code}" \
                  -H "Authorization: Bearer ${GH_PAT}" \
                  -H "Accept: application/vnd.github+json" \
                  -d "${labels}" \
                  "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${pr_num}/labels"
                sleep 1
              fi

              # Close or merge PR based on MR state
              if [[ -n "${pr_num}" ]]; then
                if [[ "${state}" == "closed" ]]; then
                  curl -s -o /dev/null -w "%{http_code}" \
                    -X PATCH \
                    -H "Authorization: Bearer ${GH_PAT}" \
                    -H "Accept: application/vnd.github+json" \
                    -d '{"state":"closed"}' \
                    "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${pr_num}"
                  sleep 1
                elif [[ "${state}" == "merged" ]]; then
                  # Attempt to mark as merged (requires mergeable state)
                  curl -s -o /dev/null -w "%{http_code}" \
                    -X PUT \
                    -H "Authorization: Bearer ${GH_PAT}" \
                    -H "Accept: application/vnd.github+json" \
                    -d '{"merge_method":"merge"}' \
                    "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/pulls/${pr_num}/merge"
                  sleep 1
                fi
              fi

              # Comments: basic migration of MR notes → PR timeline comments
              gl_iid=$(jq -r '.iid' <<< "$mr")
              cpage=1
              while :; do
                CRESP=$(mktemp) ; CHDR=$(mktemp)
                curl -s -D "${CHDR}" \
                  -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                  "${GL_API}/projects/${GL_ENC}/merge_requests/${gl_iid}/notes?activity_filter=only_comments&per_page=100&page=${cpage}" > "${CRESP}"

                jq -c '.[]' "${CRESP}" | while read -r note; do
                  nbody=$(jq -r '.body' <<< "$note")
                  nauth=$(jq -r '.author.username' <<< "$note")
                  curl -s -o /dev/null -w "%{http_code}" \
                    -H "Authorization: Bearer ${GH_PAT}" \
                    -H "Accept: application/vnd.github+json" \
                    -d "$(jq -n --arg b "**@${nauth} (from GitLab)**\n\n${nbody}" '{body:$b}')" \
                    "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${pr_num}/comments"
                  sleep 1
                done

                nnext=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${CHDR}" | tr -d '\r')
                [[ -z "${nnext}" || "${nnext}" == "0" ]] && break
                cpage="${nnext}"
              done

              sleep 1
            done

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')
            [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
                   done
