
name: GitLab Group â†’ GitHub multi-repo migration [Production]

on:
  push:
  delete:
  workflow_dispatch: {}

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # 0) Discover all projects in the GitLab group (optionally include subgroups/archived)
  discover_projects:
    name: "0) Discover projects in GL group"
    runs-on: ubuntu-latest
    outputs:
      project_list: ${{ steps.collect.outputs.project_list }}
    env:
      GL_URL: ${{ vars.GL_URL }}
      GL_GROUP: ${{ vars.GL_GROUP }}
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      INCLUDE_SUBGROUPS: ${{ vars.INCLUDE_SUBGROUPS }}
      INCLUDE_ARCHIVED: ${{ vars.INCLUDE_ARCHIVED }}
    steps:
      - name: Install jq & curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Resolve API & params
        id: prep
        shell: bash
        run: |
          set -euo pipefail
          : "${GL_URL:?GL_URL missing (vars)}"
          : "${GL_GROUP:?GL_GROUP missing (vars)}"
          : "${GL_TOKEN:?GITLAB_TOKEN missing (secrets)}"

          GL_API="${GL_URL%/}/api/v4"
          ENC_GROUP=$(jq -rn --arg x "$GL_GROUP" '$x|@uri')   # URL-encode group path
          SUBS="${INCLUDE_SUBGROUPS:-true}"
          ARCH="${INCLUDE_ARCHIVED:-false}"

          {
            echo "GL_API=$GL_API"
            echo "ENC_GROUP=$ENC_GROUP"
            echo "SUBS=$SUBS"
            echo "ARCH=$ARCH"
          } >> "$GITHUB_ENV"

      - name: Collect project paths (path_with_namespace)
        id: collect
        shell: bash
        run: |
          set -euo pipefail
          page=1
          TMP=$(mktemp)
          > "$TMP"

          # Endpoint: GET /groups/:id/projects?include_subgroups=true&per_page=100&page=N
          # :id accepts URL-encoded group path (ENC_GROUP)
          while true; do
            HDR=$(mktemp)
            RESP=$(mktemp)
            curl -s -D "$HDR" -H "PRIVATE-TOKEN: $GL_TOKEN" \
              "$GL_API/groups/$ENC_GROUP/projects?include_subgroups=$SUBS&archived=$ARCH&per_page=100&page=$page" > "$RESP"

            jq -r '.[].path_with_namespace' "$RESP" >> "$TMP"

            NEXT=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "$NEXT" || "$NEXT" == "0" ]] && break
            page="$NEXT"
          done

          # ðŸ”§ FIX: use compact JSON (-c) so we can set the output on a single line
          MATRIX_JSON=$(jq -cRn '[inputs]' < "$TMP")

          echo "Found $(jq 'length' <<<"$MATRIX_JSON") projects"
          # Write a single name=value line to $GITHUB_OUTPUT (required format)
          echo "project_list=$MATRIX_JSON" >> "$GITHUB_OUTPUT"

  # 1) Repo Migration Â· 1.1 Commit/branch mirror  (matrix over discovered projects)
  repo_migration_commit_sync:
    name: "1) ${ { matrix.project } } Â· Commit/Branch mirror"
    needs: discover_projects
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
      GL_URL: ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      AUTO_CREATE: ${{ vars.AUTO_CREATE_REPO }}
      DELETE_FIRST: ${{ vars.DELETE_DEST_REPO_FIRST }}
      REPO_NAME_MODE: ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX: ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl git

      - name: Resolve per-repo config
        id: cfg
        shell: bash
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          : "${GL_URL:?GL_URL missing}"
          : "${GL_PROJECT:?matrix project missing}"
          : "${GH_OWNER:?GH_OWNER missing}"
          : "${GL_TOKEN:?GITLAB_TOKEN missing}"
          : "${GH_PAT:?GH_PAT missing}"

          AUTO_CREATE="${AUTO_CREATE:-true}"
          DELETE_FIRST="${DELETE_FIRST:-false}"
          REPO_NAME_MODE="${REPO_NAME_MODE:-path}"
          GH_REPO_PREFIX="${GH_REPO_PREFIX:-}"
          GH_REPO_SEPARATOR="${GH_REPO_SEPARATOR:-"-"}"

          # Compute destination repo name
          if [[ "$REPO_NAME_MODE" == "fullpath" ]]; then
            base="$(echo "$GL_PROJECT" | tr '/' "$GH_REPO_SEPARATOR")"
          else
            base="${GL_PROJECT##*/}"
          fi
          GH_REPO="${GH_REPO_PREFIX}${base}"

          {
            echo "GL_PROJECT=$GL_PROJECT"
            echo "GH_REPO=$GH_REPO"
            echo "AUTO_CREATE=$AUTO_CREATE"
            echo "DELETE_FIRST=$DELETE_FIRST"
            echo "WORKDIR=/tmp/mirror-work"
          } >> "$GITHUB_ENV"

      - name: Optionally delete destination repository (DANGER)
        if: env.DELETE_FIRST == 'true'
        shell: bash
        run: |
          set -euo pipefail
          REPO_URL="https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X DELETE \
            -H "Authorization: Bearer ${GH_PAT}" -H "Accept: application/vnd.github+json" \
            "${REPO_URL}")
          echo "Delete HTTP status: ${STATUS}"
          if [[ "${STATUS}" != "204" && "${STATUS}" != "404" ]]; then
            echo "ERROR: Delete failed (HTTP ${STATUS})."; exit 1
          fi

      - name: Create GitHub repo if missing
        if: env.AUTO_CREATE == 'true'
        shell: bash
        run: |
          set -euo pipefail
          REPO_API="https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                   -H "Authorization: Bearer ${GH_PAT}" "${REPO_API}")
          if [[ "${STATUS}" == "200" ]]; then
            echo "Repo already exists."
          else
            MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user | jq -r '.login')
            if [[ "${GH_OWNER}" == "${MY_LOGIN}" ]]; then
              CREATE_URL="https://api.github.com/user/repos"
            else
              CREATE_URL="https://api.github.com/orgs/${GH_OWNER}/repos"
            fi
            PAYLOAD=$(jq -n --arg name "${GH_REPO}" \
              '{name:$name, private:true, has_issues:true, has_projects:true, has_wiki:true}')
            RESP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -H "Authorization: Bearer ${GH_PAT}" \
              -H "Accept: application/vnd.github+json" \
              -H "Content-Type: application/json" \
              -d "${PAYLOAD}" "${CREATE_URL}")
            HTTP=$(echo "${RESP}" | sed -n 's/^HTTP_STATUS://p')
            [[ "${HTTP}" == "201" ]] || { echo "Failed to create repo (HTTP ${HTTP})."; exit 1; }
          fi
          echo "GH repo ready: https://github.com/${GH_OWNER}/${GH_REPO}"
          sleep 1

      - name: Clone GitLab mirror (branches & commits)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"
          HOST="${GL_URL#*://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${GL_PROJECT}.git"
          echo "Cloning --mirror from ${GL_URL}/${GL_PROJECT}"
          git clone --mirror "${SRC_URL}" src.git
          git -C src.git show-ref | head -n 10 || true

      - name: Push mirror to GitHub (branches & commits)
        shell: bash
        run: |
          set -euo pipefail
          cd "${WORKDIR}/src.git"
          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          echo "Pushing --mirror to ${GH_OWNER}/${GH_REPO}..."
          git push --mirror github

  # 1.2) Tag sync
  repo_migration_tag_sync:
    name: "1.2) ${ { matrix.project } } Â· Tag sync"
    needs: [discover_projects, repo_migration_commit_sync]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
      GL_URL: ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE: ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX: ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install git
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git

      - name: Resolve per-repo config
        shell: bash
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          : "${GL_URL:?GL_URL missing}"
          : "${GL_PROJECT:?matrix project missing}"
          : "${GH_OWNER:?GH_OWNER missing}"
          REPO_NAME_MODE="${REPO_NAME_MODE:-path}"
          GH_REPO_PREFIX="${GH_REPO_PREFIX:-}"
          GH_REPO_SEPARATOR="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "$REPO_NAME_MODE" == "fullpath" ]]; then
            base="$(echo "$GL_PROJECT" | tr '/' "$GH_REPO_SEPARATOR")"
          else
            base="${GL_PROJECT##*/}"
          fi
          GH_REPO="${GH_REPO_PREFIX}${base}"
          {
            echo "GL_PROJECT=$GL_PROJECT"
            echo "GH_REPO=$GH_REPO"
            echo "WORKDIR=/tmp/mirror-work"
          } >> "$GITHUB_ENV"

      - name: Fetch tags from GitLab and push to GitHub
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"
          HOST="${GL_URL#*://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${GL_PROJECT}.git"
          if [[ ! -d src.git ]]; then
            git clone --mirror "${SRC_URL}" src.git
          fi
          cd src.git
          git fetch --tags origin
          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          echo "Pushing tags..."
          git push --tags github

  # 1.3) PR sync (MR â†’ PR) â€” optional via vars.MIGRATE_MRS
  repo_migration_pr_sync:
    name: "1.3) ${ { matrix.project } } Â· MR â†’ PR"
    needs: [discover_projects, repo_migration_commit_sync]
    runs-on: ubuntu-latest
    if: ${{ vars.MIGRATE_MRS == 'true' }}
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
      GL_URL: ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE: ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX: ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install jq & curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Prepare API & per-repo config
        shell: bash
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          : "${GL_URL:?GL_URL missing}"
          : "${GL_PROJECT:?matrix project missing}"
          : "${GH_OWNER:?GH_OWNER missing}"
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "$GL_PROJECT" '$x|@uri')
          REPO_NAME_MODE="${REPO_NAME_MODE:-path}"
          GH_REPO_PREFIX="${GH_REPO_PREFIX:-}"
          GH_REPO_SEPARATOR="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "$REPO_NAME_MODE" == "fullpath" ]]; then
            base="$(echo "$GL_PROJECT" | tr '/' "$GH_REPO_SEPARATOR")"
          else
            base="${GL_PROJECT##*/}"
          fi
          GH_REPO="${GH_REPO_PREFIX}${base}"
          {
            echo "GL_API=$GL_API"
            echo "GL_ENC=$GL_ENC"
            echo "GH_REPO=$GH_REPO"
          } >> "$GITHUB_ENV"

      - name: Migrate merge requests â†’ pull requests (with comments)
        shell: bash
        run: |
          set -euo pipefail
          : "${GH_OWNER:?GH_OWNER empty}"
          : "${GH_REPO:?GH_REPO empty}"
          : "${GL_API:?GL_API empty}"
          : "${GL_ENC:?GL_ENC empty}"
          page=1
          while true; do
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "$HDR" -H "PRIVATE-TOKEN: $GL_TOKEN" \
              "$GL_API/projects/$GL_ENC/merge_requests?scope=all&per_page=100&page=$page" > "$RESP"

            jq -c '.[]' "$RESP" | while read -r mr; do
              title=$(jq -r '.title' <<< "$mr")
              body=$(jq -r '.description // ""' <<< "$mr")
              state=$(jq -r '.state' <<< "$mr")
              labels=$(jq -c '.labels' <<< "$mr")
              source_branch=$(jq -r '.source_branch' <<< "$mr")
              target_branch=$(jq -r '.target_branch' <<< "$mr")
              author=$(jq -r '.author.username' <<< "$mr")
              gl_iid=$(jq -r '.iid' <<< "$mr")

              HEAD_OK=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $GH_PAT" "https://api.github.com/repos/$GH_OWNER/$GH_REPO/git/refs/heads/$source_branch")
              BASE_OK=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $GH_PAT" "https://api.github.com/repos/$GH_OWNER/$GH_REPO/git/refs/heads/$target_branch")
              if [[ "$HEAD_OK" != "200" || "$BASE_OK" != "200" ]]; then
                echo "Skip MR#$gl_iid: missing head/base ($source_branchâ†’$target_branch)"; continue
              fi

              CREATE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -H "Authorization: Bearer $GH_PAT" -H "Accept: application/vnd.github+json" \
                -d "$(jq -n --arg title "$title" --arg body "**Imported from GitLab by @$author**\n\n$body" --arg head "$source_branch" --arg base "$target_branch" '{title:$title, body:$body, head:$head, base:$base}')" \
                "https://api.github.com/repos/$GH_OWNER/$GH_REPO/pulls")
              http=$(echo "$CREATE" | sed -n 's/^HTTP_STATUS://p')
              pr_num=$(echo "$CREATE" | sed '/^HTTP_STATUS:/d' | jq -r '.number // empty')
              echo "PR create status=$http number=$pr_num"

              if [[ -n "$pr_num" && "$labels" != "null" ]]; then
                curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $GH_PAT" -H "Accept: application/vnd.github+json" -d "$labels" \
                  "https://api.github.com/repos/$GH_OWNER/$GH_REPO/issues/$pr_num/labels"
                sleep 1
              fi

              if [[ -n "$pr_num" ]]; then
                if [[ "$state" == "closed" ]]; then
                  curl -s -o /dev/null -w "%{http_code}" -X PATCH -H "Authorization: Bearer $GH_PAT" -H "Accept: application/vnd.github+json" -d '{"state":"closed"}' \
                    "https://api.github.com/repos/$GH_OWNER/$GH_REPO/issues/$pr_num"
                elif [[ "$state" == "merged" ]]; then
                  curl -s -o /dev/null -w "%{http_code}" -X PUT -H "Authorization: Bearer $GH_PAT" -H "Accept: application/vnd.github+json" -d '{"merge_method":"merge"}' \
                    "https://api.github.com/repos/$GH_OWNER/$GH_REPO/pulls/$pr_num/merge"
                fi
                sleep 1
              fi

              # Comments
              cpage=1
              while true; do
                CRESP=$(mktemp) ; CHDR=$(mktemp)
                curl -s -D "$CHDR" -H "PRIVATE-TOKEN: $GL_TOKEN" "$GL_API/projects/$GL_ENC/merge_requests/$gl_iid/notes?activity_filter=only_comments&per_page=100&page=$cpage" > "$CRESP"
                jq -c '.[]' "$CRESP" | while read -r note; do
                  nbody=$(jq -r '.body' <<< "$note")
                  nauth=$(jq -r '.author.username' <<< "$note")
                  curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $GH_PAT" -H "Accept: application/vnd.github+json" \
                    -d "$(jq -n --arg b "**@$nauth (from GitLab)**\n\n$nbody" '{body:$b}')" \
                    "https://api.github.com/repos/$GH_OWNER/$GH_REPO/issues/$pr_num/comments"
                  sleep 1
                done
                nnext=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$CHDR" | tr -d '\r')
                [[ -z "$nnext" || "$nnext" == "0" ]] && break
                cpage="$nnext"
              done
            done

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "$next" || "$next" == "0" ]] && break
            page="$next"
          done

  # 1.4) Label sync
  repo_migration_label_sync:
    name: "1.4) ${ { matrix.project } } Â· Label sync"
    needs: [discover_projects, repo_migration_commit_sync]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
      GL_URL: ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE: ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX: ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install jq & curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Prepare API & per-repo config
        shell: bash
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          : "${GL_URL:?GL_URL missing}"
          : "${GL_PROJECT:?matrix project missing}"
          : "${GH_OWNER:?GH_OWNER missing}"
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "$GL_PROJECT" '$x|@uri')
          REPO_NAME_MODE="${REPO_NAME_MODE:-path}"
          GH_REPO_PREFIX="${GH_REPO_PREFIX:-}"
          GH_REPO_SEPARATOR="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "$REPO_NAME_MODE" == "fullpath" ]]; then
            base="$(echo "$GL_PROJECT" | tr '/' "$GH_REPO_SEPARATOR")"
          else
            base="${GL_PROJECT##*/}"
          fi
          GH_REPO="${GH_REPO_PREFIX}${base}"
          {
            echo "GL_API=$GL_API"
            echo "GL_ENC=$GL_ENC"
            echo "GH_REPO=$GH_REPO"
          } >> "$GITHUB_ENV"

      - name: Migrate labels (GitLab â†’ GitHub)
        shell: bash
        run: |
          set -euo pipefail
          page=1
          while true; do
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "$HDR" -H "PRIVATE-TOKEN: $GL_TOKEN" \
              "$GL_API/projects/$GL_ENC/labels?per_page=100&page=$page" > "$RESP"

            jq -c '.[]' "$RESP" | while read -r lbl; do
              name=$(jq -r '.name' <<< "$lbl")
              color=$(jq -r '.color' <<< "$lbl" | sed 's/^#//')
              description=$(jq -r '.description // empty' <<< "$lbl")
              CREATE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -H "Authorization: Bearer $GH_PAT" -H "Accept: application/vnd.github+json" \
                -d "$(jq -n --arg name "$name" --arg color "$color" --arg desc "$description" '{name:$name, color:$color, description:$desc}')" \
                "https://api.github.com/repos/$GH_OWNER/$GH_REPO/labels")
              ST=$(echo "$CREATE" | sed -n 's/^HTTP_STATUS://p')
              if [[ "$ST" != "201" ]]; then
                curl -s -o /dev/null -w "%{http_code}" -X PATCH \
                  -H "Authorization: Bearer $GH_PAT" -H "Accept: application/vnd.github+json" \
                  -d "$(jq -n --arg new "$name" --arg color "$color" --arg desc "$description" '{new_name:$new, color:$color, description:$desc}')" \
                  "https://api.github.com/repos/$GH_OWNER/$GH_REPO/labels/$name"
              fi
              sleep 1
            done

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "$next" || "$next" == "0" ]] && break
            page="$next"
          done

  # 1.5) Milestone sync
  repo_migration_milestone_sync:
    name: "1.5) ${ { matrix.project } } Â· Milestone sync"
    needs: [discover_projects, repo_migration_label_sync]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
      GL_URL: ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE: ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX: ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install jq & curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Prepare API & per-repo config
        shell: bash
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          : "${GL_URL:?GL_URL missing}"
          : "${GL_PROJECT:?matrix project missing}"
          : "${GH_OWNER:?GH_OWNER missing}"
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "$GL_PROJECT" '$x|@uri')
          REPO_NAME_MODE="${REPO_NAME_MODE:-path}"
          GH_REPO_PREFIX="${GH_REPO_PREFIX:-}"
          GH_REPO_SEPARATOR="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "$REPO_NAME_MODE" == "fullpath" ]]; then
            base="$(echo "$GL_PROJECT" | tr '/' "$GH_REPO_SEPARATOR")"
          else
            base="${GL_PROJECT##*/}"
          fi
          GH_REPO="${GH_REPO_PREFIX}${base}"
          {
            echo "GL_API=$GL_API"
            echo "GL_ENC=$GL_ENC"
            echo "GH_REPO=$GH_REPO"
          } >> "$GITHUB_ENV"

      - name: Migrate milestones (GitLab â†’ GitHub)
        shell: bash
        run: |
          set -euo pipefail
          page=1
          while true; do
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "$HDR" -H "PRIVATE-TOKEN: $GL_TOKEN" \
              "$GL_API/projects/$GL_ENC/milestones?per_page=100&page=$page" > "$RESP"

            jq -c '.[]' "$RESP" | while read -r ms; do
              title=$(jq -r '.title' <<< "$ms")
              description=$(jq -r '.description // empty' <<< "$ms")
              due=$(jq -r '.due_date // empty' <<< "$ms")
              payload=$(jq -n --arg title "$title" --arg desc "$description" --arg due "$due" \
                '{title:$title, description:$desc} + ((($due|length)>0) ? {due_on:$due} : {})')
              status=$(curl -s -o /dev/null -w "%{http_code}" \
                -H "Authorization: Bearer $GH_PAT" \
                -H "Accept: application/vnd.github+json" \
                -d "$payload" \
                "https://api.github.com/repos/$GH_OWNER/$GH_REPO/milestones")
              echo "Milestone $title status: $status"
              sleep 1
            done

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "$next" || "$next" == "0" ]] && break
                       page="$next"
