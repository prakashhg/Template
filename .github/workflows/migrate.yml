
name: Mirroring (GitLab → GitHub)

on:
  [push, delete, workflow_dispatch]

permissions:
  contents: write   # needed for pushing with GITHUB_TOKEN
  # Note: creating repos requires a user PAT; GITHUB_TOKEN cannot create repos.

jobs:
  to_github:
    runs-on: ubuntu-latest
    # If your secrets are stored under environment "dev", declare it here:
    environment: dev

    steps:
      - name: Install tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          git --version

      # Clone the source repo from GitLab in mirror mode
      - name: Clone GitLab mirror
        env:
          # If you stored the secret as a repo/org secret:
          # GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          # If you stored it as an environment secret under environment "dev":
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail

          # ---- configure your source here ----
          GITLAB_URL="https://gitlab.com"
          GITLAB_PROJECT="prakashguruswamy24-group/my_project"   # <--- check exact path
          WORKDIR="/tmp/mirror-work"

          if [ -z "${GITLAB_TOKEN:-}" ]; then
            echo "ERROR: GITLAB_TOKEN is empty. Ensure the secret 'GITLAB_TOKEN' exists in repo/org or environment 'dev'."
            exit 1
          fi

          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"

          HOST="${GITLAB_URL#https://}"
          SRC_URL="https://oauth2:${GITLAB_TOKEN}@${HOST}/${GITLAB_PROJECT}.git"
          echo "Cloning --mirror from ${GITLAB_URL}/${GITLAB_PROJECT}.git"
          git clone --mirror "${SRC_URL}" src.git

          echo "Refs (preview):"
          git -C src.git show-ref | head -n 10 || true

      # Optionally create destination repo on GitHub if it doesn't exist
      - name: Create GitHub repo if missing
        env:
          # Use a user PAT (store as 'GH_PAT') — NOT the built-in GITHUB_TOKEN.
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail

          OWNER="prakashhg"            # <--- change if needed
          REPO="my_project"            # <--- change if needed
          REPO_API="https://api.github.com/repos/${OWNER}/${REPO}"

          if [ -z "${GH_PAT:-}" ]; then
            echo "No GH_PAT provided; will skip creation and assume repo exists."
            exit 0
          fi

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" "${REPO_API}")
          if [ "${STATUS}" = "200" ]; then
            echo "Repo already exists on GitHub."
            exit 0
          fi

          MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user | jq -r '.login')
          if [ "${OWNER}" = "${MY_LOGIN}" ]; then
            CREATE_URL="https://api.github.com/user/repos"
          else
            CREATE_URL="https://api.github.com/orgs/${OWNER}/repos"
          fi

          PAYLOAD='{"name":"'"${REPO}"'","private":true,"has_issues":true,"has_projects":true,"has_wiki":true}'
          CREATE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}" \
            "${CREATE_URL}")

          if [ "${CREATE_STATUS}" != "201" ]; then
            echo "Failed to create GitHub repo (HTTP ${CREATE_STATUS})."; exit 1
          fi
          echo "GitHub repo created: https://github.com/${OWNER}/${REPO}"

      # Push the mirror to GitHub
      - name: Push mirror to GitHub
        env:
          # Use built-in GITHUB_TOKEN for push (or use GH_PAT if you prefer)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          OWNER="prakashhg"      # <--- change if needed
          REPO="my_project"      # <--- change if needed

          if [ -z "${GITHUB_TOKEN:-}" ]; then
            echo "ERROR: GITHUB_TOKEN is empty. Ensure 'permissions: contents: write' and that the workflow has access."
            exit 1
          fi

          cd /tmp/mirror-work/src.git
          PUSH_URL="https://x-access-token:${GITHUB_TOKEN}@github.com/${OWNER}/${REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          echo "Pushing --mirror to ${OWNER}/${REPO}…"
          git push --mirror github
``
