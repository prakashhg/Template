
name: GitLab → GitHub Migration (env: dev)

on:
  workflow_dispatch:  # run manually

permissions:
  contents: read

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: dev     # <-- REQUIRED to access environment secrets
    timeout-minutes: 30

    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          git --version

      - name: Verify environment secrets are present (safe)
        run: |
          if [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            echo "❌ Missing env secret: GITLAB_TOKEN (environment: dev)"; exit 1; fi
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "❌ Missing env secret: GITHUB_TOKEN (environment: dev)"; exit 1; fi
          echo "✅ Found env secrets (values hidden)."

      - name: Clone from GitLab (mirror) via HTTPS
        run: |
          set -euo pipefail
          WORKDIR=/tmp/repo-migration
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"

          GITLAB_PROJECT="prakashguruswamy24-group/my_project"   # <-- change if needed
          SRC_URL="https://oauth2:${{ secrets.GITLAB_TOKEN }}@git          SRC_URL="https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/${GITLAB_PROJECT}.git"
          echo "Cloning --mirror from GitLab…"
          GIT_TRACE=1 GIT_CURL_VERBOSE=1 git clone --mirror "${SRC_URL}" src.git

          echo "Preview refs:"
          git -C src.git show-ref | head -n 10 || true

      - name: Push mirror to GitHub
        run: |
          set -euo pipefail
          cd /tmp/repo-migration/src.git
          OWNER="prakashhg"     # <-- change if needed
          REPO="my_project"     # <-- change if needed

          PUSH_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${OWNER}/${REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          echo "Pushing --mirror to https://github.com/${OWNER}/${REPO}…"
          git push --mirror github
