
name: Mirroring (GitLab → GitHub)

on:
  push:
  delete:
  workflow_dispatch:
    inputs:
      gl_url:
        description: "GitLab base URL (e.g., https://gitlab.com)"
        required: false
        type: string
      gl_project:
        description: "GitLab project path (e.g., group/subgroup/repo)"
        required: false
        type: string
      gh_owner:
        description: "GitHub user/org owner (e.g., prakashhg)"
        required: false
        type: string
      gh_repo:
        description: "GitHub repository name (e.g., my_project)"
        required: false
        type: string
      auto_create_repo:
        description: "Create destination repo if missing? (true/false)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      delete_dest_repo_first:
        description: "Delete destination repo before mirroring? (true/false) — USE WITH CAUTION"
        required: false
        default: "false"
        type: choice
        options: ["true", "false"]

permissions:
  contents: write

jobs:
  to_github:
    runs-on: ubuntu-latest

    # Secrets and Variables (no custom GITHUB_* env names)
    env:
      # Secrets — set under Settings → Secrets and variables → Actions → Secrets
      GL_TOKEN:  ${{ secrets.GITLAB_TOKEN }}   # GitLab PAT with read_repository + read_api
      GH_PAT:    ${{ secrets.GH_PAT }}         # GitHub PAT with repo (and admin:org for org creation)

      # Repo/Org Variables — set under Settings → Secrets and variables → Actions → Variables
      VAR_GL_URL:          ${{ vars.GL_URL }}
      VAR_GL_PROJECT:      ${{ vars.GL_PROJECT }}
      VAR_GH_OWNER:        ${{ vars.GH_OWNER }}
      VAR_GH_REPO:         ${{ vars.GH_REPO }}
      VAR_AUTO_CREATE:     ${{ vars.AUTO_CREATE_REPO }}
      VAR_DELETE_FIRST:    ${{ vars.DELETE_DEST_REPO_FIRST }}

      # workflow_dispatch inputs
      IN_GL_URL:           ${{ inputs.gl_url }}
      IN_GL_PROJECT:       ${{ inputs.gl_project }}
      IN_GH_OWNER:         ${{ inputs.gh_owner }}
      IN_GH_REPO:          ${{ inputs.gh_repo }}
      IN_AUTO_CREATE:      ${{ inputs.auto_create_repo }}
      IN_DELETE_FIRST:     ${{ inputs.delete_dest_repo_first }}

    steps:
      - name: Print runner & git version
        run: |
          echo "Runner: $(uname -a)"
          git --version

      - name: Install tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Resolve configuration
        id: cfg
        run: |
          set -euo pipefail

          # Precedence: Inputs > Variables > Defaults
          GL_URL="${IN_GL_URL:-${VAR_GL_URL:-https://gitlab.com}}"
          GL_PROJECT="${IN_GL_PROJECT:-${VAR_GL_PROJECT:-}}"
          GH_OWNER="${IN_GH_OWNER:-${VAR_GH_OWNER:-}}"
          GH_REPO="${IN_GH_REPO:-${VAR_GH_REPO:-}}"
          AUTO_CREATE="${IN_AUTO_CREATE:-${VAR_AUTO_CREATE:-true}}"
          DELETE_FIRST="${IN_DELETE_FIRST:-${VAR_DELETE_FIRST:-false}}"

          # Validation
          ERR=0
          [[ -z "${GL_PROJECT}" ]] && echo "❌ GL_PROJECT is required (input 'gl_project' or variable 'GL_PROJECT')." && ERR=1
          [[ -z "${GH_OWNER}" || -z "${GH_REPO}" ]] && echo "❌ GH_OWNER and GH_REPO are required (inputs or variables)." && ERR=1
          [[ -z "${GL_TOKEN:-}" ]] && echo "❌ Missing secret GITLAB_TOKEN." && ERR=1
          [[ -z "${GH_PAT:-}" ]] && echo "❌ Missing secret GH_PAT." && ERR=1
          if [[ "${ERR}" -ne 0 ]]; then
            echo "❌ Configuration invalid. Aborting."
            exit 1
          fi

          # Export for later steps (line-by-line to avoid brace parsing issues)
          echo "GL_URL=${GL_URL}"             >> "$GITHUB_ENV"
          echo "GL_PROJECT=${GL_PROJECT}"     >> "$GITHUB_ENV"
          echo "GH_OWNER=${GH_OWNER}"         >> "$GITHUB_ENV"
          echo "GH_REPO=${GH_REPO}"           >> "$GITHUB_ENV"
          echo "AUTO_CREATE=${AUTO_CREATE}"   >> "$GITHUB_ENV"
          echo "DELETE_FIRST=${DELETE_FIRST}" >> "$GITHUB_ENV"
          echo "WORKDIR=/tmp/mirror-work"     >> "$GITHUB_ENV"

          echo "Using configuration:"
          echo " - GL_URL=${GL_URL}"
          echo " - GL_PROJECT=${GL_PROJECT}"
          echo " - GH_OWNER=${GH_OWNER}"
          echo " - GH_REPO=${GH_REPO}"
          echo " - AUTO_CREATE=${AUTO_CREATE}"
          echo " - DELETE_FIRST=${DELETE_FIRST}"

      - name: Optionally delete destination repository (DANGER)
        if: env.DELETE_FIRST == 'true'
        env:
          GH_OWNER: ${{ env.GH_OWNER }}
          GH_REPO:  ${{ env.GH_REPO }}
          GH_PAT:   ${{ env.GH_PAT }}
        run: |
          set -euo pipefail
          echo "⚠️ Deleting https://github.com/${GH_OWNER}/${GH_REPO} …"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X DELETE \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}")
          echo "Delete HTTP status: ${STATUS}"
          if [[ "${STATUS}" != "204" && "${STATUS}" != "404" ]]; then
            echo "❌ Delete failed (HTTP ${STATUS})."; exit 1
          fi
          [[ "${STATUS}" == "404" ]] && echo "Repo did not exist; proceeding."

      - name: Create GitHub repo if missing (optional)
        if: env.AUTO_CREATE == 'true'
        env:
          GH_OWNER: ${{ env.GH_OWNER }}
          GH_REPO:  ${{ env.GH_REPO }}
          GH_PAT:   ${{ env.GH_PAT }}
        run: |
          set -euo pipefail

          REPO_API="https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" "${REPO_API}")
          echo "Probe status: ${STATUS}"

          if [ "${STATUS}" = "200" ]; then
            echo "Repo already exists on GitHub."
            exit 0
          fi

          # Determine endpoint: user vs org
          MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user | jq -r '.login')
          if [ "${GH_OWNER}" = "${MY_LOGIN}" ]; then
            CREATE_URL="https://api.github.com/user/repos"
          else
            CREATE_URL="https://api.github.com/orgs/${GH_OWNER}/repos"
          fi

          PAYLOAD=$(jq -n --arg name "${GH_REPO}" \
            '{name: $name, private: true, has_issues: true, has_projects: true, has_wiki: true}')

          # Capture response for debugging
          RESP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}" \
            "${CREATE_URL}")

          HTTP_STATUS=$(echo "$RESP" | sed -n 's/^HTTP_STATUS://p')
          BODY=$(echo "$RESP" | sed '/^HTTP_STATUS:/d')

          echo "Create repo HTTP status: ${HTTP_STATUS}"
          echo "Response body: ${BODY}"

          if [ "${HTTP_STATUS}" != "201" ]; then
            echo "❌ Failed to create GitHub repo (HTTP ${HTTP_STATUS})."
            exit 1
          fi

          echo "✅ GitHub repo created: https://github.com/${GH_OWNER}/${GH_REPO}"

      - name: Clone GitLab mirror
        env:
          GL_URL:     ${{ env.GL_URL }}
          GL_PROJECT: ${{ env.GL_PROJECT }}
          GL_TOKEN:   ${{ env.GL_TOKEN }}
          WORKDIR:    ${{ env.WORKDIR }}
        run: |
          set -euo pipefail
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"

          HOST="${GL_URL#https://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${GL_PROJECT}.git"

          echo "Cloning --mirror from ${GL_URL}/${GL_PROJECT}"
          git clone --mirror "${SRC_URL}" src.git

          echo "Refs (preview):"
          git -C src.git show-ref | head -n 10 || true

      - name: Push mirror to GitHub
        env:
          GH_OWNER: ${{ env.GH_OWNER }}
          GH_REPO:  ${{ env.GH_REPO }}
          GH_PAT:   ${{ env.GH_PAT }}
          WORKDIR:  ${{ env.WORKDIR }}
        run: |
          set -euo pipefail
          cd "${WORKDIR}/src.git"

          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"

          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"

          echo "          echo "Pushing --mirror to ${GH_OWNER}/${GH_REPO}…"
