
name: Mirroring (GitLab → GitHub)

on:
  push:
  delete:
  workflow_dispatch:
    inputs:
      gl_url:
        description: "GitLab base URL (e.g., https://gitlab.com)"
        required: false
        type: string
      gl_project:
        description: "GitLab project path (e.g., group/subgroup/repo)"
        required: false
        type: string
      gh_owner:
        description: "GitHub user/org owner (e.g., prakashhg)"
        required: false
        type: string
      gh_repo:
        description: "GitHub repository name (e.g., my_project)"
        required: false
        type: string
      auto_create_repo:
        description: "Create destination repo if missing? (true/false)"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      delete_dest_repo_first:
        description: "Delete destination repo before mirroring? (true/false) — USE WITH CAUTION"
        required: false
        default: "false"
        type: choice
        options: ["true", "false"]

permissions:
  contents: write

jobs:
  to_github:
    runs-on: ubuntu-latest

    env:
      # Secrets
      GL_TOKEN:  ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:    ${{ secrets.GH_PAT }}

      # Variables (no GITHUB_* custom names)
      VAR_GL_URL:          ${{ vars.GL_URL }}
      VAR_GL_PROJECT:      ${{ vars.GL_PROJECT }}
      VAR_GH_OWNER:        ${{ vars.GH_OWNER }}
      VAR_GH_REPO:         ${{ vars.GH_REPO }}
      VAR_AUTO_CREATE:     ${{ vars.AUTO_CREATE_REPO }}
      VAR_DELETE_FIRST:    ${{ vars.DELETE_DEST_REPO_FIRST }}

      # Inputs
      IN_GL_URL:           ${{ inputs.gl_url }}
      IN_GL_PROJECT:       ${{ inputs.gl_project }}
      IN_GH_OWNER:         ${{ inputs.gh_owner }}
      IN_GH_REPO:          ${{ inputs.gh_repo }}
      IN_AUTO_CREATE:      ${{ inputs.auto_create_repo }}
      IN_DELETE_FIRST:     ${{ inputs.delete_dest_repo_first }}

    steps:
      - name: Print runner & git version
        run: |
          set -x
          echo "Runner: $(uname -a)"
          git --version

      - name: Install tools
        run: |
          set -euo pipefail
          set -x
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Resolve configuration
        id: cfg
        run: |
          set -euo pipefail
          set -x

          GL_URL="${IN_GL_URL:-${VAR_GL_URL:-https://gitlab.com}}"
          GL_PROJECT="${IN_GL_PROJECT:-${VAR_GL_PROJECT:-}}"
          GH_OWNER="${IN_GH_OWNER:-${VAR_GH_OWNER:-}}"
          GH_REPO="${IN_GH_REPO:-${VAR_GH_REPO:-}}"
          AUTO_CREATE="${IN_AUTO_CREATE:-${VAR_AUTO_CREATE:-true}}"
          DELETE_FIRST="${IN_DELETE_FIRST:-${VAR_DELETE_FIRST:-false}}"

          ERR=0
          [[ -z "${GL_PROJECT}" ]] && echo "❌ GL_PROJECT is required (input 'gl_project' or variable 'GL_PROJECT')." && ERR=1
          [[ -z "${GH_OWNER}" || -z "${GH_REPO}" ]] && echo "❌ GH_OWNER and GH_REPO are required (inputs or variables)." && ERR=1
          [[ -z "${GL_TOKEN:-}" ]] && echo "❌ Missing secret GITLAB_TOKEN." && ERR=1
          [[ -z "${GH_PAT:-}" ]] && echo "❌ Missing secret GH_PAT." && ERR=1
          if [[ "${ERR}" -ne 0 ]]; then
            echo "❌ Configuration invalid. Aborting."
            exit 1
          fi

          {
            echo 'GL_URL<<__EOF__'
            echo "${GL_URL}"
            echo '__EOF__'
            echo 'GL_PROJECT<<__EOF__'
            echo "${GL_PROJECT}"
            echo '__EOF__'
            echo 'GH_OWNER<<__EOF__'
            echo "${GH_OWNER}"
            echo '__EOF__'
            echo 'GH_REPO<<__EOF__'
            echo "${GH_REPO}"
            echo '__EOF__'
            echo 'AUTO_CREATE<<__EOF__'
            echo "${AUTO_CREATE}"
            echo '__EOF__'
            echo 'DELETE_FIRST<<__EOF__'
            echo "${DELETE_FIRST}"
            echo '__EOF__'
            echo 'WORKDIR<<__EOF__'
            echo "/tmp/mirror-work"
            echo '__EOF__'
          } >> "$GITHUB_ENV"

          echo "Using configuration:"
          printf ' - GL_URL=%s\n'      "${GL_URL}"
          printf ' - GL_PROJECT=%s\n'  "${GL_PROJECT}"
          printf ' - GH_OWNER=%s\n'    "${GH_OWNER}"
          printf ' - GH_REPO=%s\n'     "${GH_REPO}"
          printf ' - AUTO_CREATE=%s\n' "${AUTO_CREATE}"
          printf ' - DELETE_FIRST=%s\n'"${DELETE_FIRST}"

      - name: Optionally delete destination repository (DANGER)
        if: env.DELETE_FIRST == 'true'
        env:
          GH_OWNER: ${{ env.GH_OWNER }}
          GH_REPO:  ${{ env.GH_REPO }}
          GH_PAT:   ${{ env.GH_PAT }}
        run: |
          set -euo pipefail
          set -x
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X DELETE \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}")
          echo "Delete HTTP status: ${STATUS}"
          if [[ "${STATUS}" != "204" && "${STATUS}" != "404" ]]; then
            echo "❌ Delete failed (HTTP ${STATUS})."; exit 1
          fi
          [[ "${STATUS}" == "404" ]] && echo "Repo did not exist; proceeding."

      - name: Create GitHub repo if missing (optional)
        if: env.AUTO_CREATE == 'true'
        env:
          GH_OWNER: ${{ env.GH_OWNER }}
          GH_REPO:  ${{ env.GH_REPO }}
          GH_PAT:   ${{ env.GH_PAT }}
        run: |
          set -euo pipefail
          set -x

          REPO_API="https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" "${REPO_API}")
          echo "Probe status: ${STATUS}"

          if [ "${STATUS}" = "200" ]; then
            echo "Repo already exists on GitHub."
            exit 0
          fi

          MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user | jq -r '.login')
          if [ "${GH_OWNER}" = "${MY_LOGIN}" ]; then
            CREATE_URL="https://api.github.com/user/repos"
          else
            CREATE_URL="https://api.github.com/orgs/${GH_OWNER}/repos"
          fi

          PAYLOAD=$(jq -n --arg name "${GH_REPO}" \
            '{name: $name, private: true, has_issues: true, has_projects: true, has_wiki: true}')

          RESP=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Content-Type: application/json" \
            -d "${PAYLOAD}" \
            "${CREATE_URL}")

          HTTP_STATUS=$(echo "$RESP" | sed -n 's/^HTTP_STATUS://p')
          BODY=$(echo "$RESP" | sed '/^HTTP_STATUS:/d')

          echo "Create repo HTTP status: ${HTTP_STATUS}"
          echo "Response body: ${BODY}"

          if [ "${HTTP_STATUS}" != "201" ]; then
            echo "❌ Failed to create GitHub repo (HTTP ${HTTP_STATUS})."
            exit 1
          fi

          echo "✅ GitHub repo created: https://github.com/${GH_OWNER}/${GH_REPO}"

      - name: Clone GitLab mirror
        env:
          GL_URL:     ${{ env.GL_URL }}
          GL_PROJECT: ${{ env.GL_PROJECT }}
          GL_TOKEN:   ${{ env.GL_TOKEN }}
          WORKDIR:    ${{ env.WORKDIR }}
        run: |
          set -euo pipefail
          set -x
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"

          HOST="${GL_URL#https://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${GL_PROJECT}.git"

          echo "Cloning --mirror from ${GL_URL}/${GL_PROJECT}"
          git clone --mirror "${SRC_URL}" src.git

          echo "Refs (preview):"
          git -C src.git show-ref | head -n 10 || true

      - name: Push mirror to GitHub
        env:
          GH_OWNER: ${{ env.GH_OWNER }}
          GH_REPO:  ${{ env.GH_REPO }}
          GH_PAT:   ${{ env.GH_PAT }}
          WORKDIR:  ${{ env.WORKDIR }}
        run: |
          set -euo pipefail
          set -x
          cd "${WORKDIR}/src.git"

          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"

          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"

          echo "Pushing --mirror to ${GH_OWNER}/${GH_REPO}…"
          git
