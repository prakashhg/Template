
name: GitLab → GitHub Migration (env: dev)

on:
  workflow_dispatch:  # run manually from Actions

permissions:
  contents: read  # we push using a PAT via HTTPS, not the built-in GITHUB_TOKEN

jobs:
  migrate:
    runs-on: ubuntu-latest
    environment: dev   # <-- makes environment secrets available to this job
    timeout-minutes: 30

    # Optional: if your environment requires approval, you'll see a "Review deployments" gate in the UI.

    steps:
      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          git --version

      - name: Debug secrets presence (safe)
        # This does NOT print secret values; it only proves they are non-empty
        run: |
          if [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            echo "❌ GITLAB_TOKEN (env: dev) is empty or not defined"; exit 1; fi
          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            echo "❌ GITHUB_TOKEN (env: dev) is empty or not defined"; exit 1; fi
          echo "✅ Environment secrets detected: GITLAB_TOKEN & GITHUB_TOKEN (values hidden)."

      - name: Clone from GitLab (mirror) via HTTPS
        run: |
          set -euo pipefail
          WORKDIR=/tmp/repo-migration
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"

          GITLAB_PROJECT="prakashguruswamy24-group/my_project"   # change if needed
          # No trailing slash after .git
          SRC_URL="https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/${GITLAB_PROJECT}.git"

          echo "Cloning --mirror from GitLab (token hidden in logs)..."
          GIT_CURL_VERBOSE=1 git clone --mirror "${SRC_URL}" src.git

          echo "Preview refs:"
          git -C src.git show-ref | head -n 10 || true

      - name: Push mirror to GitHub
        run: |
          set -euo pipefail
          cd /tmp/repo-migration/src.git
          OWNER="prakashhg"      # change if needed
          REPO="my_project"      # change if needed

          PUSH_URL="https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${OWNER}/${REPO}.git"
          git remote remove github           git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"

          echo "Pushing --mirror to https://github.com/${OWNER}/${REPO}..."
          git push --mirror github
