
name: Mirroring (GitLab → GitHub) + Trackers migration [Production]

on:
  workflow_dispatch:
    inputs:
      gl_url:
        description: "GitLab base URL (e.g., https://gitlab.com)"
        required: false
        type: string
      gl_project:
        description: "GitLab project path (e.g., group/subgroup/repo)"
        required: true
        type: string
      gh_owner:
        description: "GitHub owner (user/org)"
        required: true
        type: string
      gh_repo:
        description: "GitHub repository name"
        required: true
        type: string
      auto_create_repo:
        description: "Create destination repo if missing?"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      delete_dest_repo_first:
        description: "Delete destination repo before mirroring?"
        required: false
        default: "false"
        type: choice
        options: ["true", "false"]
      migrate_issues:
        description: "Migrate Issues + Comments?"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      migrate_mrs:
        description: "Migrate Merge Requests → Pull Requests?"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # ──────────────────────────────────────────────────────────────
  # 1) Repo Migration · 1.1 Commit Sync
  # ──────────────────────────────────────────────────────────────
  repo_migration_commit_sync:
    name: "1) Repo Migration · 1.1 Commit Sync"
    runs-on: ubuntu-latest
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ inputs.gl_url || 'https://gitlab.com' }}
      GL_PROJECT: ${{ inputs.gl_project }}
      GH_OWNER: ${{ inputs.gh_owner }}
      GH_REPO:  ${{ inputs.gh_repo }}
      AUTO_CREATE: ${{ inputs.auto_create_repo || 'true' }}
      DELETE_FIRST: ${{ inputs.delete_dest_repo_first || 'false' }}
      WORKDIR: /tmp/mirror-work
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl git

      - name: Mirror commits/branches
        run: bash scripts/commit_sync.sh

  # ──────────────────────────────────────────────────────────────
  # 1) Repo Migration · 1.2 Tag Sync
  # ──────────────────────────────────────────────────────────────
  repo_migration_tag_sync:
    name: "1) Repo Migration · 1.2 Tag Sync"
    needs: repo_migration_commit_sync
    runs-on: ubuntu-latest
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ inputs.gl_url || 'https://gitlab.com' }}
      GL_PROJECT: ${{ inputs.gl_project }}
      GH_OWNER: ${{ inputs.gh_owner }}
      GH_REPO:  ${{ inputs.gh_repo }}
      WORKDIR: /tmp/mirror-work
    steps:
      - uses: actions/checkout@v4

      - name: Install git
        run: |
          sudo apt-get update -y && sudo apt-get install -y git jq

      - name: Sync tags
        run: bash scripts/tag_sync.sh

  # ──────────────────────────────────────────────────────────────
  # 1) Repo Migration · 1.3 PR Sync (MR → PR)
  # ──────────────────────────────────────────────────────────────
  repo_migration_pr_sync:
    name: "1) Repo Migration · 1.3 PR Sync (MR → PR)"
    if: ${{ inputs.migrate_mrs == 'true' }}
    needs: repo_migration_commit_sync
    runs-on: ubuntu-latest
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ inputs.gl_url || 'https://gitlab.com' }}
      GL_PROJECT: ${{ inputs.gl_project }}
      GH_OWNER: ${{ inputs.gh_owner }}
      GH_REPO:  ${{ inputs.gh_repo }}
    steps:
      - uses: actions/checkout@v4

      - name: Install jq & curl
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq curl

      - name: MRs → PRs
        run: bash scripts/pr_sync.sh

  # ──────────────────────────────────────────────────────────────
  # 1) Repo Migration · 1.4 Label Sync
  # ──────────────────────────────────────────────────────────────
  repo_migration_label_sync:
    name: "1) Repo Migration · 1.4 Label Sync"
    needs: repo_migration_commit_sync
    runs-on: ubuntu-latest
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ inputs.gl_url || 'https://gitlab.com' }}
      GL_PROJECT: ${{ inputs.gl_project }}
      GH_OWNER: ${{ inputs.gh_owner }}
      GH_REPO:  ${{ inputs.gh_repo }}
    steps:
      - uses: actions/checkout@v4

      - name: Install jq & curl
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq curl

      - name: Sync labels
        run: bash scripts/label_sync.sh

  # ──────────────────────────────────────────────────────────────
  # 1) Repo Migration · 1.5 Milestone Sync
  # ──────────────────────────────────────────────────────────────
  repo_migration_milestone_sync:
    name: "1) Repo Migration · 1.5 Milestone Sync"
    needs: [repo_migration_commit_sync, repo_migration_label_sync]
    runs-on: ubuntu-latest
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ inputs.gl_url || 'https://gitlab.com' }}
      GL_PROJECT: ${{ inputs.gl_project }}
      GH_OWNER: ${{ inputs.gh_owner }}
      GH_REPO:  ${{ inputs.gh_repo }}
    steps:
      - uses: actions/checkout@v4

      - name: Install jq & curl
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq curl

      - name: Sync milestones
        run: bash scripts/milestone_sync.sh

  # ──────────────────────────────────────────────────────────────
  # 1) Repo Migration · 1.6 Issue Sync
  # ──────────────────────────────────────────────────────────────
  repo_migration_issue_sync:
    name: "1) Repo Migration · 1.6 Issue Sync"
    if: ${{ inputs.migrate_issues == 'true' }}
    needs: [repo_migration_commit_sync, repo_migration_label_sync, repo_migration_milestone_sync]
    runs-on: ubuntu-latest
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ inputs.gl_url || 'https://gitlab.com' }}
      GL_PROJECT: ${{ inputs      GL_PROJECT: ${{ inputs.gl_project }}
      GH_OWNER: ${{ inputs.gh_owner }}
      GH_REPO:  ${{ inputs.gh_repo }}
    steps:
      - uses: actions/checkout@v4

      - name: Install jq & curl
        run: |
          sudo apt-get update -y && sudo apt-get install -y jq curl

      - name: Issues + comments
