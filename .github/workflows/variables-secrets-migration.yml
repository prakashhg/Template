
name: Stage 2 â€” Variables & Secrets Migration

on:
  workflow_dispatch:
    inputs:
      source_type:
        description: "GitLab source type: project | group"
        required: true
        type: choice
        options: ["project", "group"]
        default: "project"
      source_id_or_path:
        description: "GitLab project/group ID or full path"
        required: true
        type: string
      gl_url:
        description: "GitLab base URL (e.g., https://gitlab.com)"
        required: false
        type: string
      gh_owner:
        description: "GitHub owner/org"
        required: true
        type: string
      gh_repo:
        description: "GitHub repository name"
        required: true
        type: string
      dry_run:
        description: "Don't write to GitHub; just produce report"
        required: false
        type: choice
        options: ["true", "false"]
        default: "false"

permissions:
  contents: read

env:
  GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
  GH_PAT:   ${{ secrets.GH_PAT }}

jobs:
  migrate-vars-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Install tools (jq, curl, gh)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          type gh >/dev/null 2>&1 || sudo apt-get install -y gh
          gh --version

      - name: Resolve config
        id: cfg
        shell: bash
        run: |
          set -euo pipefail
          GL_URL="${{ inputs.gl_url }}"
          [ -z "${GL_URL}" ] && GL_URL="https://gitlab.com"
          SRC_TYPE="${{ inputs.source_type }}"
          SRC_ID="${{ inputs.source_id_or_path }}"
          GH_OWNER="${{ inputs.gh_owner }}"
          GH_REPO="${{ inputs.gh_repo }}"
          DRY="${{ inputs.dry_run }}"

          [[ -z "${GL_TOKEN:-}" ]] && { echo "ERROR: Missing GITLAB_TOKEN"; exit 1; }
          [[ -z "${GH_PAT:-}"   ]] && { echo "ERROR: Missing GH_PAT"; exit 1; }

          echo "GL_URL=${GL_URL}"     >> "$GITHUB_ENV"
          echo "SRC_TYPE=${SRC_TYPE}" >> "$GITHUB_ENV"
          echo "SRC_ID=${SRC_ID}"     >> "$GITHUB_ENV"
          echo "GH_OWNER=${GH_OWNER}" >> "$GITHUB_ENV"
          echo "GH_REPO=${GH_REPO}"   >> "$GITHUB_ENV"
          echo "DRY=${DRY}"           >> "$GITHUB_ENV"

      - name: Authenticate gh
        shell: bash
        run: |
          set -euo pipefail
          echo "${GH_PAT}" | gh auth login --with-token
          gh repo view "${GH_OWNER}/${GH_REPO}" >/dev/null

      - name: Fetch GitLab variables (paged)
        id: fetch
        shell: bash
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          ENCODED=$(jq -rn --arg x "${SRC_ID}" '$x|@uri')

          if [[ "${SRC_TYPE}" == "project" ]]; then
            URL="${GL_API}/projects/${ENCODED}/variables"
          else
            URL="${GL_API}/groups/${ENCODED}/variables"
          fi

          page=1
          out=$(mktemp)
          echo "[]" > "${out}"

          while :; do
            HDR=$(mktemp)
            BODY=$(mktemp)
            curl -s -D "${HDR}" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${URL}?per_page=100&page=${page}" > "${BODY}"

            jq -c -s 'add' <(cat "${out}") <(jq -c '.' "${BODY}") > "${out.tmp}" && mv "${out.tmp}" "${out}"

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')
            [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done

          mv "${out}" gl_vars.json
          echo "count=$(jq 'length' gl_vars.json)" >> "$GITHUB_OUTPUT"

      - name: Classify & migrate to GitHub (variables vs secrets)
        shell: bash
        run: |
          set -euo pipefail
          echo '{"migrated": [], "skipped": [], "errors": []}' > report.json

          add_to() {
            local section="$1"; shift
            jq --argjson item "$(<tmp_item.json)" \
              ".$section += [ $item ]" report.json > report.tmp && mv report.tmp report.json
          }

          jq -c '.[]' gl_vars.json | while read -r v; do
            key=$(jq -r '.key' <<< "${v}")
            value=$(jq -r '.value // ""' <<< "${v}")
            masked=$(jq -r '.masked // false' <<< "${v}")
            hidden=$(jq -r '.hidden // false' <<< "${v}")
            scope=$(jq -r '.environment_scope // "*"' <<< "${v}")
            desc=$(jq -r '.description // ""' <<< "${v}")

            jq -n --arg key "$key" --arg scope "$scope" --arg masked "$masked" --arg hidden "$hidden" \
                  --arg desc "$desc" \
                  '{key:$key, scope:$scope, masked:$masked, hidden:$hidden, description:$desc}' \
                  > tmp_item.json

            if [[ "${DRY}" == "true" ]]; then
              add_to migrated
              continue
            fi

            target_args=()
            if [[ "${scope}" != "*" ]]; then
              # Environment-scoped keys go into environment variables/secrets
              target_args=(--env "${scope}")
            fi

            if [[ "${masked}" == "true" || "${hidden}" == "true" ]]; then
              # Secrets (gh CLI handles encryption)
              if echo -n "${value}" | gh secret set "${key}" "${target_args[@]}" -R "${GH_OWNER}/${GH_REPO}" --body -; then
                add_to migrated
              else
                add_to errors
              fi
              sleep 1
            else
              # Variables
              if echo -n "${value}" | gh variable set "${key}" "${target_args[@              if echo -n "${value}" | gh variable set "${key}" "${target_args[@]}" -R "${GH_OWNER}/${GH_REPO}" --body -; then
                add_to migrated
              else
                add_to errors
              fi
              sleep 1
            fi
          done

      - name: Upload migration report
        uses: actions/upload-artifact@v4
        with:
          name: variables-secrets-report
