
name: Stage 3 — GitLab CI → GitHub Actions Migration

on:
  workflow_dispatch:
    inputs:
      open_pr:
        description: "Create a PR with the generated workflow?"
        required: false
        type: choice
        options: ["true", "false"]
        default: "true"
      target_branch:
        description: "Branch to commit the generated workflow to"
        required: false
        type: string
        default: "ci-migration/migrated-workflow"

permissions:
  contents: write
  pull-requests: write

env:
  GH_PAT: ${{ secrets.GH_PAT }}

jobs:
  generate-actions-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install PyYAML
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Parse .gitlab-ci.yml and generate Actions workflow
        id: gen
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -f ".gitlab-ci.yml" ]]; then
            echo "ERROR: .gitlab-ci.yml not found"; exit 1;
          fi

          python - <<'PY'
import sys, os, yaml, json
from pathlib import Path

src = Path(".gitlab-ci.yml")
data = yaml.safe_load(src.read_text())

def to_steps(job):
    steps = []
    cmds = []
    for k in ("before_script", "script", "after_script"):
        v = job.get(k)
        if isinstance(v, list):
            cmds.extend(v)
        elif isinstance(v, str):
            cmds.append(v)
    if cmds:
        steps.append({"name":"Run job script","shell":"bash","run":"\n".join(cmds)})
    artifacts = job.get("artifacts", {})
    paths = artifacts.get("paths")
    if isinstance(paths, list) and paths:
        steps.append({
            "name":"Upload artifacts",
            "uses":"actions/upload-artifact@v4",
            "with":{"name":"artifacts-"+job.get("name","job"),"path":"\n".join(paths)}
        })
    return steps

def job_image(job):
    img = job.get("image")
    if isinstance(img, str):
        return {"container": {"image": img}}
    elif isinstance(img, dict) and "name" in img:
        c = {"image": img["name"]}
        if "entrypoint" in img and isinstance(img["entrypoint"], list):
            c["options"] = "--entrypoint " + " ".join(img["entrypoint"])
        return {"container": c}
    return {}

def job_services(job):
    services = job.get("services")
    if isinstance(services, list) and services:
        arr = []
        for s in services:
            if isinstance(s, str):
                arr.append({"image": s})
            elif isinstance(s, dict) and "name" in s:
                obj = {"image": s["name"]}
                if "command" in s and isinstance(s["command"], list):
                    obj["options"] = "--command " + " ".join(s["command"])
                arr.append(obj)
        if arr:
            return {"services": arr}
    return {}

default_env = data.get("variables", {}) or {}
stages = data.get("stages", []) or []

workflow = {
  "name": "Migrated from GitLab CI",
  "on": ["push","workflow_dispatch"],
  "jobs": {}
}

stage_order = {s:i for i,s in enumerate(stages)} if stages else {}

for name, job in list(data.items()):
    if name in ("stages","variables","image","services","default","include") or not isinstance(job, dict):
        continue

    j = {
      "runs-on": "ubuntu-latest",
      "env": default_env.copy(),
      "steps": [{"name":"Checkout","uses":"actions/checkout@v4"}]
    }
    j.update(job_image(job))
    j.update(job_services(job))
    j["steps"].extend(to_steps(job))

    js = job.get("stage")
    if js and stage_order:
        prev = [jn for jn, jj in data.items()
                if isinstance(jj, dict) and jj.get("stage") 
                and stage_order.get(jj.get("stage"),0) < stage_order.get(js,0)]
        if prev:
            j["needs"] = sorted(set(prev))

    only = job.get("only"); except_ = job.get("except")
    if only and isinstance(only, list):
        j["if"] = "github.event_name == 'push'"
    if except_ and isinstance(except_, list):
        j["if"] = "github.event_name != 'push'"

    workflow["jobs"][name] = j

out_dir = Path("migration_output")
out_dir.mkdir(exist_ok=True)
wf_path = Path(".github/workflows/migrated.yml")
wf_path.parent.mkdir(parents=True, exist_ok=True)
wf_path.write_text(yaml.safe_dump(workflow, sort_keys=False))

report = {
  "detected_stages": stages,
  "global_variables": default_env,
  "jobs_count": len(workflow["jobs"]),
  "workflow_path": str(wf_path)
}
Path("migration_output/report.json").write_text(json.dumps(report, indent=2))
print(json.dumps(report))
PY
          echo "ok=1" >> "$GITHUB_OUTPUT"

      - name: Upload migration report
        uses: actions/upload-artifact@v4
        with:
          name: ci-migration-report
          path: migration_output/report.json

      - name: Open PR with migrated workflow (optional)
        if: ${{ inputs.open_pr == 'true' }}
        shell: bash
        run: |
          set -euo pipefail
          echo "${GH_PAT}" | gh auth login --with-token
          BR="${{ inputs.target_branch }}"
          git config user.name           git config user.name  "ci-migrator"
          git config user.email "ci-migrator@users.noreply.github.com"
          git checkout -b "${BR}"
          git add .github/workflows/migrated.yml
          git commit -m "Add migrated GitHub Actions workflow from .gitlab-ci.yml"
          git push -u origin "${BR}"
