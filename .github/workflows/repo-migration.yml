
name: Stage 1 — Repo Migration (Commit/Tag/Branch/PR Sync)

on:
  workflow_dispatch:
    inputs:
      gl_url:
        description: "GitLab base URL (e.g., https://gitlab.com)"
        required: false
        type: string
      gl_project:
        description: "GitLab project path (group/subgroup/repo)"
        required: true
        type: string
      gh_owner:
        description: "GitHub owner/org"
        required: true
        type: string
      gh_repo:
        description: "GitHub repository name"
        required: true
        type: string
      auto_create_repo:
        description: "Auto-create destination repo if missing?"
        required: false
        default: "true"
        type: choice
        options: ["true", "false"]
      delete_dest_repo_first:
        description: "Delete destination repo first (DANGER)"
        required: false
        default: "false"
        type: choice
        options: ["true", "false"]
      migrate_prs:
        description: "Migrate Merge Requests → Pull Requests?"
        required: false
        default: "false"
        type: choice
        options: ["true", "false"]

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  # Required secrets
  GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
  GH_PAT:   ${{ secrets.GH_PAT }}

  # Optional variables
  VAR_GL_URL: ${{ vars.GL_URL }}

jobs:
  # ------------------------- PREPARE -------------------------
  prepare:
    runs-on: ubuntu-latest
    outputs:
      gl_url:        ${{ steps.out.outputs.gl_url }}
      gl_project:    ${{ steps.out.outputs.gl_project }}
      gh_owner:      ${{ steps.out.outputs.gh_owner }}
      gh_repo:       ${{ steps.out.outputs.gh_repo }}
      auto_create:   ${{ steps.out.outputs.auto_create }}
      delete_first:  ${{ steps.out.outputs.delete_first }}
      migrate_prs:   ${{ steps.out.outputs.migrate_prs }}
      workdir:       ${{ steps.out.outputs.workdir }}
    steps:
      - name: Validate inputs & secrets, expose outputs
        id: out
        shell: bash
        env:
          IN_GL_URL:   ${{ inputs.gl_url }}
          IN_GL_PROJ:  ${{ inputs.gl_project }}
          IN_GH_OWNER: ${{ inputs.gh_owner }}
          IN_GH_REPO:  ${{ inputs.gh_repo }}
          IN_AUTO:     ${{ inputs.auto_create_repo }}
          IN_DELETE:   ${{ inputs.delete_dest_repo_first }}
          IN_MPRS:     ${{ inputs.migrate_prs }}
          VAR_GL_URL:  ${{ vars.GL_URL }}
        run: |
          set -euo pipefail

          GL_URL="${IN_GL_URL:-${VAR_GL_URL:-https://gitlab.com}}"
          GL_PROJECT="${IN_GL_PROJ:-}"
          GH_OWNER="${IN_GH_OWNER:-}"
          GH_REPO="${IN_GH_REPO:-}"
          AUTO_CREATE="${IN_AUTO:-true}"
          DELETE_FIRST="${IN_DELETE:-false}"
          MIGRATE_PRS="${IN_MPRS:-false}"

          [[ -z "${GL_PROJECT}" ]] && { echo "ERROR: gl_project required"; exit 1; }
          [[ -z "${GH_OWNER}" || -z "${GH_REPO}" ]] && { echo "ERROR: gh_owner and gh_repo required"; exit 1; }
          [[ -z "${GL_TOKEN:-}" ]] && { echo "ERROR: Missing GITLAB_TOKEN"; exit 1; }
          [[ -z "${GH_PAT:-}"   ]] && { echo "ERROR: Missing GH_PAT"; exit 1; }

          {
            echo "gl_url=${GL_URL}"
            echo "gl_project=${GL_PROJECT}"
            echo "gh_owner=${GH_OWNER}"
            echo "gh_repo=${GH_REPO}"
            echo "auto_create=${AUTO_CREATE}"
            echo "delete_first=${DELETE_FIRST}"
            echo "migrate_prs=${MIGRATE_PRS}"
            echo "workdir=/tmp/mirror-work"
          } >> "$GITHUB_OUTPUT"

  # ------------------------- REPO ADMIN -------------------------
  repo_admin:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Delete destination repo (if requested)
        if: ${{ needs.prepare.outputs.delete_first == 'true' }}
        shell: bash
        env:
          GH_OWNER: ${{ needs.prepare.outputs.gh_owner }}
          GH_REPO:  ${{ needs.prepare.outputs.gh_repo }}
        run: |
          set -euo pipefail
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -X DELETE \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}")
          [[ "${STATUS}" == "204" || "${STATUS}" == "404" ]] || { echo "ERROR: Delete failed (HTTP ${STATUS})"; exit 1; }

      - name: Create repo if missing (if auto_create=true)
        if: ${{ needs.prepare.outputs.auto_create == 'true' }}
        shell: bash
        env:
          GH_OWNER: ${{ needs.prepare.outputs.gh_owner }}
          GH_REPO:  ${{ needs.prepare.outputs.gh_repo }}
        run: |
          set -euo pipefail
          REPO_API="https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" "${REPO_API}")
          if [[ "${STATUS}" != "200" ]]; then
            MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user | jq -r '.login')
            CREATE_URL=$([[ "${GH_OWNER}" == "${MY_LOGIN}" ]] && echo "https://api.github.com/user/repos" || echo "https://api.github.com/orgs/${GH_OWNER}/repos")
            CREATE_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${GH_PAT}" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"${GH_REPO}\",\"private\":true}" \
              "${CREATE_URL}")
            [[ "${CREATE_STATUS}" == "201" ]] || { echo "ERROR: Failed to create repo (HTTP ${CREATE_STATUS})"; exit 1; }
          fi

  # ------------------------- COMMIT SYNC (heads) -------------------------
  commit_sync:
    needs: [prepare, repo_admin]
    runs-on: ubuntu-latest
    outputs:
      mirror_path: ${{ steps.out.outputs.mirror_path }}
    steps:
      - name: Install git
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git

      - name: Clone source (mirror)
        id: out
        shell: bash
        env:
          GL_URL:     ${{ needs.prepare.outputs.gl_url }}
          GL_PROJECT: ${{ needs.prepare.outputs.gl_project }}
          WORKDIR:    ${{ needs.prepare.outputs.workdir }}
        run: |
          set -euo pipefail
          mkdir -p "${WORKDIR}"
          cd "${WORKDIR}"
          HOST="${GL_URL#*://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${GL_PROJECT}.git"
          git clone --mirror "${SRC_URL}" src.git
          echo "mirror_path=${WORKDIR}/src.git" >> "$GITHUB_OUTPUT"

      - name: Push branches (heads) only
        shell: bash
        env:
          GH_OWNER: ${{ needs.prepare.outputs.gh_owner }}
          GH_REPO:  ${{ needs.prepare.outputs.gh_repo }}
          MIRROR:   ${{ steps.out.outputs.mirror_path }}
        run: |
          set -euo pipefail
          cd "${MIRROR}"
          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          # Sync branches (prune deleted branches)
          git push --prune github +refs/heads/*:refs/heads/*

  # ------------------------- TAG SYNC (tags) -------------------------
  tag_sync:
    needs: [prepare, repo_admin, commit_sync]
    runs-on: ubuntu-latest
    steps:
      - name: Push tags only
        shell: bash
        env:
          GH_OWNER: ${{ needs.prepare.outputs.gh_owner }}
          GH_REPO:  ${{ needs.prepare.outputs.gh_repo }}
          MIRROR:   ${{ needs.commit_sync.outputs.mirror_path }}
        run: |
          set -euo pipefail
          cd "${MIRROR}"
          # Sync tags (prune deleted tags)
          git push --prune github +refs/tags/*:refs/tags/*

  # ------------------------- BRANCH SYNC (default/protections) -------------------------
  branch_sync:
    needs: [prepare, commit_sync, tag_sync]
    runs-on: ubuntu-latest
    steps:
      - name: Set default branch (optional)
        if: ${{ vars.DEFAULT_BRANCH != '' }}
        shell: bash
        env:
          GH_OWNER: ${{ needs.prepare.outputs.gh_owner }}
          GH_REPO:  ${{ needs.prepare.outputs.gh_repo }}
          DEFAULT_BRANCH: ${{ vars.DEFAULT_BRANCH }}
        run: |
          set -euo pipefail
          curl -s -o /dev/null -w "%{http_code}" \
            -X PATCH \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            -d "{\"default_branch\":\"${DEFAULT_BRANCH}\"}" \
            "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"

      - name: Apply branch protections (optional)
        if: ${{ vars.PROTECT_BRANCHES_JSON != '' }}
        shell: bash
        env:
          GH_OWNER: ${{ needs.prepare.outputs.gh_owner }}
          GH_REPO:  ${{ needs.prepare.outputs.gh_repo }}
          PROTECT_BRANCHES_JSON: ${{ vars.PROTECT_BRANCHES_JSON }}
        run: |
          set -euo pipefail
          echo "${PROTECT_BRANCHES_JSON}" | jq -c '.[]' | while read -r rule; do
            branch=$(jq -r '.branch' <<< "$rule")
            payload=$(jq -c 'del(.branch)' <<< "$rule")
            curl -s -o /dev/null -w "%{http_code}" \
              -X PUT \
              -H "Authorization: Bearer ${GH_PAT}" \
              -H "Accept: application/vnd.github+json" \
              -d "${payload}" \
              "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/branches/${branch}/protection"
            sleep 1
          done

  # ------------------------- PR SYNC (MR → PRs) -------------------------
  pr_sync:
    needs: [prepare, commit_sync, tag_sync]
    if: ${{ needs.prepare.outputs.migrate_prs == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Install jq & curl
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Migrate MRs → PRs (timeline comments)
        shell: bash
        env:
          GL_URL:     ${{ needs.prepare.outputs.gl_url }}
          GL_PROJECT: ${{ needs.prepare.outputs.gl_project }}
          GH_OWNER:   ${{ needs.prepare.outputs.gh_owner }}
          GH_REPO:    ${{ needs.prepare.outputs.gh_repo }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "${GL_PROJECT}" '$x|@uri')
          page=1
          while :; do
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "${HDR}" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/merge_requests?scope=all&per_page=100&page=${page}" > "${RESP}"

            jq -c '.[]' "${RESP}" | while read -r mr; do
              title=$(jq -r '.title' <<< "$mr")
              body=$(jq -r '.description // ""' <<< "$mr")
              state=$(jq -r '.state' <<< "$mr")        # opened | closed | merged
              labels=$(jq -c '.labels' <<< "$mr")
              source_branch=$(jq -r '.source_branch' <<< "$mr")
              target_branch=$(jq -r '.target_branch' <<< "$mr")
              author=$(jq -r '.author.username' <<< "$mr")
              gl_iid=$(jq -r '.iid' <<< "$mr")

              # Verify branches exist
              HEAD_OK=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" \
                "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/git/refs/heads/${source_branch}")
              BASE_OK=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" \
                "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/git/refs/heads/${target_branch}")
              if [[ "${HEAD_OK}" != "200" || "${BASE_OK}" != "200" ]]; then
                echo "Skip MR#${gl_iid}: missing head/base (${source_branch}→${target_branch})"
                continue
              fi

              CREATE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -H "Authorization: Bearer ${GH_PAT}" \
                -H "Accept: application/vnd.github+json" \
                -d "$(jq -n \
                      --arg title "$title" \
                      --arg body "**Imported from GitLab by @$author**\n\n$body" \
                      --arg head "$source_branch" \
                      --arg base "$target_branch" \
                      '{title:$title, body:$body, head:$head, base:$base}')" \
                "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/pulls")
              http=$(echo "$CREATE" | sed -n 's/^HTTP_STATUS://p')
              pr_num=$(echo "$CREATE" | sed '/^HTTP_STATUS:/d' | jq -r '.number // empty')
              echo "PR create status=${http} number=${pr_num}"

              if [[ -n "${pr_num}" && "${labels}" != "null" ]]; then
                curl -s -o /dev/null -w "%{http_code}" \
                  -H "Authorization: Bearer ${GH_PAT}" \
                  -H "Accept: application/vnd.github+json" \
                  -d "${labels}" \
                  "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${pr_num}/labels"
                sleep 1
              fi

              # Final state
              if [[ -n "${pr_num}" ]]; then
                if [[ "${state}" == "closed" ]]; then
                  curl -s -o /dev/null -w "%{http_code}" \
                    -X PATCH \
                    -H "Authorization: Bearer ${GH_PAT}" \
                    -H "Accept: application/vnd.github+json" \
                    -d '{"state":"closed"}' \
                    "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${pr_num}"
                elif [[ "${state}" == "merged" ]]; then
                  curl -s -o /dev/null -w "%{http_code}" \
                    -X PUT \
                    -H "Authorization: Bearer ${GH_PAT}" \
                    -H "Accept: application/vnd.github+json" \
                    -d '{"merge_method":"merge"}' \
                    "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/pulls/${pr_num}/merge"
                fi
                sleep 1
              fi

              # MR comments → PR timeline comments
              cpage=1
              while :; do
                CRESP=$(mktemp) ; CHDR=$(mktemp)
                curl -s -D "${CHDR}" \
                  -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                  "${GL_API}/projects/${GL_ENC}/merge_requests/${gl_iid}/notes?activity_filter=only_comments&per_page=100&page=${cpage}" > "${CRESP}"
                jq -c '.[]' "${CRESP}" | while read -r note; do
                  nbody=$(jq -r '.body' <<< "$note")
                  nauth=$(jq -r '.author.username' <<< "$note")
                  curl -s -o /dev/null -w "%{http_code}" \
                    -H "Authorization: Bearer ${GH_PAT}" \
                    -H "Accept: application/vnd.github+json" \
                    -d "$(jq -n --arg b "**@${nauth} (from GitLab)**\n\n${nbody}" '{body:$b}')" \
                    "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/issues/${pr_num}/comments"
                  sleep 1
                done
                nnext=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${CHDR}" | tr -d '\r')
                [[ -z "${nnext}" || "${nnext}" == "0" ]] && break
                cpage="${nnext}"
              done

            done

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')
            [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done

  # ------------------------- VALIDATION REPORT -------------------------
  validation_report:
    needs: [prepare, commit_sync, tag_sync]
    runs-on: ubuntu-latest
    steps:
      - name: Install tools
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y git jq

      - name: Compare refs (heads/tags) and upload report
        shell: bash
        env:
          GH_OWNER: ${{ needs.prepare.outputs.gh_owner }}
          GH_REPO:  ${{ needs.prepare.outputs.gh_repo }}
          MIRROR:   ${{ needs.commit_sync.outputs.mirror_path }}
        run: |
          set -euo pipefail
          cd "${MIRROR}"
          git ls-remote . 'refs/heads/*' > /tmp/src_heads.txt
          git ls-remote . 'refs/tags/*'  > /tmp/src_tags.txt
          git ls-remote "https://github.com/${GH_OWNER}/${GH_REPO}.git" 'refs/heads/*' > /tmp/dst_heads.txt
          git ls-remote "https://github.com/${GH_OWNER}/${GH_REPO}.git" 'refs/tags/*'  > /tmp/dst_tags.txt
          jq -n \
            --arg heads_src "$(wc -l < /tmp/src_heads.txt)" \
            --arg heads_dst "$(wc -l < /tmp/dst_heads.txt)" \
            --arg tags_src  "$(wc -l < /tmp/src_tags.txt)" \
            --arg            --arg tags_dst  "$(wc -l < /tmp/dst_tags.txt)" \
            '{heads:{src:$heads_src,dst:$heads_dst},tags:{src:$tags_src,dst:$tags_dst}}' \
            > /tmp/parity.json
          echo "Parity report:"
          cat /tmp/parity.json

      - name: Upload parity report artifact
        uses: actions/upload-artifact@v4
        with:
          name: parity-report
