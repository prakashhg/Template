
name: "GitLab â†’ GHCR / npm (org-internal, GHES-aware)"

on:
  workflow_call:

permissions:
  contents: write
  packages: write

env:
  GL_URL: ${{ vars.GL_URL }}
  GL_GROUP: ${{ vars.GL_GROUP }}
  GH_OWNER: ${{ vars.GH_OWNER }}

  REPO_NAME_MODE: ${{ vars.REPO_NAME_MODE }}
  GH_REPO_PREFIX: ${{ vars.GH_REPO_PREFIX }}
  GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}

  GL_REGISTRY: ${{ vars.GL_REGISTRY }}
  GH_NPM_SCOPE: ${{ vars.GH_NPM_SCOPE }}
  GHCR_USER: ${{ vars.GHCR_USER }}

  CURL_FLAGS: --http1.1 --retry 5 --retry-all-errors --connect-timeout 15 --max-time 120

jobs:
# ------------------------------------------------------------
# 1) DISCOVER PROJECTS
# ------------------------------------------------------------
  discover_projects:
    runs-on: ubuntu-latest
    outputs:
      project_list: ${{ steps.collect.outputs.project_list }}
    steps:
      - name: Install jq & curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - id: collect
        shell: bash
        env:
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          GROUP_ENC="$(jq -rn --arg x "$GL_GROUP" '$x|@uri')"

          page=1
          projects=()

          while :; do
            resp="$(mktemp)"
            hdr="$(mktemp)"

            code=$(curl -sS $CURL_FLAGS \
              -H "PRIVATE-TOKEN: $GL_TOKEN" \
              -D "$hdr" -w '%{http_code}' \
              "$GL_API/groups/$GROUP_ENC/projects?per_page=100&page=$page&include_subgroups=true" \
              -o "$resp")

            [[ "$code" == "200" ]] || break

            while read -r p; do
              path="$(jq -r '.path_with_namespace' <<< "$p")"
              projects+=("$path")
            done < <(jq -c '.[]' "$resp")

            next="$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$hdr" | tr -d '\r')"
            [[ -z "$next" || "$next" == "0" ]] && break
            page="$next"
          done

          printf '%s\n' "${projects[@]}" | jq -R . | jq -s -c . > projects.json
          echo "project_list=$(cat projects.json)" >> "$GITHUB_OUTPUT"

# ------------------------------------------------------------
# 2) CONTAINER IMAGE MIGRATION (FIXED)
# ------------------------------------------------------------
  ghcr_images:
    needs: discover_projects
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl skopeo

      - name: Login GHCR
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_USER: ${{ env.GHCR_USER || github.actor }}
        run: |
          set -e
          skopeo logout ghcr.io || true
          skopeo login ghcr.io --username "$GH_USER" --password-stdin <<< "$GH_PAT"

      - name: Copy images (FORCE SIZE FIX)
        shell: bash
        env:
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail

          GL_API="${GL_URL%/}/api/v4"
          ENC="$(jq -rn --arg x "${{ matrix.project }}" '$x|@uri')"

          repos=$(curl -s $CURL_FLAGS \
            -H "PRIVATE-TOKEN: $GL_TOKEN" \
            "$GL_API/projects/$ENC/registry/repositories")

          for r in $(jq -r '.[].id' <<< "$repos"); do
            tags=$(curl -s \
              -H "PRIVATE-TOKEN: $GL_TOKEN" \
              "$GL_API/projects/$ENC/registry/repositories/$r/tags" | jq -r '.[].name')

            for t in $tags; do
              SRC="docker://registry.gitlab.com/${{ matrix.project }}:$t"
              DEST="docker://ghcr.io/$GH_OWNER/$(basename ${{ matrix.project }}):$t"

              skopeo copy \
                --all \
                --preserve-digests=false \
                --dest-compress \
                --format oci \
                "$SRC" "$DEST" || \
                echo "::warning::Failed tag $t"
            done
          done

# ------------------------------------------------------------
# 3) NPM PACKAGES (FIXED SIZE)
# ------------------------------------------------------------
  npm_packages:
    needs: discover_projects
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}

    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Publish npm packages
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail

          echo "@$GH_OWNER:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=$GH_PAT" >> .npmrc

          pkg="$(basename ${{ matrix.project }})"

          versions=$(npm view "$pkg" versions --registry "${GL_URL%/}/api/v4/packages/npm/" --json || echo "[]")

          for v in $(jq -r '.[]' <<< "$versions"); do
            npm pack "$pkg@$v" --registry "${GL_URL%/}/api/v4/packages/npm/"
            tgz=$(ls *.tgz | tail -1)

            npm publish "$tgz"
          done
