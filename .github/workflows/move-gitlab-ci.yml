
name: Move GitLab CI file to GitHub Workflows (PR)

on:
  workflow_dispatch:  # Run manually from the Actions tab

permissions:
  contents: write       # create branch and commit
  pull-requests: write  # open PR

jobs:
  move-and-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect and move file
        id: detect_move
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ”Ž Looking for .gitlab-ci.yml or .gitlab-ci.yaml at repository root..."
          SRC=""
          [[ -f ".gitlab-ci.yml" ]] && SRC=".gitlab-ci.yml"
          [[ -z "${SRC}" && -f ".gitlab-ci.yaml" ]] && SRC=".gitlab-ci.yaml"

          if [[ -z "${SRC}" ]]; then
            echo "No GitLab CI file found at root. Exiting without changes."
            echo "noop=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mkdir -p .github/workflows
          TARGET=".github/workflows/gitlab-pipeline-legacy.yml"

          # If target exists and content is identical, do nothing
          if [[ -f "${TARGET}" ]] && cmp -s "${SRC}" "${TARGET}"; then
            echo "Target already exists with identical content. No changes required."
            echo "noop=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Use git mv if source is tracked; otherwise mv then add
          if git ls-files --error-unmatch "${SRC}" >/dev/null 2>&1; then
            git mv "${SRC}" "${TARGET}"
          else
            mv "${SRC}" "${TARGET}"
            git add "${TARGET}"
            git rm --cached "${SRC}" || true
          fi

          echo "noop=false" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: ${{ steps.detect_move.outputs.noop == 'false' }}
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ci/move-gitlab-ci-to-workflows
          commit-message: "Move .gitlab-ci to .github/workflows for later conversion"
          title: "Move .gitlab-ci to .github/workflows"
          body: |
            This PR moves the GitLab CI file into `.github/workflows/gitlab-pipeline-legacy.yml`.

            Notes:
            - The            - The file remains in **GitLab CI syntax** and will be converted later.
            - We use a PR instead of direct push to avoid protected-branch restrictions.
          labels: ["ci", "migration"]
