
name: Convert GitLab CI to GitHub Actions

on:
  workflow_dispatch:
    inputs:
      commit_result:
        description: "Commit converted workflow(s) back to the repo"
        required: true
        default: "true"

jobs:
  convert:
    runs-on: ubuntu-latest

    # Needed if we push changes
    permissions:
      contents: write

    # gh requires GH_TOKEN in env on Actions runners
    # (gh is preinstalled on ubuntu-latest)
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify .gitlab-ci.yml exists
        run: |
          if [ ! -f ".gitlab-ci.yml" ]; then
            echo "❌ .gitlab-ci.yml not found at the repo root."
            exit 1
          fi
          echo "✅ Found .gitlab-ci.yml"

      - name: Install GitHub Actions Importer CLI extension
        run: |
          gh --version
          gh auth status || true
          gh extension install github/gh-actions-importer
          gh actions-importer version

      - name: Convert GitLab CI to GitHub Actions
        # If your GitLab config references remote includes or requires API calls,
        # set GITLAB_TOKEN/GITLAB_HOST as env vars and pass --gitlab-* flags.
        run: |
          mkdir -p .github/workflows
          gh actions-importer migrate gitlab \
            --input .gitlab-ci.yml \
            --output .github/workflows

      - name: Show generated workflows
        run: |
          echo "Generated workflows under .github/workflows:"
          ls -la .github/workflows || true

      - name: Commit converted workflows
        if: ${{ inputs.commit_result == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

                   git add .github/workflows || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: convert GitLab CI to GitHub Actions via Importer"
            git push
