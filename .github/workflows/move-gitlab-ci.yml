
name: Setup GitHub Actions Importer

on:
  workflow_dispatch:

jobs:
  repo_migration_commit_sync:
    name: "1) Repo Migration · 1.1 Pipeline migration"
    runs-on: ubuntu-latest
    outputs:
      gl_url: ${{ steps.export.outputs.gl_url }}
      gl_project: ${{ steps.export.outputs.gl_project }}
      gh_owner: ${{ steps.export.outputs.gh_owner }}
      gh_repo: ${{ steps.export.outputs.gh_repo }}
      auto_create: ${{ steps.export.outputs.auto_create }}
      delete_first: ${{ steps.export.outputs.delete_first }}
      migrate_mrs: ${{ steps.export.outputs.migrate_mrs }}
      pr_url: ${{ steps.migrate.outputs.pr_url }}
    
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}
      VAR_GL_URL: ${{ vars.GL_URL }}
      VAR_GL_PROJECT: ${{ vars.GL_PROJECT }}
      VAR_GH_OWNER: ${{ vars.GH_OWNER }}
      VAR_GH_REPO: ${{ vars.GH_REPO }}
      VAR_AUTO_CREATE: ${{ vars.AUTO_CREATE_REPO }}
      VAR_DELETE_FIRST: ${{ vars.DELETE_DEST_REPO_FIRST }}
      VAR_MIGRATE_MRS: ${{ vars.MIGRATE_MRS }}
      GH_TOKEN: ${{ github.token }}
    
    steps:
      - name: Install tools with Docker
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl git
          gh auth status || true
          gh extension install github/gh-actions-importer
          set -euo pipefail
          docker --version
          gh --version 
          echo "${GH_PAT}" | gh auth login --with-token

      - name: "Step 2: Verify GH_PAT and repo existence via GitHub API"
        id: check_repo
        shell: bash
        run: |
          set -euo pipefail
          [[ -n "${GH_PAT:-}" ]] || { echo "❌ Missing GH_PAT secret (needs 'workflow' + 'repo' scopes)"; exit 1; }

          REPO_API="https://api.github.com/repos/${VAR_GH_OWNER}/${VAR_GH_REPO}"
          RESP="$(curl -s -H "Authorization: token ${GH_PAT}" -H "Accept: application/vnd.github+json" "${REPO_API}")"
          if echo "${RESP}" | jq -e '.message | select(.=="Not Found")' >/dev/null; then
            echo "❌ Repo not found: ${VAR_GH_OWNER}/${VAR_GH_REPO}"
            exit 1
          fi

          DEFAULT_BRANCH="$(echo "${RESP}" | jq -r '.default_branch')"
          [[ -n "${DEFAULT_BRANCH}" && "${DEFAULT_BRANCH}" != "null" ]] || DEFAULT_BRANCH="main"
          echo "default_branch=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "✅ Repo exists. Default branch: ${DEFAULT_BRANCH}"

      - name: "Step 2: Clone GitHub repo using GH_PAT"
        run: |
          set -euo pipefail
          WORKDIR="$(mktemp -d)"
          echo "WORKDIR=${WORKDIR}" >> "$GITHUB_ENV"
          REPO_URL="https://${GH_PAT}@github.com/${VAR_GH_OWNER}/${VAR_GH_REPO}.git"
          git clone "${REPO_URL}" "${WORKDIR}/repo"
          cd "${WORKDIR}/repo"
          echo "✅ Repo cloned."
