
name: Convert GitLab CI to GitHub Actions Workflow (No gh CLI)

on:
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  convert_gitlab_ci_to_github_actions:
    runs-on: ubuntu-latest

    env:
      GH_PAT: ${{ secrets.GH_PAT }}           # Must include repo + workflow scopes
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}   # Optional for importer
      VAR_GL_URL: ${{ vars.GL_URL }}
      VAR_GL_PROJECT: ${{ vars.GL_PROJECT }}
      VAR_GH_OWNER: ${{ vars.GH_OWNER }}
      VAR_GH_REPO: ${{ vars.GH_REPO }}
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: "Step 1: Install tools"
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y git curl jq
          docker --version || { echo "❌ Docker not available"; exit 1; }

      - name: "Step 2: Clone GitHub repo using GH_PAT"
        run: |
          set -euo pipefail
          WORKDIR="$(mktemp -d)"
          echo "WORKDIR=${WORKDIR}" >> "$GITHUB_ENV"
          REPO_URL="https://${GH_PAT}@github.com/${VAR_GH_OWNER}/${VAR_GH_REPO}.git"
          git clone "${REPO_URL}" "${WORKDIR}/repo"
          cd "${WORKDIR}/repo"
          echo "✅ Repo cloned."

      - name: "Step 3: Detect .gitlab-ci.yml"
        id: detect
        run: |
          set -euo pipefail
          REPO_DIR="${WORKDIR}/repo"
          if [[ -f "${REPO_DIR}/.gitlab-ci.yml" ]]; then
            echo "gitlab_ci_path=${REPO_DIR}/.gitlab-ci.yml" >> "$GITHUB_OUTPUT"
            echo "✅ Found .gitlab-ci.yml"
          else
            echo "gitlab_ci_path=" >> "$GITHUB_OUTPUT"
            echo "ℹ️ No .gitlab-ci.yml found; exiting."
            exit 0
          fi

      - name: "Step 4: Run GitHub Actions Importer via Docker"
        if: ${{ steps.detect.outputs.gitlab_ci_path != '' }}
        run: |
          set -euo pipefail
          SRC="${{ steps.detect.outputs.gitlab_ci_path }}"
          OUTDIR="${WORKDIR}/converted"
          mkdir -p "${OUTDIR}"
          docker run --rm \
            -e GITHUB_ACCESS_TOKEN="${GH_PAT}" \
            -e GITLAB_ACCESS_TOKEN="${GL_TOKEN}" \
            -e GITHUB_INSTANCE_URL="https://github.com" \
            -e GITLAB_INSTANCE_URL="${VAR_GL_URL:-https://gitlab.com}" \
            -v "${WORKDIR}/repo:/repo" \
            -v "${OUTDIR}:/output" \
            ghcr.io/github/gh-actions-importer:latest \
            migrate gitlab \
            --source-file-path "/repo/.gitlab-ci.yml" \
            --output-dir "/output" \
            --namespace "local" \
            --project "local"
          echo "✅ Conversion complete. Files in ${OUTDIR}:"
          ls -la "${OUTDIR}"

      - name: "Step 5: Commit converted workflow and push branch"
        if: ${{ steps.detect.outputs.gitlab_ci_path != '' }}
        run: |
          set -euo pipefail
          cd "${WORKDIR}/repo"
          mkdir -p .github/workflows
          cp "${WORKDIR}/converted"/*.yml .github/workflows/
          git config user.name "actions-bot"
          git config user.email "actions@users.noreply.github.com"
          BRANCH="ci-migration-$(date +%s)"
          git checkout -b "${BRANCH}"
          git add .github/workflows
          git commit -m "Add converted GitHub Actions workflow from .gitlab-ci.yml"
          git push origin "${BRANCH}"

      - name: "Step 6: Open PR via GitHub API"
        if: ${{ steps.detect.outputs.gitlab_ci_path != '' }}
        run: |
          set -euo pipefail
          API="https://api.github.com/repos/${VAR_GH_OWNER}/${VAR_GH_REPO}/pulls"
          DATA=$(jq -n \
            --arg title "Convert .gitlab-ci.yml to GitHub Actions" \
            --arg head "${BRANCH}" \
            --arg base "main" \
            --arg body "This PR adds a workflow converted from .gitlab-ci.yml using GitHub Actions Importer." \
            '{title:$title, head:$head, base:$base, body:$body}')
          curl -s -X POST -H "Authorization: token ${GH_PAT}" \
            -H "Accept: application/vnd.github.v3+json" \
            "${API}" -d "${DATA}"
          echo "✅ PR
