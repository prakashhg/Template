
name: Migrate GitLab CI to GitHub Actions

on:
  workflow_dispatch:
    inputs:
      commit_result:
        description: "Commit converted workflow to repo"
        required: true
        default: "true"

jobs:
  migrate:
    runs-on: ubuntu-latest

    # Needed for committing/pushing the generated workflows
    permissions:
      contents: write

    # Make GH_TOKEN available to all steps that use gh
    env:
      GH_TOKEN: ${{ github.token }} # or set to ${{ secrets.GH_PAT }} if you must use a PAT

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # gh is preinstalled on GitHub-hosted runners; this verifies auth and installs the extension
      - name: Install GitHub Actions Importer extension
        run: |
          gh --version
          gh auth status || true
          gh extension install github/gh-actions-importer
          gh actions-importer version

      - name: Verify GitLab CI file exists
        run: |
          if [ ! -f ".gitlab-ci.yml" ]; then
            echo "❌ .gitlab-ci.yml not found"
            exit 1
          fi
          echo "✅ Found .gitlab-ci.yml"

      - name: Convert GitLab CI to GitHub Actions
        env:
          # GH_TOKEN comes from job env above
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_HOST: ${{ secrets.GITLAB_HOST }} # e.g., gitlab.example.com
        run: |
          gh actions-importer migrate gitlab \
            --input .gitlab-ci.yml \
            --output .github/workflows \
            --gitlab-access-token "${GITLAB_TOKEN}" \
            --gitlab-server-url "https://${GITLAB_HOST}"

      - name: List converted workflows
        run: |
          echo "Generated workflows:"
          ls -la .github/workflows || true

      - name: Commit converted workflow
        if: ${{ inputs.commit_result == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add .github/workflows || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: migrate GitLab CI to GitHub Actions"
            git push
         
