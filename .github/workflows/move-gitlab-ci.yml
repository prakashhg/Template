name: Setup GitHub Actions Importer (REST-only, no gh/no Docker)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  repo_migration_commit_sync:
    name: "1) Repo Migration · 1.1 Pipeline migration"
    runs-on: ubuntu-latest

    outputs:
      gl_url: ${{ steps.export.outputs.gl_url }}
      gl_project: ${{ steps.export.outputs.gl_project }}
      gh_owner: ${{ steps.export.outputs.gh_owner }}
      gh_repo: ${{ steps.export.outputs.gh_repo }}
      auto_create: ${{ steps.export.outputs.auto_create }}
      delete_first: ${{ steps.export.outputs.delete_first }}
      migrate_mrs: ${{ steps.export.outputs.migrate_mrs }}
      pr_url: ${{ steps.open_pr.outputs.pr_url }}

    env:
      # Secrets
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}

      # Vars (exactly as you asked)
      VAR_GL_URL:       ${{ vars.GL_URL }}
      VAR_GL_PROJECT:   ${{ vars.GL_PROJECT }}
      VAR_GH_OWNER:     ${{ vars.GH_OWNER }}
      VAR_GH_REPO:      ${{ vars.GH_REPO }}
      VAR_AUTO_CREATE:  ${{ vars.AUTO_CREATE_REPO }}
      VAR_DELETE_FIRST: ${{ vars.DELETE_DEST_REPO_FIRST }}
      VAR_MIGRATE_MRS:  ${{ vars.MIGRATE_MRS }}

      # Built-in token not used, but may be present
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: "Step 0: Install tools"
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y git curl jq python3 python3-pip
          python3 -m pip install --user PyYAML

      - name: "Step 1: Export & normalize inputs"
        id: export
        shell: bash
        run: |
          set -euo pipefail
          norm_bool() {
            case "$(echo "${1:-}" | tr '[:upper:]' '[:lower:]')" in
              true|1|yes|y) echo "true" ;;
              false|0|no|n|"") echo "false" ;;
              *) echo "false" ;;
            esac
          }
          AUTO_CREATE="$(norm_bool "${VAR_AUTO_CREATE:-false}")"
          DELETE_FIRST="$(norm_bool "${VAR_DELETE_FIRST:-false}")"
          MIGRATE_MRS="$(norm_bool "${VAR_MIGRATE_MRS:-false}")"

          missing=()
          [[ -z "${VAR_GH_OWNER:-}" ]] && missing+=("VAR_GH_OWNER")
          [[ -z "${VAR_GH_REPO:-}"  ]] && missing+=("VAR_GH_REPO")
          [[ -z "${GH_PAT:-}"       ]] && missing+=("GH_PAT secret (repo+workflow scopes)")

          if [[ "${#missing[@]}" -gt 0 ]]; then
            echo "❌ Missing inputs: ${missing[*]}"; exit 1
          fi

          {
            echo "gl_url=${VAR_GL_URL}"
            echo "gl_project=${VAR_GL_PROJECT}"
            echo "gh_owner=${VAR_GH_OWNER}"
            echo "gh_repo=${VAR_GH_REPO}"
            echo "auto_create=${AUTO_CREATE}"
            echo "delete_first=${DELETE_FIRST}"
            echo "migrate_mrs=${MIGRATE_MRS}"
          } >> "$GITHUB_OUTPUT"

      - name: "Step 2: Verify repo via GitHub REST API"
        id: check_repo
        shell: bash
        run: |
          set -euo pipefail
          REPO_API="https://api.github.com/repos/${VAR_GH_OWNER}/${VAR_GH_REPO}"

          # Recommended headers per GitHub REST docs
          RESP="$(curl -s \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${REPO_API}")"

          if echo "${RESP}" | jq -e '.message | select(.=="Not Found")' >/dev/null; then
            echo "❌ Repo not found: ${VAR_GH_OWNER}/${VAR_GH_REPO}"
            exit 1
          fi

          DEFAULT_BRANCH="$(echo "${RESP}" | jq -r '.default_branch')"
          [[ -n "${DEFAULT_BRANCH}" && "${DEFAULT_BRANCH}" != "null" ]] || DEFAULT_BRANCH="main"
          echo "default_branch=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "✅ Repo exists. Default branch: ${DEFAULT_BRANCH}"
          # Docs: Repos & default_branch: GET /repos/{owner}/{repo}
          # https://docs.github.com/en/rest/repos/repos#get-a-repository
          # https://docs.github.com/en/rest/repos
          # cite citations: turn14search42

      - name: "Step 3: Clone repo via GH_PAT"
        shell: bash
        run: |
          set -euo pipefail
          WORKDIR="$(mktemp -d)"
          echo "WORKDIR=${WORKDIR}" >> "$GITHUB_ENV"

          REPO_URL="https://${GH_PAT}@github.com/${VAR_GH_OWNER}/${VAR_GH_REPO}.git"
          git clone "${REPO_URL}" "${WORKDIR}/repo"
          cd "${WORKDIR}/repo"
          git checkout "${{ steps.check_repo.outputs.default_branch }}"
          echo "✅ Repo cloned to ${WORKDIR}/repo"
