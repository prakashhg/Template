name: Mirroring (GitLab → GitHub) + Trackers migration [Production]

on:
  push:
  delete:
  workflow_dispatch: {}    # no inputs - you trigger it manually if needed

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # 1) Repo Migration · 1.1 Commit Sync
  repo_migration_commit_sync:
    name: "1) Repo Migration · 1.1 Commit Sync"
    runs-on: ubuntu-latest

    outputs:
      gl_url: ${{ steps.export.outputs.gl_url }}
      gl_project: ${{ steps.export.outputs.gl_project }}
      gh_owner: ${{ steps.export.outputs.gh_owner }}
      gh_repo: ${{ steps.export.outputs.gh_repo }}
      auto_create: ${{ steps.export.outputs.auto_create }}
      delete_first: ${{ steps.export.outputs.delete_first }}
      migrate_mrs: ${{ steps.export.outputs.migrate_mrs }}

    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT: ${{ secrets.GH_PAT }}

      # Only from repository/environment variables (vars)
      VAR_GL_URL: ${{ vars.GL_URL }}
      VAR_GL_PROJECT: ${{ vars.GL_PROJECT }}
      VAR_GH_OWNER: ${{ vars.GH_OWNER }}
      VAR_GH_REPO: ${{ vars.GH_REPO }}
      VAR_AUTO_CREATE: ${{ vars.AUTO_CREATE_REPO }}
      VAR_DELETE_FIRST: ${{ vars.DELETE_DEST_REPO_FIRST }}
      VAR_MIGRATE_MRS: ${{ vars.MIGRATE_MRS }}

    steps:
      - name: Show repository context
        run: |
          echo "Repo : $GITHUB_REPOSITORY"
          echo "Ref  : $GITHUB_REF"
          echo "SHA  : $GITHUB_SHA"

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Locate .gitlab-ci file(s)
        id: locate
        shell: bash
        run: |
          set -euo pipefail
          mapfile -t FILES < <(find . -type f \( \
              -name ".gitlab-ci.yml" -o \
              -name ".gitlab-ci.yaml" -o \
              -name ".gitlab-ci" \
            \) -print)

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "❌ No .gitlab-ci file found anywhere in the repository."
            echo "Searched: .gitlab-ci.yml, .gitlab-ci.yaml, .gitlab-ci"
            exit 1
          fi

          echo "✅ Found ${#FILES[@]} GitLab CI file(s):"
          for f in "${FILES[@]}"; do echo " - ${f}"; done

          # Prefer root-level file if present; else first match
          pick() { [ -f "$1" ] && echo "$1"; }
          PREFERRED="$(pick ./.gitlab-ci.yml || pick ./.gitlab-ci.yaml || pick ./.gitlab-ci || echo "")"
          if [ -z "$PREFERRED" ]; then PREFERRED="${FILES[0]}"; fi
          echo "Using pipeline file: $PREFERRED"
          echo "pipeline_path=$PREFERRED" >> "$GITHUB_OUTPUT"

      - name: Install GitHub Actions Importer CLI extension
        run: |
          gh --version
          gh auth status || true
          gh extension install github/gh-actions-importer
          gh actions-importer version

      - name: Convert GitLab CI to GitHub Actions
        run: |
          mkdir -p .github/workflows
          gh actions-importer migrate gitlab \
            --input "${{ steps.locate.outputs.pipeline_path }}" \
            --output .github/workflows

      - name: Show generated workflows
        run: |
          echo "Generated workflows under .github/workflows:"
          ls -la .github/workflows || true

      - name: Commit converted workflows
        if: ${{ inputs.commit_result == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .github/workflows || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: convert GitLab CI to GitHub Actions via Importer"
            git push
