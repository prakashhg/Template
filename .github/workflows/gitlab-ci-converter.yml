
name: Mirroring (GitLab → GitHub) + Trackers migration [Group-wide, gh-based]

on:
  workflow_dispatch: {}
  push:
  delete:

permissions:
  contents: write
  issues: write
  pull-requests: write

env:
  # Common: let gh read repo target via GH_REPO or --repo
  GH_HOST: github.com

jobs:
  # 1) Discover projects under the GitLab group (includes subgroups)
  discover_projects:
    name: "1) Discover GitLab projects for conversion"
    runs-on: ubuntu-latest
    outputs:
      project_list: ${{ steps.collect.outputs.project_list }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GL_URL:   ${{ vars.GL_URL }}
      GL_GROUP: ${{ vars.GL_GROUP }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install jq & curl
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl
      - name: Collect & filter projects under GL_GROUP
        id: collect
        shell: bash
        run: |
          set -euo pipefail
          : "${GL_URL:?GL_URL is required}"
          : "${GL_GROUP:?GL_GROUP is required}"
          GL_API="${GL_URL%/}/api/v4"
          GROUP_ENC=$(jq -rn --arg x "${GL_GROUP}" '$x|@uri')
          REPO_NAME_MODE="${REPO_NAME_MODE:-path}"
          GH_REPO_PREFIX="${GH_REPO_PREFIX:-}"
          GH_REPO_SEPARATOR="${GH_REPO_SEPARATOR:-"-"}"

          page=1
          filtered=()
          while true; do
            RESP=$(mktemp) ; HDR=$(mktemp)
            curl -s -D "${HDR}" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/groups/${GROUP_ENC}/projects?per_page=100&page=${page}&include_subgroups=true" > "${RESP}"
            while read -r proj; do
              path=$(jq -r '.path_with_namespace' <<<"${proj}")
              [[ -n "${path}" ]] || continue
              if [[ "${REPO_NAME_MODE}" == "fullpath" ]]; then
                base="$(echo "${path}" | tr '/' "${GH_REPO_SEPARATOR}")"
              else
                base="${path##*/}"
              fi
              dest="${GH_REPO_PREFIX}${base}"
              if [[ "${dest}" == deletion_scheduled-* || "${dest}" == *deletion_scheduled-* ]]; then
                echo "Exclude deletion-scheduled: ${dest}"
              else
                filtered+=("${path}")
              fi
            done < <(jq -c '.[]' "${RESP}")
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')
            [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done
          json=$(printf '%s\n' "${filtered[@]:-}" | jq -R . | jq -s -c .)
          echo "project_list=${json}" >> "$GITHUB_OUTPUT"

  # 2) Repo Migration · 1.1 Commit Sync (mirror)
  repo_migration_commit_sync_all:
    name: "2) Repo Migration · 1.1 Commit Sync (ALL projects)"
    needs: discover_projects
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
      AUTO_CREATE:       ${{ vars.AUTO_CREATE_REPO }}
      INIT_IF_EMPTY_DEST: ${{ vars.INIT_IF_EMPTY_DEST }}
      WORKDIR: /tmp/mirror-work
    steps:
      - name: Install jq, curl, git, git-lfs
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl git git-lfs
          git lfs install

      - name: Compute destination repo name
        id: repo
        env: 
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          GH_REPO="${PREF}${base}"
          echo "gh_repo=${GH_REPO}" >> "$GITHUB_OUTPUT"

      - name: Skip if destination repo is deletion-scheduled
        env: 
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          [[ "${GH_REPO}" == deletion_scheduled-* || "${GH_REPO}" == *deletion_scheduled-* ]] && { echo "Skipping ${GH_REPO}"; exit 0; }

      - name: Prepare GitLab API (safe encoding)
        id: glapi
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "${GL_PROJECT}" '$x|@uri')
          echo "GL_API=${GL_API}" >> "$GITHUB_ENV"
          echo "GL_ENC=${GL_ENC}" >> "$GITHUB_ENV"

      - name: Check GitLab source branches (non-fatal)
        id: srcbranches
        run: |
          set -euo pipefail
          RESP=$(mktemp)
          if ! curl --fail-with-body -s -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                "${GL_API}/projects/${GL_ENC}/repository/branches?per_page=1" > "${RESP}"; then
            echo "has_branches=false" >> "$GITHUB_OUTPUT"; exit 0
          fi
          [[ "$(jq -r 'type' "${RESP}")" == "array" && "$(jq 'length' "${RESP}")" -ge 1 ]] \
            && echo "has_branches=true" >> "$GITHUB_OUTPUT" || echo "has_branches=false" >> "$GITHUB_OUTPUT"

      - name: Ensure GitHub repo exists (create if missing; no deletions)
        if: env.AUTO_CREATE == 'true'
        env:
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          API="https://api.github.com/repos/${GH_OWNER}/${GH_REPO}"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" "${API}")
          if [[ "${STATUS}" != "200" ]]; then
            MY_LOGIN=$(curl -s -H "Authorization: Bearer ${GH_PAT}" https://api.github.com/user | jq -r '.login')
            CREATE_URL=$([ "${GH_OWNER}" = "${MY_LOGIN}" ] && echo "https://api.github.com/user/repos" || echo "https://api.github.com/orgs/${GH_OWNER}/repos")
            PAYLOAD=$(jq -n --arg name "${GH_REPO}" '{name:$name, private:true, has_issues:true, has_projects:true, has_wiki:true}')
            HTTP=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer ${GH_PAT}" -H "Content-Type: application/json" -d "${PAYLOAD}" "${CREATE_URL}")
            [[ "${HTTP}" == "201" ]] || { echo "Create failed ${HTTP}"; exit 1; }
          fi

      - name: Clone GitLab --mirror and push to GitHub
        if: steps.srcbranches.outputs.has_branches == 'true'
        env: 
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          mkdir -p "${WORKDIR}"; cd "${WORKDIR}"
          HOST="${GL_URL#*://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${{ matrix.project }}.git"
          git clone --mirror "${SRC_URL}" src.git
          cd src.git
          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"
          git remote add github "${PUSH_URL}"
          git push --mirror github
          git lfs fetch --all || true
          git lfs push --all github || true

      - name: Verify branches exist in destination after mirror
        if: steps.srcbranches.outputs.has_branches == 'true'
        env: 
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          BR="$(curl -s -H "Authorization: Bearer ${GH_PAT}" "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/branches?per_page=1")"
          [[ "$(jq 'length' <<< "${BR}")" -ge 1 ]] || { echo "No branches found"; exit 1; }

      - name: Optionally initialize destination if source is empty
        if: steps.srcbranches.outputs.has_branches != 'true' && env.INIT_IF_EMPTY_DEST == 'true'
        env:
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          DEFAULT_BRANCH="main"
          PINFO=$(mktemp)
          curl --fail-with-body -s -H "PRIVATE-TOKEN: ${GL_TOKEN}" "${GL_API}/projects/${GL_ENC}" > "${PINFO}" && \
            DEFAULT_BRANCH=$(jq -r '.default_branch // "main"' "${PINFO}")
          CONTENT=$(printf '# %s\n\nInitialized because GitLab source contained no branches.\n' "${GH_REPO}" | base64 -w0)
          curl -s -o /dev/null -w "%{http_code}" \
            -X PUT -H "Authorization: Bearer ${GH_PAT}" -H "Accept: application/vnd.github+json" -H "Content-Type: application/json" \
            -d "$(jq -n --arg msg "Initialize ${DEFAULT_BRANCH}" --arg content "${CONTENT}" --arg branch "${DEFAULT_BRANCH}" \
                      '{message:$msg, content:$content, branch:$branch}')" \
            "https://api.github.com/repos/${GH_OWNER}/${GH_REPO}/contents/README.md" >/dev/null

  # 3) Tag sync (unchanged; git is simplest)
  repo_migration_tag_sync_all:
    name: "3) Repo Migration · 1.2 Tag Sync (ALL projects)"
    needs: [discover_projects, repo_migration_commit_sync_all]
    runs-on: ubuntu-latest
    strategy: { fail-fast: false, max-parallel: 6, 
    matrix: { project: ${{ fromJson(needs.discover_projects.outputs.project_list) }} } }
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE: ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX: ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
      WORKDIR: /tmp/mirror-work
    steps:
      - name: Install git
        run: sudo apt-get update -y && sudo apt-get install -y git
      - name: Compute destination repo name
        id: repo
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          echo "gh_repo=${PREF}${base}" >> "$GITHUB_OUTPUT"
      - name: Skip tag sync if source has no branches
        run: |
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "${{ matrix.project }}" '$x|@uri')
          RESP=$(curl -s -H "PRIVATE-TOKEN: ${GL_TOKEN}" "${GL_API}/projects/${GL_ENC}/repository/branches?per_page=1")
          [[ "$(jq -r 'type' <<< "${RESP}")" == "array" && "$(jq 'length' <<< "${RESP}")" -ge 1 ]] || { echo "Skip"; exit 0; }
      - name: Fetch tags from GitLab and push to GitHub
        env: 
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          mkdir -p "${WORKDIR}"; cd "${WORKDIR}"
          HOST="${GL_URL#*://}"
          SRC_URL="https://oauth2:${GL_TOKEN}@${HOST}/${{ matrix.project }}.git"
          [[ -d src.git ]] || git clone --mirror "${SRC_URL}" src.git
          cd src.git
          git fetch --tags origin
          PUSH_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.git"
          git remote remove github 2>/dev/null || true
          git remote add github "${PUSH_URL}"
          git push --tags github

  # 4) MR → PR sync using gh (replaces raw REST calls)
  repo_migration_pr_sync_all:
    name: "4) Repo Migration · 1.3 PR Sync (MR → PR) (ALL projects, gh)"
    needs: [discover_projects, repo_migration_commit_sync_all]
    if: ${{ vars.MIGRATE_MRS == 'true' }}
    runs-on: ubuntu-latest
    strategy: { fail-fast: false, max-parallel: 3, matrix: { project: ${{ fromJson(needs.discover_projects.outputs.project_list) }} } }
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install jq, curl, gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          if ! command -v gh >/dev/null 2>&1; then
            type -p curl >/dev/null || sudo apt-get install -y curl
            sudo apt-get install -y gnupg
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
            sudo apt-get update -y && sudo apt-get install -y gh
          fi
      - name: gh auth
        env: 
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "${GH_PAT}" | gh auth login --with-token --hostname "${GH_HOST}"
          gh auth status
      - name: Compute GH_REPO
        id: repo
        env: 
          GL_PROJECT: ${{ matrix.project }}
        run: |
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          echo "gh_repo=${PREF}${base}" >> "$GITHUB_OUTPUT"
      - name: Create PRs from GitLab MRs
        env:
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "${{ matrix.project }}" '$x|@uri')
          page=1
          while true; do
            RESP=$(mktemp); HDR=$(mktemp)
            curl -s -D "${HDR}" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/merge_requests?scope=all&per_page=100&page=${page}" > "${RESP}"
            [[ "$(jq -r 'type' "${RESP}")" == "array" ]] || break
            jq -c '.[]' "${RESP}" | while read -r mr; do
              title=$(jq -r '.title' <<<"${mr}")
              body=$(jq -r '.description // ""' <<<"${mr}")
              state=$(jq -r '.state' <<<"${mr}")
              head=$(jq -r '.source_branch' <<<"${mr}")
              base=$(jq -r '.target_branch' <<<"${mr}")
              author=$(jq -r '.author.username' <<<"${mr}")
              pr_body="**Imported from GitLab by @${author}**\n\n${body}"

              # Create PR via gh
              gh pr create --repo "${GH_OWNER}/${GH_REPO}" --head "${head}" --base "${base}" \
                --title "${title}" --body "${pr_body}" --draft=false || true  # skip if exists

              # Optionally, auto-merge if MR was merged (may fail if not mergeable)
              if [[ "${state}" == "merged" ]]; then
                gh pr list --repo "${GH_OWNER}/${GH_REPO}" --search "${title}" --limit 1 --json number \
                  | jq -r '.[0].number // empty' | while read -r num; do
                      [[ -n "${num}" ]] && gh pr merge "${num}" --repo "${GH_OWNER}/${GH_REPO}" --merge --auto || true
                    done
              fi
            done
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r'); [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done
      # Notes: `gh pr create` supports --repo/--head/--base/--title/--body. [6](https://cli.github.com/manual/gh_pr_create)

  # 5) Label sync (use `gh label` instead of raw REST)
  repo_migration_label_sync_all:
    name: "5) Repo Migration · 1.4 Label Sync (gh)"
    needs: [discover_projects]
    runs-on: ubuntu-latest
    strategy: { fail-fast: false, max-parallel: 6, matrix: { project: ${{ fromJson(needs.discover_projects.outputs.project_list) }} } }
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install jq, curl, gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get install -y gnupg
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
            sudo apt-get update -y && sudo apt-get install -y gh
          fi
      - name: gh auth
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "${GH_PAT}" | gh auth login --with-token --hostname "${GH_HOST}"
      - name: Compute GH_REPO
        id: repo
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          echo "gh_repo=${PREF}${base}" >> "$GITHUB_OUTPUT"
      - name: Migrate labels (GitLab → GitHub via gh)
        env: 
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"; GL_ENC=$(jq -rn --arg x "${{ matrix.project }}" '$x|@uri')
          page=1
          while true; do
            RESP=$(mktemp); HDR=$(mktemp)
            curl -s -D "${HDR}" -H "PRIVATE-TOKEN: ${GL_TOKEN}" "${GL_API}/projects/${GL_ENC}/labels?per_page=100&page=${page}" > "${RESP}"
            [[ "$(jq -r 'type' "${RESP}")" == "array" ]] || break
            jq -r '.[] | @base64' "${RESP}" | while read -r row; do
              _jq(){ echo "${row}" | base64 -d | jq -r "${1}"; }
              name=$(_jq '.name'); color=$(_jq '.color' | sed 's/^#//'); desc=$(_jq '.description // empty')
              gh label create "${name}" --repo "${GH_OWNER}/${GH_REPO}" --color "${color}" --description "${desc}" --force || true
            done
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r'); [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done
          # `gh label create --force` creates or updates. [1](https://cli.github.com/manual/gh_label_create)

  # 6) Milestone sync (use gh api)
  repo_migration_milestone_sync_all:
    name: "6) Repo Migration · 1.5 Milestone Sync (gh api)"
    needs: [discover_projects, repo_migration_label_sync_all]
    runs-on: ubuntu-latest
    strategy: { fail-fast: false, max-parallel: 6, matrix: { project: ${{ fromJson(needs.discover_projects.outputs.project_list) }} } }
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install jq, curl, gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get install -y gnupg
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
            sudo apt-get update -y && sudo apt-get install -y gh
          fi
      - name: gh auth
        env:  
          GH_PAT: ${{ secrets.GH_PAT }}
        run: echo "${GH_PAT}" | gh auth login --with-token --hostname "${GH_HOST}"
      - name: Compute GH_REPO
        id: repo
        env: { GL_PROJECT: ${{ matrix.project }} }
        run: |
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          echo "gh_repo=${PREF}${base}" >> "$GITHUB_OUTPUT"
      - name: Migrate milestones via gh api
        env: 
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"; GL_ENC=$(jq -rn --arg x "${{ matrix.project }}" '$x|@uri')
          page=1
          while true; do
            RESP=$(mktemp); HDR=$(mktemp)
            curl -s -D "${HDR}" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/milestones?per_page=100&page=${page}" > "${RESP}"
            [[ "$(jq -r 'type' "${RESP}")" == "array" ]] || break
            jq -c '.[]' "${RESP}" | while read -r ms; do
              title=$(jq -r '.title' <<<"${ms}")
              desc=$(jq -r '.description // ""' <<<"${ms}")
              due=$(jq -r '.due_date // empty' <<<"${ms}")
              # GitHub API: POST /repos/{owner}/{repo}/milestones (due_on expects ISO8601; use midnight Z if only date) [4](https://docs.github.com/en/rest/issues)
              if [[ -n "${due}" ]]; then due="${due}T00:00:00Z"; fi
              gh api --method POST \
                "repos/${GH_OWNER}/${GH_REPO}/milestones" \
                -f title="${title}" -f description="${desc}" ${due:+-f due_on="${due}"} >/dev/null || true
            done
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r'); [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done
          # `gh api` is the generic authenticated wrapper for REST calls. [3](https://cli.github.com/manual/gh_api)

  # 6a) Issues + comments (gh api + gh issue comment)
  repo_migration_issue_sync_all:
    name: "6a) Repo Migration · 1.6 Issue Sync (gh api + gh issue comment)"
    needs: [discover_projects, repo_migration_label_sync_all, repo_migration_milestone_sync_all]
    runs-on: ubuntu-latest
    strategy: { fail-fast: false, max-parallel: 4, matrix: { project: ${{ fromJson(needs.discover_projects.outputs.project_list) }} } }
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
    steps:
      - name: Install jq, curl, gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get install -y gnupg
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
            sudo apt-get update -y && sudo apt-get install -y gh
          fi
      - name: gh auth
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: echo "${GH_PAT}" | gh auth login --with-token --hostname "${GH_HOST}"
      - name: Compute GH_REPO & preload milestones (title→number)
        id: prep
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          GH_REPO="${PREF}${base}"
          echo "gh_repo=${GH_REPO}" >> "$GITHUB_OUTPUT"
          gh api "repos/${GH_OWNER}/${GH_REPO}/milestones?state=all&per_page=100" | \
            jq -c 'map({( .title ): .number})|add//{}' | \
            sed 's/.*/ms_map=&/' >> "$GITHUB_OUTPUT"
      - name: Import issues
        env:
          GH_REPO: ${{ steps.prep.outputs.gh_repo }}
          MS_MAP:  ${{ steps.prep.outputs.ms_map }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"; GL_ENC=$(jq -rn --arg x "${{ matrix.project }}" '$x|@uri')
          page=1
          while true; do
            RESP=$(mktemp); HDR=$(mktemp)
            curl -s -D "${HDR}" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/issues?scope=all&per_page=100&page=${page}" > "${RESP}"
            [[ "$(jq -r 'type' "${RESP}")" == "array" ]] || break
            jq -c '.[]' "${RESP}" | while read -r iss; do
              title=$(jq -r '.title' <<<"${iss}")
              body=$(jq -r '.description // ""' <<<"${iss}")
              state=$(jq -r '.state' <<<"${iss}")
              labels=$(jq -r '(.labels // []) | join(",")' <<<"${iss}")
              ms_title=$(jq -r '.milestone.title // empty' <<<"${iss}")
              author=$(jq -r '.author.username // "unknown"' <<<"${iss}")
              iid=$(jq -r '.iid' <<<"${iss}")
              confidential=$(jq -r '.confidential' <<<"${iss}")
              gl_url="${GL_URL%/}/${{ matrix.project }}/-/issues/${iid}"
              gh_body="**Imported from GitLab by @${author}**\n\n${body}\n\n---\n_Source_: ${gl_url}"

              # milestone number lookup from map
              ms_num=$(jq -r --arg t "${ms_title}" --argjson map "${MS_MAP}" 'if ($t|length)>0 and ($map[$t]) then $map[$t] else empty end')

              # Create the issue via gh api (allows milestone number) [3](https://cli.github.com/manual/gh_api)[4](https://docs.github.com/en/rest/issues)
              CREATE=$(gh api --method POST "repos/${GH_OWNER}/${GH_REPO}/issues" \
                         -f title="${title}" -f body="${gh_body}" \
                         ${labels:+-f labels="${labels},imported:gitlab"} ${ms_num:+-F milestone:=${ms_num}} \
                         --jq '.number')
              num="${CREATE:-}"

              # Comments (notes) — user comments only
              if [[ -n "${num}" ]]; then
                cpage=1
                while true; do
                  CRESP=$(mktemp); CHDR=$(mktemp)
                  curl -s -D "${CHDR}" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                    "${GL_API}/projects/${GL_ENC}/issues/${iid}/notes?activity_filter=only_comments&per_page=100&page=${cpage}" > "${CRESP}"
                  [[ "$(jq -r 'type' "${CRESP}")" == "array" ]] || break
                  jq -c '.[]' "${CRESP}" | while read -r note; do
                    nbody=$(jq -r '.body' <<<"${note}")
                    nauth=$(jq -r '.author.username // "unknown"' <<<"${note}")
                    gh issue comment "${num}" --repo "${GH_OWNER}/${GH_REPO}" --body "**@${nauth} (from GitLab)**\n\n${nbody}" || true
                    sleep 0.3
                  done
                  nnext=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${CHDR}" | tr -d '\r'); [[ -z "${nnext}" || "${nnext}" == "0" ]] && break
                  cpage="${nnext}"
                done

                # Close and/or mark confidential
                [[ "${state}" == "closed" ]] && gh api --method PATCH "repos/${GH_OWNER}/${GH_REPO}/issues/${num}" -f state="closed" >/dev/null || true
                [[ "${confidential}" == "true" ]] && gh issue edit "${num}" --repo "${GH_OWNER}/${GH_REPO}" --add-label "confidential" || true
              fi
            done
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r'); [[ -z "${next}" || "${next}" == "0" ]] && break
            page="${next}"
          done
          # gh issue comment is the supported way to add comments. [5](https://cli.github.com/manual/gh_issue_comment)

  # 6b) Wiki sync (git-level mirror of .wiki.git)
  repo_migration_wiki_sync_all:
    name: "6b) Repo Migration · 1.7 Wiki Sync (ALL projects)"
    needs: [discover_projects, repo_migration_commit_sync_all]
    runs-on: ubuntu-latest
    strategy: { fail-fast: false, max-parallel: 6, matrix: { project: ${{ fromJson(needs.discover_projects.outputs.project_list) }} } }
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
      WORKDIR: /tmp/wiki-work
    steps:
      - name: Install git
        run: sudo apt-get update -y && sudo apt-get install -y git
      - name: Compute GH_REPO
        id: repo
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          echo "gh_repo=${PREF}${base}" >> "$GITHUB_OUTPUT"
      - name: Mirror GitLab wiki → GitHub wiki
        env:
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          mkdir -p "${WORKDIR}"; cd "${WORKDIR}"
          HOST="${GL_URL#*://}"
          SRC_WIKI_URL="https://oauth2:${GL_TOKEN}@${HOST}/${{ matrix.project }}.wiki.git"
          DEST_WIKI_URL="https://x-access-token:${GH_PAT}@github.com/${GH_OWNER}/${GH_REPO}.wiki.git"
          if ! git ls-remote "${SRC_WIKI_URL}" &>/dev/null; then echo "No GL wiki — skip"; exit 0; fi
          git clone --mirror "${SRC_WIKI_URL}" src.wiki.git
          cd src.wiki.git
          git remote add github "${DEST_WIKI_URL}"
          git push --mirror github
      # GitLab & GitHub wikis are independent git repos (*.wiki.git). [11](https://docs.gitlab.com/user/project/wiki/)[12](https://docs.github.com/en/communities/documenting-your-project-with-wikis/about-wikis)

  # 7) GitLab CI → GitHub Actions (Importer stays the same)
  ci_migration_dry_run:
    name: "7) ${{ matrix.project }} · GitLab CI → Actions (dry-run)"
    needs: [discover_projects, repo_migration_commit_sync_all]
    runs-on: ubuntu-latest
    strategy: { fail-fast: false, max-parallel: 4, matrix: { project: ${{ fromJson(needs.discover_projects.outputs.project_list) }} } }
    env:
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
      GL_GROUP: ${{ vars.GL_GROUP }}
    steps:
      - name: Ensure GitHub CLI & Docker
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl gnupg docker.io || true
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
            sudo apt-get update -y && sudo apt-get install -y gh
          fi
          sudo systemctl enable --now docker || true
          gh --version
      - name: gh auth
        env: 
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "${GH_PAT}" | gh auth login --with-token --hostname github.com
          gh auth status
      - name: Install Actions Importer extension
        run: |
          gh extension list | grep -q '^github/gh-actions-importer' || gh extension install github/gh-actions-importer
          gh actions-importer update
      - name: Compute GH_REPO
        id: repo
        env: 
          GL_PROJECT: ${{ matrix.project }}
        run: |
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          echo "gh_repo=${PREF}${base}" >> "$GITHUB_OUTPUT"
      - name: Configure importer via .env.local
        run: |
          cat > .env.local <<EOF
          GITHUB_ACCESS_TOKEN=${GH_PAT}
          GITHUB_INSTANCE_URL=https://github.com
          GITLAB_ACCESS_TOKEN=${GL_TOKEN}
          GITLAB_INSTANCE_URL=${GL_URL}
          EOF
      - name: Dry-run conversion
        env: 
          GL_PROJECT: ${{ matrix.project }}
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
        run: |
          mkdir -p "tmp/dry-run/${GH_REPO}"
          gh actions-importer dry-run gitlab \
            --namespace "${GL_GROUP:-${GL_PROJECT%/*}}" \
            --project   "${GL_PROJECT##*/}" \
            --output-dir "tmp/dry-run/${GH_REPO}"
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: glci-to-actions-${{ steps.repo.outputs.gh_repo }}
          path: tmp/dry-run/${{ steps.repo.outputs.gh_repo }}/

  # 8) CI migration (migrate, open PR) — unchanged behavior
  ci_migration_migrate:
    name: "8) ${{ matrix.project }} · GitLab CI → Actions (migrate)"
    needs: [discover_projects, repo_migration_commit_sync_all]
    runs-on: ubuntu-latest
    strategy: { fail-fast: false, max-parallel: 3, matrix: { project: ${{ fromJson(needs.discover_projects.outputs.project_list) }} } }
    permissions: { contents: write, pull-requests: write }
    env:
      GH_PAT:   ${{ secrets.GH_PAT }}
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GL_URL:   ${{ vars.GL_URL }}
      GH_OWNER: ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
      GL_GROUP: ${{ vars.GL_GROUP }}
    steps:
      - name: Ensure gh & Docker
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl gnupg docker.io || true
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
            sudo apt-get update -y && sudo apt-get install -y gh
          fi
          sudo systemctl enable --now docker || true
      - name: gh auth
        env: 
          GH_PAT: ${{ secrets.GH_PAT }}
        run: echo "${GH_PAT}" | gh auth login --with-token --hostname github.com
      - name: Install/update Actions Importer
        run: |
          gh extension list | grep -q '^github/gh-actions-importer' || gh extension install github/gh-actions-importer
          gh actions-importer update
      - name: Compute GH_REPO
        id: repo
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          MODE="${REPO_NAME_MODE:-path}"; PREF="${GH_REPO_PREFIX:-}"; SEP="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "${MODE}" == "fullpath" ]]; then base="$(echo "${GL_PROJECT}"|tr '/' "${SEP}")"; else base="${GL_PROJECT##*/}"; fi
          echo "gh_repo=${PREF}${base}" >> "$GITHUB_OUTPUT"
      - name: Configure importer
        run: |
          cat > .env.local <<EOF
          GITHUB_ACCESS_TOKEN=${GH_PAT}
          GITHUB_INSTANCE_URL=https://github.com
          GITLAB_ACCESS_TOKEN=${GL_TOKEN}
          GITLAB_INSTANCE_URL=${GL_URL}
          EOF
      - name: Migrate pipeline (open PR, finish green)
        env: 
          GL_PROJECT: ${{ matrix.project }}
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
          GH_OWNER: ${{ env.GH_OWNER }} }
        run: |
          set -euo pipefail
          mkdir -p "tmp/migrate/${GH_REPO}"
          LOG="$(mktemp)"
          set +e
          gh actions-importer migrate gitlab \
            --target-url "https://github.com/${GH_OWNER}/${GH_REPO}" \
            --output-dir "tmp/migrate/${GH_REPO}" \
            --namespace "${GL_GROUP:-${GL_PROJECT%/*}}" \
            --project   "${GL_PROJECT##*/}" | tee "${LOG}"
          RC=${PIPESTATUS[0]}
          set -e
          PR_URL="$(grep -Eo 'https://github.com/.+/pull/[0-9]+' "${LOG}" | tail -n1 || true)"
          [[ -n "${PR_URL}" || "${RC}" -eq 0 ]] && exit 0 || { echo "Importer failed"; exit "${RC}"; }
