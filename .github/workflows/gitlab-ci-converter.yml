
name: "GitLab → GitHub: Containers & npm Packages (group-wide)"

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry-run (containers): print actions, do not copy"
        default: "false"
      migrate_npm:
        description: "Re-publish GitLab npm packages to GitHub Packages"
        default: "false"

permissions:
  contents: write
  packages: write

env:
  # ---- Common naming knobs ----
  REPO_NAME_MODE:    ${{ vars.REPO_NAME_MODE }}
  GH_REPO_PREFIX:    ${{ vars.GH_REPO_PREFIX }}
  GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR || '-' }}

  # ---- Container naming knobs ----
  CR_NAME_MODE:         ${{ vars.CR_NAME_MODE || 'path' }}
  GHCR_IMAGE_PREFIX:    ${{ vars.GHCR_IMAGE_PREFIX }}
  GHCR_IMAGE_SEPARATOR: ${{ vars.GHCR_IMAGE_SEPARATOR || '-' }}

  # ---- Endpoints / owners ----
  GL_URL:   ${{ vars.GL_URL }}
  GL_GROUP: ${{ vars.GL_GROUP }}
  GH_OWNER: ${{ vars.GH_OWNER }}

  # ---- Filters for containers ----
  CR_REPO_INCLUDE_REGEX: ${{ vars.CR_REPO_INCLUDE_REGEX || '.*' }}
  CR_REPO_EXCLUDE_REGEX: ${{ vars.CR_REPO_EXCLUDE_REGEX || '^$' }}
  CR_TAG_INCLUDE_REGEX:  ${{ vars.CR_TAG_INCLUDE_REGEX  || '.*' }}
  CR_TAG_EXCLUDE_REGEX:  ${{ vars.CR_TAG_EXCLUDE_REGEX  || '^$' }}

jobs:
  discover_projects:
    name: "1) Discover GitLab projects (incl. subgroups)"
    runs-on: ubuntu-latest
    outputs:
      project_list: ${{ steps.collect.outputs.project_list }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
    steps:
      - name: Install jq & curl
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl
      - name: Collect projects
        id: collect
        shell: bash
        run: |
          set -euo pipefail
          : "${GL_URL:?}"; : "${GL_GROUP:?}"
          GL_API="${GL_URL%/}/api/v4"
          GROUP_ENC=$(jq -rn --arg x "${GL_GROUP}" '$x|@uri')
          page=1; ary=()
          while true; do
            RESP=$(mktemp); HDR=$(mktemp)
            curl -s -D "$HDR" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/groups/${GROUP_ENC}/projects?per_page=100&page=${page}&include_subgroups=true" > "$RESP"
            jq -r '.[].path_with_namespace' "$RESP" | while read -r p; do
              # skip deletion-scheduled patterns if you use them
              [[ "$p" == deletion_scheduled-* || "$p" == *deletion_scheduled-* ]] && continue
              ary+=("$p")
            done
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "$next" || "$next" == "0" ]] && break
            page="$next"
          done
          printf '%s\n' "${ary[@]}" | jq -R . | jq -s -c . | sed 's/^/project_list=/' >> "$GITHUB_OUTPUT"

  mirror_containers:
    name: "2) Mirror Container Registry → GHCR (ALL)"
    needs: discover_projects
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      DRY_RUN:  ${{ github.event.inputs.dry_run }}
    steps:
      - name: Install skopeo & jq
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y skopeo jq curl
      - name: Enumerate repos & tags, then copy with skopeo
        env:
          GL_PROJECT: ${{ matrix.project }}
        shell: bash
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "${GL_PROJECT}" '$x|@uri')

          # compute dest image base
          if [[ "${CR_NAME_MODE}" == "fullpath" ]]; then
            base="$(echo "${GL_PROJECT}" | tr '/' "${GHCR_IMAGE_SEPARATOR}")"
          else
            base="${GL_PROJECT##*/}"
          fi
          IMG_BASE="${GHCR_IMAGE_PREFIX}${base}"

          host="${GL_URL#*://}"
          include_repo="${CR_REPO_INCLUDE_REGEX}"
          exclude_repo="${CR_REPO_EXCLUDE_REGEX}"
          include_tag="${CR_TAG_INCLUDE_REGEX}"
          exclude_tag="${CR_TAG_EXCLUDE_REGEX}"

          # list registry repositories with tags
          page=1
          while true; do
            RESP=$(mktemp); HDR=$(mktemp)
            curl -s -D "$HDR" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/registry/repositories?tags=1&tags_count=true&per_page=100&page=${page}" > "$RESP"
            jq -c '.[]' "$RESP" | while read -r repo; do
              path=$(jq -r '.path' <<<"$repo")     # e.g. group/project or group/project/image
              tags=$(jq -r '.tags[].name' <<<"$repo" 2>/dev/null || true)

              [[ -z "$path" ]] && continue
              if ! [[ "$path" =~ $include_repo ]]; then
                echo "::notice::Skip repo '$path' (does not match include)"; continue
              fi
              if [[ "$path" =~ $exclude_repo ]]; then
                echo "::notice::Skip repo '$path' (matches exclude)"; continue
              fi

              # derive final image name
              if [[ "${CR_NAME_MODE}" == "fullpath" ]]; then
                IMAGE_NAME="${IMG_BASE}"
              else
                # keep subpath if present
                sub="${path#${GL_PROJECT}}"; sub="${sub#/}"
                if [[ -n "$sub" ]]; then
                  IMAGE_NAME="${IMG_BASE}${GHCR_IMAGE_SEPARATOR}${sub//\//${GHCR_IMAGE_SEPARATOR}}"
                else
                  IMAGE_NAME="${IMG_BASE}"
                fi
              fi

              for tag in $tags; do
                if ! [[ "$tag" =~ $include_tag ]]; then
                  echo "::notice::Skip tag '$tag' (does not match include)"; continue
                fi
                if [[ "$tag" =~ $exclude_tag ]]; then
                  echo "::notice::Skip tag '$tag' (matches exclude)"; continue
                fi

                SRC="docker://${host}/${path}:${tag}"
                DST="docker://ghcr.io/${GH_OWNER}/${IMAGE_NAME}:${tag}"
                echo "Mirror: ${SRC}  →  ${DST}"
                [[ "${DRY_RUN}" == "true" ]] && continue

                # skopeo copy: GitLab with PAT; GHCR with GITHUB_TOKEN
                skopeo copy \
                  --src-creds "oauth2:${GL_TOKEN}" \
                  --dest-creds "${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}" \
                  "${SRC}" "${DST}"
              done
            done
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "$next" || "$next" == "0" ]] && break
            page="$next"
          done

  npm_manifest:
    name: "3) Build npm package manifest (per project)"
    if: ${{ github.event.inputs.migrate_npm == 'true' }}
    needs: discover_projects
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
    steps:
      - name: Install jq & curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
      - name: List npm packages & files
        id: list
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC=$(jq -rn --arg x "${GL_PROJECT}" '$x|@uri')
          out="npm-${GL_PROJECT//\//_}.json"
          all="[]"; page=1
          while true; do
            RESP=$(mktemp); HDR=$(mktemp)
            curl -s -D "$HDR" -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
              "${GL_API}/projects/${GL_ENC}/packages?package_type=npm&per_page=100&page=${page}" > "$RESP"
            jq -c '.[]' "$RESP" | while read -r p; do
              pid=$(jq -r '.id' <<<"$p")
              files=$(curl -s -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                "${GL_API}/projects/${GL_ENC}/packages/${pid}/package_files?per_page=100" || echo "[]")
              all=$(jq -c --argjson one "$(jq -c --argjson f "${files}" '. + {files:$f}' <<<"$p")" '. + [ $one ]' <<<"$all")
            done
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "$next" || "$next" == "0" ]] && break
            page="$next"
          done
          echo "${all}" | jq -S . > "${out}"
          echo "out=${out}" >> "$GITHUB_OUTPUT"
      - uses: actions/upload-artifact@v4
        with:
          name: npm-manifest
          path: ${{ steps.list.outputs.out }}
          compression-level: 6

  npm_republish:
    name: "4) Re-publish npm to GitHub Packages"
    if: ${{ github.event.inputs.migrate_npm == 'true' }}
    needs: [npm_manifest]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: npm-manifest
          path: manifest
      - name: Setup Node + tools
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com/'
      - name: Install jq & curl
        run: sudo apt-get update -y && sudo apt-get install -y jq curl
      - name: Publish all npm tarballs to GitHub Packages
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          echo "//npm.pkg.github.com/:_authToken=${TOKEN}" > ~/.npmrc
          shopt -s nullglob
          for f in manifest/*.json; do
            jq -c '.[]' "$f" | while read -r p; do
              pid=$(jq -r '.id' <<<"$p")
              files=$(jq -c '.files // []' <<<"$p")
              # pick first .tgz
              tid=$(jq -r '.[] | select(.file_name|endswith(".tgz")) | .id' <<<"$files" | head -n1)
              tname=$(jq -r '.[] | select(.id=='"${tid}"') | .file_name' <<<"$files")
              [[ -z "$tid" || -z "$tname" ]] && continue

              # attempt package_files download (UI route then API route)
              proj_enc=$(jq -rn --arg x "$(jq -r '._links.web_path' <<<"$p" | sed 's#/-.*/packages.*##')" '$x')
              urlA="${GL_URL%/}/${proj_enc}/-/package_files/${tid}/download"
              urlB="${GL_URL%/}/api/v4/projects/$(jq -rn --arg x "${proj_enc#/}" '$x|@uri')/packages/${pid}/package_files/${tid}/download"
              curl -fLsS -H "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" -o "${tname}" "${urlA}" || \
              curl -fLsS -H "PRIVATE-TOKEN: ${{ secrets.GITLAB_TOKEN }}" -o "${tname}" "${urlB}"

              test -s "${tname}" || { echo "::warning::Failed to download ${tname}"; continue; }
              npm publish "${tname}" --registry=https://npm.pkg.github.com/
              echo "Published ${tname}"
            done
          done
