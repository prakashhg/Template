
name: Packages (GitLab → GitHub) · Group-wide mirror

on:
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

env:
  # ---- Required context (same style as your repo migration workflow) ----
  GL_URL: ${{ vars.GL_URL }}                  # e.g., https://gitlab.example.com
  GL_GROUP: ${{ vars.GL_GROUP }}              # e.g., my-group/subgroup
  GH_OWNER: ${{ vars.GH_OWNER }}              # e.g., my-org
  # Preserve structure: turn "group/subgroup/proj[/path]" into "prefix + group-sep-subgroup-sep-proj[-sep-path]"
  GHCR_REPO_PREFIX: ${{ vars.GHCR_REPO_PREFIX }}      # optional, e.g., "" or "gl-"
  GHCR_REPO_SEPARATOR: ${{ vars.GHCR_REPO_SEPARATOR }} # default "-" if empty
  # Optional filters for mirroring containers
  INCLUDE_REGEX: ${{ vars.INCLUDE_REGEX }}    # e.g., ".*"
  EXCLUDE_REGEX: ${{ vars.EXCLUDE_REGEX }}    # e.g., "^$"

jobs:
  # 1) Discover GitLab container repositories across the GL_GROUP (includes subgroups)
  discover_container_repos:
    name: "1) Discover GitLab Container Registry repos (group-wide)"
    runs-on: ubuntu-latest
    outputs:
      repo_list: ${{ steps.collect.outputs.repo_list }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}   # needs read_registry + api
    steps:
      - name: Install jq & curl
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl

      - name: Collect GitLab container repos (with optional tags count)
        id: collect
        shell: bash
        run: |
          set -euo pipefail
          : "${GL_URL:?GL_URL required}"; : "${GL_GROUP:?GL_GROUP required}"
          GL_API="${GL_URL%/}/api/v4"
          # Encode group path safely
          GROUP_ENC=$(jq -rn --arg x "$GL_GROUP" '$x|@uri')

          page=1
          acc=()
          while :; do
            RESP=$(mktemp); HDR=$(mktemp)
            # Group-level registry listing includes subgroups; tags_count=1 helps priority decisions
            curl -sS -H "PRIVATE-TOKEN: ${GL_TOKEN}" -D "$HDR" \
              "${GL_API}/groups/${GROUP_ENC}/registry/repositories?per_page=100&page=${page}&tags_count=true" >"$RESP" \
              || { echo "ERROR: GitLab Container Registry API failed"; head -c 300 "$RESP" || true; exit 1; }

            # Each item has .path (group/project[/extra]), .location (registry host path), .project_id, etc.
            while read -r row; do
              acc+=("$row")
            done < <(jq -c '.[]' "$RESP")

            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "${next:-}" || "${next}" == "0" ]] && break
            page="$next"
          done

          # Optional filtering by INCLUDE/EXCLUDE regex
          inc="${INCLUDE_REGEX:-.*}"; exc="${EXCLUDE_REGEX:-^$}"
          json=$(printf '%s\n' "${acc[@]:-}" | jq -c 'select(. != null)' | jq -s -c --arg inc "$inc" --arg exc "$exc" '
            [ .[]
              | select(.path|test($inc))
              | select((.path|test($exc))|not)
            ]')

          echo "repo_list=${json}" >> "$GITHUB_OUTPUT"

  # 2) Mirror all tags for every discovered container repo to GHCR (no deletions)
  mirror_containers_all:
    name: "2) Mirror containers to GHCR (ALL repos/tags)"
    needs: discover_container_repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        repo: ${{ fromJson(needs.discover_container_repos.outputs.repo_list) }}
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }} # read_registry
      GH_PAT:   ${{ secrets.GH_PAT }}       # classic PAT: write:packages + read:packages
    steps:
      - name: Install skopeo + gh + jq
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl skopeo
          if ! command -v gh >/dev/null 2>&1; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
            | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
              | sudo tee /etc/apt/sources.list.d/github-cli.list >/dev/null
            sudo apt-get update -y && sudo apt-get install -y gh
          fi
          gh --version

      - name: Authenticate to GitHub CLI & GHCR
        run: |
          set -euo pipefail
          echo "${GH_PAT}" | gh auth login --with-token --hostname github.com
          echo "${GH_PAT}" | skopeo login ghcr.io -u "${GH_OWNER}" --password-stdin
        env:
          GH_OWNER: ${{ env.GH_OWNER }}

      - name: Authenticate to GitLab Container Registry
        shell: bash
        run: |
          set -euo pipefail
          # For GitLab registry, user can be your GL username or any string; PAT must include read_registry
          # Exact hostname used by container registry equals GL_URL host (often same host, possibly +port)
          host="${GL_URL#*://}"
          echo "${GL_TOKEN}" | skopeo login "${host}" -u oauth2 --password-stdin
        env:
          GL_URL: ${{ env.GL_URL }}

      - name: Compute source and destination refs (preserve structure)
        id: refs
        shell: bash
        env:
          GHCR_REPO_PREFIX: ${{ env.GHCR_REPO_PREFIX }}
          GHCR_REPO_SEPARATOR: ${{ env.GHCR_REPO_SEPARATOR }}
          GH_OWNER: ${{ env.GH_OWNER }}
        run: |
          set -euo pipefail
          src_path=$(jq -r '.path' <<< '${{ toJson(matrix.repo) }}')          # e.g., group/proj[/path]
          host="${GL_URL#*://}"
          src="docker://${host}/${src_path}"                                   # repo scope (no tag)
          sep="${GHCR_REPO_SEPARATOR:-"-"}"
          pref="${GHCR_REPO_PREFIX:-""}"
          # Turn "group/subgroup/proj/path" -> "pref + group-sep-subgroup-sep-proj-sep-path"
          base=$(echo -n "${src_path}" | tr '/' "${sep}")
          dest="docker://ghcr.io/${GH_OWNER}/${pref}${base}"
          echo "src=${src}"   >> "$GITHUB_OUTPUT"
          echo "dest=${dest}" >> "$GITHUB_OUTPUT"

      - name: Mirror ALL tags & multi-arch manifests with skopeo (no deletes)
        shell: bash
        run: |
          set -euo pipefail
          src="${{ steps.refs.outputs.src }}"
          dest="${{ steps.refs.outputs.dest }}"
          echo "Copying: ${src}  -->  ${dest}"
          # Sync the repository scope (copies all tags). `--all` preserves multi-arch manifest lists.
          # If the registry implementation requires explicit tags, you can loop over tags; for GitLab & GHCR
          # skopeo sync of the repo scope works well.
          skopeo sync --src docker --dest docker --all "${src}" "${dest%/*}"
          echo "Mirror completed for ${src}"
        # About skopeo copy/sync & --all: copy OCI images (including manifest lists) between registries. 
        # (Docs: containers/skopeo + man page)  ← (citations below)

      - name: Verify on GitHub via gh api (package metadata)
        shell: bash
        run: |
          set -euo pipefail
          # List (up to 100) container packages in the org and print the ones matching our new repo name
          base=$(jq -r '.path' <<< '${{ toJson(matrix.repo) }}' | tr '/' "${GHCR_REPO_SEPARATOR:-"-"}")
          candidate="${GHCR_REPO_PREFIX:-""}${base}"
          echo "::group::GH Packages that look like ${candidate}"
          gh api -H "Accept: application/vnd.github+json" \
            "/orgs/${GH_OWNER}/packages?package_type=container&per_page=100" \
            | jq -r --arg name "$candidate" '.[] | select(.name|test($name)) | {name, package_type, visibility}'
          echo "::endgroup::"
        env:
          GH_OWNER: ${{ env.GH_OWNER }}

  # 3) (Optional) Report non-container packages discovered via GitLab Packages API (npm, Maven, NuGet, PyPI, ...)
  discover_non_container_packages:
    name: "3) Report non-container packages present in GitLab Packages API"
    runs-on: ubuntu-latest
    needs: discover_container_repos
    env:
      GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      GL_URL: ${{ env.GL_URL }}
      GL_GROUP: ${{ env.GL_GROUP }}
    steps:
      - name: Install jq & curl
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
      - name: List group packages (excluding container registry)
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          GROUP_ENC=$(jq -rn --arg x "$GL_GROUP" '$x|@uri')
          page=1; acc=()
          while :; do
            RESP=$(mktemp); HDR=$(mktemp)
            curl -sS -H "PRIVATE-TOKEN: ${GL_TOKEN}" -D "$HDR" \
              "${GL_API}/groups/${GROUP_ENC}/packages?per_page=100&page=${page}" > "$RESP"
            while read -r row; do acc+=("$row"); done < <(jq -c '.[]' "$RESP")
            next=$(awk -F': ' '/^X-Next-Page:/ {print $2}' "$HDR" | tr -d '\r')
            [[ -z "${next:-}" || "${next}" == "0" ]] && break
            page="$next"
          done
          printf '%s\n' "${acc[@]:-}" | jq -s '
            [ .[]
              | select(.package_type != "container") # Packages API covers maven/npm/pypi/nuget/etc.
              | {id, name, version, package_type, project_id}
            ]' > non_container_packages.json
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: gitlab-non-container-packages
          path: non_container_packages.json
          if-no-files-found: warn
