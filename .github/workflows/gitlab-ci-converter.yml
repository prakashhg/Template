# 1.6) GitLab CI → GitHub Actions (dry-run preview)
  ci_migration_dry_run:
    name: "1.6) ${{ matrix.project }} · GitLab CI → Actions (dry-run)"
    needs: [discover_projects, repo_migration_commit_sync]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        project: ${{ fromJson(needs.discover_projects.outputs.project_list) }}
    env:
      GH_PAT:             ${{ secrets.GH_PAT }}
      GL_TOKEN:           ${{ secrets.GITLAB_TOKEN }}
      GL_URL:             ${{ vars.GL_URL }}
      GH_OWNER:           ${{ vars.GH_OWNER }}
      REPO_NAME_MODE:     ${{ vars.REPO_NAME_MODE }}
      GH_REPO_PREFIX:     ${{ vars.GH_REPO_PREFIX }}
      GH_REPO_SEPARATOR:  ${{ vars.GH_REPO_SEPARATOR }}
      GL_GROUP:           ${{ vars.GL_GROUP }}
    steps:
      - name: Install GitHub CLI & Importer extension
        run: |
          set -euo pipefail
          gh --version || (sudo apt-get update -y && sudo apt-get install -y gh)
          gh extension install github/gh-actions-importer || gh extension upgrade github/gh-actions-importer
          gh actions-importer update

      - name: Compute destination repo name
        id: repo
        shell: bash
        env:
          GL_PROJECT: ${{ matrix.project }}
        run: |
          set -euo pipefail
          REPO_NAME_MODE="${REPO_NAME_MODE:-path}"
          GH_REPO_PREFIX="${GH_REPO_PREFIX:-}"
          GH_REPO_SEPARATOR="${GH_REPO_SEPARATOR:-"-"}"
          if [[ "$REPO_NAME_MODE" == "fullpath" ]]; then
            base="$(echo "$GL_PROJECT" | tr '/' "$GH_REPO_SEPARATOR")"
          else
            base="${GL_PROJECT##*/}"
          fi
          GH_REPO="${GH_REPO_PREFIX}${base}"
          echo "gh_repo=$GH_REPO" >> "$GITHUB_OUTPUT"

      - name: Configure importer via .env.local (non-interactive)
        run: |
          set -euo pipefail
          cat > .env.local <<EOF
          GITHUB_ACCESS_TOKEN=${GH_PAT}
          GITHUB_INSTANCE_URL=https://github.com
          GITLAB_ACCESS_TOKEN=${GL_TOKEN}
          GITLAB_INSTANCE_URL=${GL_URL}
          EOF

      - name: Dry-run conversion (writes YAML to output dir)
        shell: bash
        env:
          GL_PROJECT: ${{ matrix.project }}
          GH_REPO:    ${{ steps.repo.outputs.gh_repo }}
        run: |
          set -euo pipefail
          mkdir -p "tmp/dry-run/${GH_REPO}"
          gh actions-importer dry-run gitlab \
            --namespace "${GL_GROUP:-${GL_PROJECT%/*}}" \
            --project  "${GL_PROJECT##*/}" \
            --output-dir "tmp/dry-run/${GH_REPO}"
          echo "Converted workflow files are in tmp/dry-run/${GH_REPO}"

      - name: Upload converted workflow as artifact
        uses: actions/upload-artifact@v4
        with:
          name: glci-to-actions-${{ steps.repo.outputs.gh_repo }}
          path: tmp/dry-run/${{ steps.repo.outputs.gh_repo }}
          retention-days: 7
