
name: "Migrate one GitLab project â†’ GHCR (with summary links)"

on:
  workflow_dispatch:
    inputs:
      gl_project:
        description: "GitLab project path (e.g., group/subgroup/project)"
        required: true
        type: string

permissions:
  contents: read
  packages: write

env:
  # Required (set as Repository â†’ Variables)
  GL_URL: ${{ vars.GL_URL }}        # e.g. https://gitlab.com
  GH_OWNER: ${{ vars.GH_OWNER }}    # GitHub user/org that will own GHCR images
  # Optional
  GH_REPO_PREFIX: ${{ vars.GH_REPO_PREFIX }}
  GH_REPO_SEPARATOR: ${{ vars.GH_REPO_SEPARATOR }}
  REPO_NAME_MODE: ${{ vars.REPO_NAME_MODE }}  # "path" (default) or "fullpath"
  GL_REGISTRY: ${{ vars.GL_REGISTRY }}        # override if self-managed host differs
  GHCR_USER: ${{ vars.GHCR_USER }}            # PAT owner name; defaults to github.actor
  CURL_FLAGS: --http1.1 --retry 5 --retry-all-errors --connect-timeout 15 --max-time 120

jobs:
  migrate_containers:
    runs-on: ubuntu-latest
    env:
      GL_PROJECT: ${{ inputs.gl_project }}
    steps:
      - name: Install tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq curl skopeo

      - name: Resolve identities & registry hosts
        id: ids
        env:
          GL_URL: ${{ env.GL_URL }}
          GL_PROJECT: ${{ env.GL_PROJECT }}
          GL_REGISTRY: ${{ env.GL_REGISTRY }}
          CURL_FLAGS: ${{ env.CURL_FLAGS }}
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GHCR_USER: ${{ env.GHCR_USER }}
        run: |
          set -euo pipefail
          GL_API="${GL_URL%/}/api/v4"
          GL_ENC="$(jq -rn --arg x "${GL_PROJECT}" '$x|@uri')"

          # GH username (prefer override; else GitHub Actions actor)
          GH_USER="${GHCR_USER:-${GITHUB_ACTOR}}"

          # GitLab registry host
          host="${GL_URL#*://}"; host="${host##*@}"; host="${host%%/*}"
          if [[ -n "${GL_REGISTRY:-}" ]]; then
            GL_REG="${GL_REGISTRY}"
          else
            if [[ "${host}" == "gitlab.com" ]]; then
              GL_REG="registry.gitlab.com"
            else
              GL_REG="registry.${host}"
            fi
          fi

          # GitLab username for registry login (fallback to oauth2)
          GL_USER="$(curl -s ${CURL_FLAGS} \
                      -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                      -H "Accept: application/json" \
                      -H "Connection: close" \
                      "${GL_API}/user" | jq -r '.username // empty')"
          [[ -z "${GL_USER}" || "${GL_USER}" == "null" ]] && GL_USER="oauth2"

          {
            echo "gl_api=${GL_API}"
            echo "gl_enc=${GL_ENC}"
            echo "gl_reg=${GL_REG}"
            echo "gl_user=${GL_USER}"
            echo "gh_user=${GH_USER}"
          } >> "$GITHUB_OUTPUT"

      - name: Compute destination repo name
        id: repo
        env:
          GL_PROJECT: ${{ env.GL_PROJECT }}
          REPO_NAME_MODE: ${{ env.REPO_NAME_MODE }}
          GH_REPO_PREFIX: ${{ env.GH_REPO_PREFIX }}
          GH_REPO_SEPARATOR: ${{ env.GH_REPO_SEPARATOR }}
        run: |
          set -euo pipefail
          MODE="${REPO_NAME_MODE:-path}"
          SEP="${GH_REPO_SEPARATOR:--}"
          PREF="${GH_REPO_PREFIX:-}"
          if [[ "${MODE}" == "fullpath" ]]; then
            base="$(echo "${GL_PROJECT}" | tr '/' "${SEP}")"
          else
            base="${GL_PROJECT##*/}"
          fi
          echo "gh_repo=${PREF}${base}" >> "$GITHUB_OUTPUT"

      - name: ðŸ”Ž List GitLab container repositories & tags (debug)
        id: gl_list
        env:
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GL_API: ${{ steps.ids.outputs.gl_api }}
          GL_ENC: ${{ steps.ids.outputs.gl_enc }}
          CURL_FLAGS: ${{ env.CURL_FLAGS }}
        run: |
          set -euo pipefail
          page=1
          repos="[]"
          while :; do
            RESP="$(mktemp)"; HDR="$(mktemp)"
            HTTP=$(curl -sS ${CURL_FLAGS} \
                    -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                    -H "Accept: application/json" \
                    -H "Connection: close" \
                    -D "${HDR}" -w '%{http_code}' \
                    "${GL_API}/projects/${GL_ENC}/registry/repositories?per_page=100&page=${page}" \
                    -o "${RESP}") || true

            if [[ "${HTTP}" != "200" ]]; then
              echo "::notice::GitLab API returned HTTP ${HTTP} for registry listing."
              break
            fi

            [[ "$(jq -r 'type' "${RESP}")" == "array" ]] || break
            repos="$(jq -c --argjson acc "${repos}" --argjson cur "$(cat "${RESP}")" '($acc + $cur)')"

            next="$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')"
            [[ -z "${next:-}" || "${next}" == "0" ]] && break
            page="${next}"
          done

          echo "repos=${repos}" >> "$GITHUB_OUTPUT"

          count="$(jq 'length' <<< "${repos}")"
          echo "Found ${count} container repo(s) in GitLab project."
          echo "### GitLab Container Registry â€” discovered repositories" >> $GITHUB_STEP_SUMMARY
          if [[ "${count}" -eq 0 ]]; then
            echo "- **None found**. Verify images exist under *Deploy â†’ Container Registry* in the GitLab project." >> $GITHUB_STEP_SUMMARY
          else
            for i in $(seq 0 $((count-1))); do
              path="$(jq -r ".[$i].path" <<< "${repos}")"
              echo "- \`${path}\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

      - name: Exit early if no GitLab registries found
        if: ${{ steps.gl_list.outputs.repos == '[]' }}
        run: |
          echo "::notice::No container repositories found in the GitLab project; nothing to migrate."
          echo "Visit GitLab â†’ Deploy â†’ Container Registry to confirm images/tags exist." >> $GITHUB_STEP_SUMMARY
          exit 0

      - name: Login to GitLab & GHCR registries
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          GH_USER: ${{ steps.ids.outputs.gh_user }}
          GL_USER: ${{ steps.ids.outputs.gl_user }}
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GL_REG: ${{ steps.ids.outputs.gl_reg }}
        run: |
          set -euo pipefail
          echo "${GH_PAT}" | skopeo login ghcr.io --username "${GH_USER}" --password-stdin
          # Try common GitLab registry usernames:
          echo "${GL_TOKEN}" | skopeo login "${GL_REG}" --username "${GL_USER}" --password-stdin || \
          echo "${GL_TOKEN}" | skopeo login "${GL_REG}" --username "oauth2" --password-stdin || \
          echo "${GL_TOKEN}" | skopeo login "${GL_REG}" --username "gitlab-ci-token" --password-stdin || \
          echo "::warning::Login to ${GL_REG} failed; pulls may fail."

      - name: Copy all GitLab tags â†’ GHCR (and capture links)
        id: copy
        env:
          REPOS: ${{ steps.gl_list.outputs.repos }}
          GL_URL: ${{ env.GL_URL }}
          GL_REG: ${{ steps.ids.outputs.gl_reg }}
          GL_ENC: ${{ steps.ids.outputs.gl_enc }}
          GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GH_OWNER: ${{ env.GH_OWNER }}
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
          GL_PROJECT: ${{ env.GL_PROJECT }}
          CURL_FLAGS: ${{ env.CURL_FLAGS }}
        run: |
          set -euo pipefail
          touched=()  # array of ghcr package names under $GH_OWNER

          count="$(jq 'length' <<< "${REPOS}")"
          echo "Processing ${count} container repo(s)..."

          for i in $(seq 0 $((count-1))); do
            obj="$(jq -c ".[$i]" <<< "${REPOS}")"
            # Location/Path as returned by GitLab API
            loc="$(jq -r '.location // empty' <<< "${obj}")"
            path="$(jq -r '.path // empty' <<< "${obj}")"

            if [[ -n "${loc}" ]]; then
              src_domain="${loc%%/*}"
              src_path="${loc#*/}"
            elif [[ -n "${path}" ]]; then
              src_domain="${GL_REG}"
              src_path="${path}"
            else
              echo "::warning::Skipping repo with no location/path: ${obj}"
              continue
            fi

            repo_id="$(jq -r '.id' <<< "${obj}")"
            # List tags for this repository
            tags="[]"; page=1
            while :; do
              RESP="$(mktemp)"; HDR="$(mktemp)"
              URL="${GL_URL%/}/api/v4/projects/${GL_ENC}/registry/repositories/${repo_id}/tags?per_page=100&page=${page}"
              if ! curl --fail-with-body -s ${CURL_FLAGS} \
                   -H "PRIVATE-TOKEN: ${GL_TOKEN}" \
                   -H "Accept: application/json" \
                   -H "Connection: close" \
                   -D "${HDR}" "${URL}" > "${RESP}"; then
                echo "::warning::Failed to list tags for repo_id=${repo_id}; skipping."
                break
              fi
              [[ "$(jq -r 'type' "${RESP}")" == "array" ]] || break
              tags="$(jq -c --argjson acc "${tags}" --argjson cur "$(cat "${RESP}")" '($acc + $cur)')"

              next="$(awk -F': ' '/^X-Next-Page:/ {print $2}' "${HDR}" | tr -d '\r')"
              [[ -z "${next:-}" || "${next}" == "0" ]] && break
              page="${next}"
            done

            tcount="$(jq 'length' <<< "${tags}")"
            if [[ "${tcount}" -eq 0 ]]; then
              echo "::notice::No tags found for ${src_domain}/${src_path}; skipping."
              continue
            fi

            # Preserve subpath beyond project root in destination
            suffix="${src_path#${GL_PROJECT}}"
            if [[ "${suffix}" == "${src_path}" ]]; then
              proj_name="${GL_PROJECT##*/}"
              suffix="/${src_path#*${proj_name}}"
            fi
            suffix="${suffix#/}"

            dest_path="${GH_OWNER}/${GH_REPO}"
            [[ -n "${suffix}" ]] && dest_path="${dest_path}/${suffix}"

            echo "â†’ ${src_domain}/${src_path}  ==>  ghcr.io/${dest_path}  (${tcount} tag(s))"

            while IFS= read -r tag; do
              SRC="docker://${src_domain}/${src_path}:${tag}"
              DEST="docker://ghcr.io/${dest_path}:${tag}"
              if skopeo copy --all "${SRC}" "${DEST}"; then
                pkg_name="${dest_path#${GH_OWNER}/}"   # everything after owner
                touched+=("${pkg_name}")
              else
                echo "::warning::Copy failed: ${SRC} -> ${DEST}"
              fi
            done < <(jq -r '.[].name' <<< "${tags}")
          done

          # Deduplicate & export
          if ((${#touched[@]})); then
            printf '%s\n' "${touched[@]}" | sort -u | jq -R . | jq -s -c . | sed 's/^/pkg_names=/' >> "$GITHUB_OUTPUT"
          else
            echo "pkg_names=[]" >> "$GITHUB_OUTPUT"
          fi

      - name: ðŸ§¾ Summary with GHCR links
        if: always()
        env:
          GH_OWNER: ${{ env.GH_OWNER }}
          GH_REPO: ${{ steps.repo.outputs.gh_repo }}
          PKG_NAMES: ${{ steps.copy.outputs.pkg_names }}
        run: |
          set -euo pipefail
          echo "### GHCR Migration Summary" >> $GITHUB_STEP_SUMMARY
          if [[ -z "${PKG_NAMES:-}" || "${PKG_NAMES}" == "[]" ]]; then
            echo "- No tags were copied. If this is unexpected, confirm images exist in GitLab (Deploy â†’ Container Registry)." >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Owner packages page**: https://github.com/${GH_OWNER}?tab=packages" >> $GITHUB_STEP_SUMMARY
            echo "- **Destination repo**: https://github.com/${GH_OWNER}/${GH_REPO}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Packages copied (under \`ghcr.io/${GH_OWNER}/â€¦\`):**" >> $GITHUB_STEP_SUMMARY
            mapfile -t names < <(jq -r '.[]' <<< "${PKG_NAMES}")
            for n in "${names[@]}"; do
              # We link to owner packages (always valid); GitHub also shows the package under the repo's Packages panel when linked. 
              echo "- \`${n}\` â†’ ghcr.io/${GH_OWNER}/${n}" >> $GITHUB_STEP_SUMMARY
            done
          fi
