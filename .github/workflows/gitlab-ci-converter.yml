
name: Setup GitHub Actions Importer (REST-only, no gh/no Docker)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  # Secrets & Vars (your requested names)
  GL_TOKEN: ${{ secrets.GITLAB_TOKEN }}
  GH_PAT:   ${{ secrets.GH_PAT }}

  VAR_GL_URL:       ${{ vars.GL_URL }}
  VAR_GL_PROJECT:   ${{ vars.GL_PROJECT }}
  VAR_GH_OWNER:     ${{ vars.GH_OWNER }}
  VAR_GH_REPO:      ${{ vars.GH_REPO }}
  VAR_AUTO_CREATE:  ${{ vars.AUTO_CREATE_REPO }}
  VAR_DELETE_FIRST: ${{ vars.DELETE_DEST_REPO_FIRST }}
  VAR_MIGRATE_MRS:  ${{ vars.MIGRATE_MRS }}

jobs:
  prepare:
    name: "0) Prepare · Verify repo, clone & upload source"
    runs-on: ubuntu-latest
    outputs:
      default_branch: ${{ steps.check_repo.outputs.default_branch }}
    steps:
      - name: Install tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y git curl jq

      - name: Export & normalize inputs
        id: export
        shell: bash
        run: |
          set -euo pipefail
          norm_bool() {
            case "$(echo "${1:-}" | tr '[:upper:]' '[:lower:]')" in
              true|1|yes|y) echo "true" ;;
              false|0|no|n|"") echo "false" ;;
              *) echo "false" ;;
            esac
          }
          AUTO_CREATE="$(norm_bool "${VAR_AUTO_CREATE:-false}")"
          DELETE_FIRST="$(norm_bool "${VAR_DELETE_FIRST:-false}")"
          MIGRATE_MRS="$(norm_bool "${VAR_MIGRATE_MRS:-false}")"
          missing=()
          [[ -z "${VAR_GH_OWNER:-}" ]] && missing+=("VAR_GH_OWNER")
          [[ -z "${VAR_GH_REPO:-}"  ]] && missing+=("VAR_GH_REPO")
          [[ -z "${GH_PAT:-}"       ]] && missing+=("GH_PAT secret (repo+workflow scopes)")
          if [[ "${#missing[@]}" -gt 0 ]]; then
            echo "❌ Missing inputs: ${missing[*]}"; exit 1
          fi
          {
            echo "gl_url=${VAR_GL_URL}"
            echo "gl_project=${VAR_GL_PROJECT}"
            echo "gh_owner=${VAR_GH_OWNER}"
            echo "gh_repo=${VAR_GH_REPO}"
            echo "auto_create=${AUTO_CREATE}"
            echo "delete_first=${DELETE_FIRST}"
            echo "migrate_mrs=${MIGRATE_MRS}"
          } >> "$GITHUB_OUTPUT"

      - name: Verify repo via GitHub REST API
        id: check_repo
        shell: bash
        run: |
          set -euo pipefail
          REPO_API="https://api.github.com/repos/${VAR_GH_OWNER}/${VAR_GH_REPO}"
          RESP="$(curl -s \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${REPO_API}")"
          if echo "${RESP}" | jq -e '.message | select(.=="Not Found")' >/dev/null; then
            echo "❌ Repo not found: ${VAR_GH_OWNER}/${VAR_GH_REPO}"
            exit 1
          fi
          DEFAULT_BRANCH="$(echo "${RESP}" | jq -r '.default_branch')"
          [[ -n "${DEFAULT_BRANCH}" && "${DEFAULT_BRANCH}" != "null" ]] || DEFAULT_BRANCH="main"
          echo "default_branch=${DEFAULT_BRANCH}" >> "$GITHUB_OUTPUT"
          echo "✅ Repo exists. Default branch: ${DEFAULT_BRANCH}"
          # Docs: GET /repos/{owner}/{repo} – default_branch

      - name: Clone repo via GH_PAT
        shell: bash
        run: |
          set -euo pipefail
          WORKDIR="$(mktemp -d)"
          echo "WORKDIR=${WORKDIR}" >> "$GITHUB_ENV"
          REPO_URL="https://${GH_PAT}@github.com/${VAR_GH_OWNER}/${VAR_GH_REPO}.git"
          git clone "${REPO_URL}" "${WORKDIR}/repo"
          cd "${WORKDIR}/repo"
          git checkout "${{ steps.check_repo.outputs.default_branch }}"
          echo "✅ Repo cloned to ${WORKDIR}/repo"

      - name: Detect .gitlab-ci.yml
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          SRC="${WORKDIR}/repo/.gitlab-ci.yml"
          if [[ -f "${SRC}" ]]; then
            echo "gitlab_ci_path=${SRC}" >> "$GITHUB_OUTPUT"
            echo "✅ Found .gitlab-ci.yml"
          else
            echo "ℹ️ No .gitlab-ci.yml found; exiting workflow."
            exit 0
          fi

      - name: Upload source artifact (.gitlab-ci.yml)
        uses: actions/upload-artifact@v4
        with:
          name: gitlab-ci-source
          path: ${{ steps.detect.outputs.gitlab_ci_path }}

  convert:
    name: "1) Convert · Reusable converter workflow"
    runs-on: ubuntu-latest
    needs: [prepare]
    # Call the reusable workflow (job-level 'uses')
    uses: ./.github/workflows/gitlab-ci-converter.yml
    with:
      source_artifact_name: gitlab-ci-source
    secrets:
      GH_PAT: ${{ secrets.GH_PAT }}

  publish:
    name: "2) Publish · Commit, push & open PR (REST)"
    runs-on: ubuntu-latest
    needs: [prepare, convert]
    outputs:
      pr_url: ${{ steps.open_pr.outputs.pr_url }}
    steps:
      - name: Install tools
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y git curl jq

      - name: Download converted workflow artifact
        uses: actions/download-artifact@v4
        with:
          name: converted-workflow
          path: converted_out

      - name: Clone repo again
        shell: bash
        run: |
          set -euo pipefail
          WORKDIR="$(mktemp -d)"
          echo "WORKDIR=${WORKDIR}" >> "$GITHUB_ENV"
          REPO_URL="https://${GH_PAT}@github.com/${VAR_GH_OWNER}/${VAR_GH_REPO}.git"
          git clone "${REPO_URL}" "${WORKDIR}/repo"
          cd "${WORKDIR}/repo"
          git checkout "${{ needs.prepare.outputs.default_branch }}"

      - name: Stage converted workflow into repo
        shell: bash
        run: |
          set -euo pipefail
          cd "${WORKDIR}/repo"
          mkdir -p .github/workflows
          mv "${GITHUB_WORKSPACE}/converted_out/gitlab-pipeline-converted.yml" \
             ".github/workflows/gitlab-pipeline-converted.yml"
          ls -la .github/workflows

      - name: Commit & push branch
        shell: bash
        run: |
          set -euo pipefail
          cd "${WORKDIR}/repo"
          BRANCH="ci-migration-$(date +%s)"
          git config user.name "actions-bot"
          git config user.email "actions@users.noreply.github.com"
          git checkout -b "${BRANCH}"
          git add .github/workflows/gitlab-pipeline-converted.yml
          git commit -m "Add converted GitHub Actions workflow from .gitlab-ci.yml (best-effort)"
          git push "https://${GH_PAT}@github.com/${VAR_GH_OWNER}/${VAR_GH_REPO}.git" "${BRANCH}"
          echo "BRANCH=${BRANCH}" >> "$GITHUB_ENV"
          echo "✅ Pushed branch ${BRANCH}"

      - name: Open PR via GitHub REST API
        id: open_pr
        shell: bash
        run: |
          set -euo pipefail
          BASE="${{ needs.prepare.outputs.default_branch }}"
          HEAD="${BRANCH}"
          API="https://api.github.com/repos/${VAR_GH_OWNER}/${VAR_GH_REPO}/pulls"

          DATA=$(jq -n \
            --arg title "Convert .gitlab-ci.yml to GitHub Actions (best-effort)" \
            --arg head  "${HEAD}" \
            --arg base  "${BASE}" \
            --arg body  "This PR adds a best-effort converted workflow from .gitlab-ci.yml.\n\n**Manual follow-up:**\n- Map rules/only/except to \`on:\`\n- Map services to service containers\n- Add \`actions/cache\` where needed\n- Validate with actionlint\n\nDocs:\n- Get repo & default branch: https://docs.github.com/en/rest/repos/repos#get-a-repository\n- Create PR: https://docs.github.com/en/rest/pulls/pulls#create-a-pull-request" \
            '{title:$title, head:$head, base:$base, body:$body}')

          RESP="$(curl -s -X POST \
            -H "Authorization: Bearer ${GH_PAT}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            "${API}" -d "${DATA}")"

          PR_URL="$(echo "${RESP}" | jq -r '.html_url // empty')"
          if [[ -z "${PR_URL}" ]]; then
            echo "❌ Failed to create PR. Response            echo "❌ Failed to create PR. Response:"
            echo "${RESP}"
            exit 1
          fi

          echo "pr_url=${PR_URL}" >> "$GITHUB_OUTPUT"
